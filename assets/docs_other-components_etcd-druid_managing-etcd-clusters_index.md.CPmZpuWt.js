import{_ as i,c as e,o as a,a2 as t}from"./chunks/framework.Bfq10Vlj.js";const k=JSON.parse('{"title":"Managing Etcd Clusters","description":"","frontmatter":{"github_repo":"https://github.com/gardener/etcd-druid","github_subdir":"docs/usage","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/other-components/etcd-druid/managing-etcd-clusters.md","to":"managing-etcd-clusters.md"},"persona":"Users","title":"Managing Etcd Clusters","prev":false,"next":false},"headers":[],"relativePath":"docs/other-components/etcd-druid/managing-etcd-clusters/index.md","filePath":"docs/other-components/etcd-druid/managing-etcd-clusters.md","lastUpdated":null}'),n={name:"docs/other-components/etcd-druid/managing-etcd-clusters/index.md"};function l(h,s,r,o,d,c){return a(),e("div",null,s[0]||(s[0]=[t(`<h1 id="managing-etcd-clusters" tabindex="-1">Managing ETCD Clusters <a class="header-anchor" href="#managing-etcd-clusters" aria-label="Permalink to &quot;Managing ETCD Clusters&quot;">​</a></h1><h2 id="create-an-etcd-cluster" tabindex="-1">Create an Etcd Cluster <a class="header-anchor" href="#create-an-etcd-cluster" aria-label="Permalink to &quot;Create an Etcd Cluster&quot;">​</a></h2><p>Creating an <code>Etcd</code> cluster can be done either by explicitly creating a manifest file or it can also be done programmatically. You can refer to and/or modify any <a href="https://github.com/gardener/etcd-druid/tree/master/examples" target="_blank" rel="noreferrer">sample</a> <code>Etcd</code> manifest to create an etcd cluster. In order to programmatically create an <code>Etcd</code> cluster you can refer to the <code>Golang</code> <a href="https://github.com/gardener/etcd-druid/tree/master/api" target="_blank" rel="noreferrer">API</a> to create an <code>Etcd</code> custom resource and using a <a href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/client#Client" target="_blank" rel="noreferrer">k8s client</a> you can apply an instance of a <code>Etcd</code> custom resource targetting any namespace in a k8s cluster.</p><p>Prior to <code>v0.23.0</code> version of etcd-druid, after creating an <code>Etcd</code> custom resource, you will have to annotate the resource with <code>gardener.cloud/operation=reconcile</code> in order to trigger a reconciliation for the newly created <code>Etcd</code> resource. Post <code>v0.23.0</code> version of etcd-druid, there is no longer any need to explicitly trigger reconciliations for creating new <code>Etcd</code> clusters.</p><h3 id="track-etcd-cluster-creation" tabindex="-1">Track etcd cluster creation <a class="header-anchor" href="#track-etcd-cluster-creation" aria-label="Permalink to &quot;Track etcd cluster creation&quot;">​</a></h3><p>In order to track the progress of creation of etcd cluster resources you can do the following:</p><ul><li><p><code>status.lastOperation</code> can be monitored to check the status of reconciliation.</p></li><li><p>Additional printer columns have been defined for <code>Etcd</code> custom resource. You can execute the following command to know if an <code>Etcd</code> cluster is ready/quorate.</p></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> etcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -owide</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # you will see additional columns which will indicate the state of an etcd cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   QUORATE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ALL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> MEMBERS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   BACKUP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    CLUSTER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SIZE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   CURRENT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICAS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> REPLICAS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  etcd-main</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   true</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    True</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      True</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                True</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           235d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                  3</span></span></code></pre></div><ul><li><p>You can additional monitor <a href="/docs/other-components/etcd-druid/concepts/etcd-cluster-components/">all etcd cluster resources</a> that are created for every etcd cluster.</p><p>For etcd-druid version &lt;v0.23.0 use the following command:</p></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all,cm,role,rolebinding,lease,sa</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --selector=instance=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">etcd-name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>For etcd-druid version &gt;=v0.23.0 use the following command:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all,cm,role,rolebinding,lease,sa</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --selector=app.kubernetes.io/managed-by=etcd-druid,app.kubernetes.io/part-of=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">etcd-name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><h2 id="update-reconcile-an-etcd-cluster" tabindex="-1">Update &amp; Reconcile an Etcd Cluster <a class="header-anchor" href="#update-reconcile-an-etcd-cluster" aria-label="Permalink to &quot;Update &amp; Reconcile an Etcd Cluster&quot;">​</a></h2><h3 id="edit-the-etcd-custom-resource" tabindex="-1">Edit the Etcd custom resource <a class="header-anchor" href="#edit-the-etcd-custom-resource" aria-label="Permalink to &quot;Edit the Etcd custom resource&quot;">​</a></h3><p>To update an etcd cluster, you should usually <em>only</em> be updating the <code>Etcd</code> custom resource representing the etcd cluster. You can make changes to the existing <code>Etcd</code> resource by invoking the following command:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> edit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> etcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>This will open up the linked editor where you can make the edits.</p><h3 id="scale-the-etcd-cluster-horizontally" tabindex="-1">Scale the Etcd cluster horizontally <a class="header-anchor" href="#scale-the-etcd-cluster-horizontally" aria-label="Permalink to &quot;Scale the Etcd cluster horizontally&quot;">​</a></h3><p>To scale an etcd cluster horizontally, you can update the <code>spec.replicas</code> field in the <code>Etcd</code> custom resource. For example, to scale an etcd cluster to 5 replicas, you can run:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> patch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> etcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> merge</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{&quot;spec&quot;:{&quot;replicas&quot;:5}}&#39;</span></span></code></pre></div><p>Alternatively, you can use the <code>/scale</code> subresource to scale an etcd cluster horizontally. For example, to scale an etcd cluster to 5 replicas, you can run:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scale</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> etcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --replicas=5</span></span></code></pre></div><p>!!! note While an Etcd cluster can be scaled out, it cannot be scaled in, i.e., the replicas cannot be decreased to a non-zero value. An Etcd cluster can still be scaled to 0 replicas, indicating that the cluster is to be &quot;hibernated&quot;. This is beneficial for use-cases where an etcd cluster is not needed for a certain period of time, and the user does not want to pay for the compute resources. A hibernated etcd cluster can be resumed later by scaling it back to a non-zero value. Please note that the data volumes backing an Etcd cluster will be retained during hibernation, and will still be charged for.</p><h3 id="scale-the-etcd-cluster-vertically" tabindex="-1">Scale the Etcd cluster vertically <a class="header-anchor" href="#scale-the-etcd-cluster-vertically" aria-label="Permalink to &quot;Scale the Etcd cluster vertically&quot;">​</a></h3><p>To scale an Etcd cluster vertically, you can update the <code>spec.etcd.resources</code> and <code>spec.backup.resources</code> fields in the <code>Etcd</code> custom resource. For example, to scale an Etcd cluster&#39;s <code>etcd</code> container to 2 CPU and 4Gi memory, you can run:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> patch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> etcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> merge</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{&quot;spec&quot;:{&quot;etcd&quot;:{&quot;resources&quot;:{&quot;requests&quot;:{&quot;cpu&quot;:&quot;2&quot;,&quot;memory&quot;:&quot;4Gi&quot;}}}}}&#39;</span></span></code></pre></div><p>Additionally, you can use an external pod autoscaler such as <a href="https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler" target="_blank" rel="noreferrer">vertical pod autoscaler</a> to scale an Etcd cluster vertically. This is made possible by the <code>/scale</code> subresource on the Etcd custom resource.</p><p>!!! note Scaling an Etcd cluster vertically can potentially result in downtime, based on its failure tolerance. This is due to the fact that an etcd cluster is actuated by pods, and the pods need to be restarted in order to apply the new resource values. A multi-member etcd cluster can tolerate a failure of one member, but if the number of replicas is set to 1, then the etcd cluster will not be able to tolerate any failures. Therefore, it is recommended to scale a single-member etcd cluster vertically only when it is deemed necessary, and to monitor the cluster closely during the scaling process. A multi-member Etcd cluster can be scaled vertically, one member at a time. A pod disruption budget for this can ensure that the cluster can tolerate a certain number of failures. This pod disruption budget is automatically deployed and managed by etcd-druid for multi-member Etcd clusters, and it is recommended to not modify this PDB manually.</p><p>!!! note While the replicas and resources in an Etcd resource spec can be modified, please ensure to read the next section to understand when and how these changes are reconciled by etcd-druid.</p><h3 id="reconcile" tabindex="-1">Reconcile <a class="header-anchor" href="#reconcile" aria-label="Permalink to &quot;Reconcile&quot;">​</a></h3><p>There are two ways to control reconciliation of any changes done to <code>Etcd</code> custom resources.</p><h4 id="auto-reconciliation" tabindex="-1">Auto reconciliation <a class="header-anchor" href="#auto-reconciliation" aria-label="Permalink to &quot;Auto reconciliation&quot;">​</a></h4><p>If <code>etcd-druid</code> has been deployed with auto-reconciliation then any change done to an <code>Etcd</code> resource will be automatically reconciled. You use <code>--enable-etcd-spec-auto-reconcile</code> CLI flag to enable auto-reconciliation of the etcd spec.</p><blockquote><p>For a complete list of CLI args you can see <a href="/docs/other-components/etcd-druid/deployment/configure-etcd-druid/">this</a> document.</p></blockquote><h4 id="explicit-reconciliation" tabindex="-1">Explicit reconciliation <a class="header-anchor" href="#explicit-reconciliation" aria-label="Permalink to &quot;Explicit reconciliation&quot;">​</a></h4><p>If <code>--enable-etcd-spec-auto-reconcile</code> is set to false or not set at all, then any change to an <code>Etcd</code> resource will not be automatically reconciled. To trigger a reconcile you must set the following annotation on the <code>Etcd</code> resource:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> etcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gardener.cloud/operation=reconcile</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>This option is sometimes recommeded as you would like avoid auto-reconciliation of accidental changes to <code>Etcd</code> resources outside the maintenance time window, thus preventing a potential transient quorum loss due to misconfiguration, attach-detach issues of persistent volumes etc.</p><h2 id="overwrite-container-oci-images" tabindex="-1">Overwrite Container OCI Images <a class="header-anchor" href="#overwrite-container-oci-images" aria-label="Permalink to &quot;Overwrite Container OCI Images&quot;">​</a></h2><p>To find out image versions of <code>etcd-backup-restore</code> and <code>etcd-wrapper</code> used by a specific version of <code>etcd-druid</code> one way is look for the image versions in <a href="https://github.com/gardener/etcd-druid/blob/master/internal/images/images.yaml" target="_blank" rel="noreferrer">images.yaml</a>. There are times that you might wish to override these images that come bundled with <code>etcd-druid</code>. There are two ways in which you can do that:</p><p><strong>Option #1</strong> We leverage <a href="/docs/gardener/deployment/image_vector/#overwriting-image-vector">Overwrite ImageVector</a> facility provided by <a href="https://github.com/gardener/gardener/" target="_blank" rel="noreferrer">gardener</a>. This capability can be used without bringing in gardener as well. To illustrate this in context of <code>etcd-druid</code> you will create a <code>ConfigMap</code> with the following content:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ConfigMap</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-druid-images-overwrite</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;etcd-druid-namespace&gt;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  images_overwrite.yaml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    images:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    - name: etcd-backup-restore</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      sourceRepository: github.com/gardener/etcd-backup-restore</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      repository: &lt;your-own-custom-etcd-backup-restore-repo-url&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      tag: &quot;v&lt;custom-tag&gt;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    - name: etcd-wrapper</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      sourceRepository: github.com/gardener/etcd-wrapper</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      repository: &lt;your-own-custom-etcd-wrapper-repo-url&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      tag: &quot;v&lt;custom-tag&gt;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    - name: alpine</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      repository: &lt;your-own-custom-alpine-repo-url&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      tag: &quot;v&lt;custom-tag&gt;&quot;</span></span></code></pre></div><p>You can use <a href="https://github.com/gardener/etcd-druid/blob/master/internal/images/images.yaml" target="_blank" rel="noreferrer">images.yaml</a> as a reference to create the overwrite images YAML <code>ConfigMap</code>.</p><p>Edit the <code>etcd-druid</code> <code>Deployment</code> with:</p><ul><li>Mount the <code>ConfigMap</code></li><li>Set <code>IMAGEVECTOR_OVERWRITE</code> environment variable whose value must be the path you choose to mount the <code>ConfigMap</code>.</li></ul><p>To illustrate the changes you can see the following <code>etcd-druid</code> Deployment YAML:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-druid</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;etcd-druid-namespace&gt;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-druid</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        env</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">IMAGEVECTOR_OVERWRITE</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/imagevector-overwrite/images_overwrite.yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        volumeMounts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-druid-images-overwrite</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          mountPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/imagevector-overwrite</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-druid-images-overwrite</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        configMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-druid-images-overwrite</span></span></code></pre></div><p>!!! info Image overwrites specified in the mounted <code>ConfigMap</code> will be respected by successive reconciliations for this <code>Etcd</code> custom resource.</p><p><strong>Option #2</strong></p><p>We provide a generic way to suspend etcd cluster reconciliation via etcd-druid, allowing a human operator to take control. This option should be excercised only in case of troubleshooting or quick fixes which are not possible to do via the reconciliation loop in etcd-druid. However one of the use cases to use this option is to perhaps update the container image to apply a hot patch and speed up recovery of an etcd cluster.</p><h2 id="manually-modify-individual-etcd-cluster-resources" tabindex="-1">Manually modify individual etcd cluster resources <a class="header-anchor" href="#manually-modify-individual-etcd-cluster-resources" aria-label="Permalink to &quot;Manually modify individual etcd cluster resources&quot;">​</a></h2><p><code>etcd</code> cluster resources are managed by <code>etcd-druid</code> and since v0.23.0 version of <code>etcd-druid</code> any changes to these managed resources are protected via a validating webhook. You can find more information about this webhook <a href="/docs/other-components/etcd-druid/concepts/etcd-cluster-resource-protection/">here</a>. To be able to manually modify etcd cluster managed resources two things needs to be done:</p><ol><li>Annotate the target <code>Etcd</code> resource suspending any reconciliation by <code>etcd-druid</code>. You can do this by invoking the following command:</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> etcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> druid.gardener.cloud/suspend-etcd-spec-reconcile=</span></span></code></pre></div><ol start="2"><li>Add another annotation to the target <code>Etcd</code> resource disabling managed resource protection via the webhook. You can do this by invoking the following command:</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> etcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">etcd-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> druid.gardener.cloud/disable-etcd-component-protection=</span></span></code></pre></div><p>Now you are free to make changes to any managed etcd cluster resource.</p><p>!!! note As long as the above two annotations are there, no reconciliation will be done for this etcd cluster by <code>etcd-druid</code>. Therefore it is essential that you remove this annotations eventually.</p>`,58)]))}const g=i(n,[["render",l]]);export{k as __pageData,g as default};

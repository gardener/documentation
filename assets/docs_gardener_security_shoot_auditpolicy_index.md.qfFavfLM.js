import{_ as i,c as t,o as a,a2 as s}from"./chunks/framework.Bfq10Vlj.js";const u=JSON.parse('{"title":"Audit a Kubernetes Cluster","description":"How to define a custom audit policy through a `ConfigMap` and reference it in the shoot spec","frontmatter":{"aliases":["/docs/gardener/shoot_auditpolicy/"],"description":"How to define a custom audit policy through a `ConfigMap` and reference it in the shoot spec","github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/usage/security","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/security/shoot_auditpolicy.md","to":"shoot_auditpolicy.md"},"persona":"Users","title":"Audit a Kubernetes Cluster","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/security/shoot_auditpolicy/index.md","filePath":"docs/gardener/security/shoot_auditpolicy.md","lastUpdated":null}'),o={name:"docs/gardener/security/shoot_auditpolicy/index.md"};function n(l,e,r,d,h,p){return a(),t("div",null,e[0]||(e[0]=[s(`<h1 id="audit-a-kubernetes-cluster" tabindex="-1">Audit a Kubernetes Cluster <a class="header-anchor" href="#audit-a-kubernetes-cluster" aria-label="Permalink to &quot;Audit a Kubernetes Cluster&quot;">​</a></h1><p>The shoot cluster is a Kubernetes cluster and its <code>kube-apiserver</code> handles the audit events. In order to define which audit events must be logged, a proper audit policy file must be passed to the Kubernetes API server. You could find more information about auditing a kubernetes cluster in the <a href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/" target="_blank" rel="noreferrer">Auditing</a> topic.</p><h2 id="default-audit-policy" tabindex="-1">Default Audit Policy <a class="header-anchor" href="#default-audit-policy" aria-label="Permalink to &quot;Default Audit Policy&quot;">​</a></h2><p>By default, the Gardener will deploy the shoot cluster with audit policy defined in the <a href="https://github.com/gardener/gardener/blob/master/pkg/component/kubernetes/apiserver/secrets.go" target="_blank" rel="noreferrer">kube-apiserver package</a>.</p><h2 id="custom-audit-policy" tabindex="-1">Custom Audit Policy <a class="header-anchor" href="#custom-audit-policy" aria-label="Permalink to &quot;Custom Audit Policy&quot;">​</a></h2><p>If you need specific audit policy for your shoot cluster, then you could deploy the required audit policy in the garden cluster as <code>ConfigMap</code> resource and set up your shoot to refer this <code>ConfigMap</code>. Note that the policy must be stored under the key <code>policy</code> in the data section of the <code>ConfigMap</code>.</p><p>For example, deploy the auditpolicy <code>ConfigMap</code> in the same namespace as your <code>Shoot</code> resource:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example/95-configmap-custom-audit-policy.yaml</span></span></code></pre></div><p>then set your shoot to refer that <code>ConfigMap</code> (only related fields are shown):</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  kubernetes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    kubeAPIServer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      auditConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        auditPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          configMapRef</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">auditpolicy</span></span></code></pre></div><p>Gardener validate the <code>Shoot</code> resource to refer only existing <code>ConfigMap</code> containing valid audit policy, and rejects the <code>Shoot</code> on failure. If you want to switch back to the default audit policy, you have to remove the section</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">auditPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  configMapRef</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;configmap-name&gt;</span></span></code></pre></div><p>from the shoot spec.</p><h2 id="rolling-out-changes-to-the-audit-policy" tabindex="-1">Rolling Out Changes to the Audit Policy <a class="header-anchor" href="#rolling-out-changes-to-the-audit-policy" aria-label="Permalink to &quot;Rolling Out Changes to the Audit Policy&quot;">​</a></h2><p>Gardener is not automatically rolling out changes to the Audit Policy to minimize the amount of Shoot reconciliations in order to prevent cloud provider rate limits, etc. Gardener will pick up the changes on the next reconciliation of Shoots referencing the Audit Policy ConfigMap. If users want to immediately rollout Audit Policy changes, they can manually trigger a Shoot reconciliation as described in <a href="/docs/gardener/shoot-operations/shoot_operations/#immediate-reconciliation">triggering an immediate reconciliation</a>. This is similar to changes to the cloud provider secret referenced by Shoots.</p>`,15)]))}const g=i(o,[["render",n]]);export{u as __pageData,g as default};

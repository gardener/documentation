import{_ as t,c as a,o as s,a2 as i}from"./chunks/framework.Bfq10Vlj.js";const u=JSON.parse('{"title":"Disaster Recovery Garden","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/operations","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/disaster_recovery_garden.md","to":"disaster_recovery_garden.md"},"persona":"Operators","title":"Disaster Recovery Garden","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/disaster_recovery_garden/index.md","filePath":"docs/gardener/disaster_recovery_garden.md","lastUpdated":null}'),r={name:"docs/gardener/disaster_recovery_garden/index.md"};function o(n,e,c,d,l,p){return s(),a("div",null,e[0]||(e[0]=[i(`<h1 id="disaster-recovery-restoring-a-garden-cluster-to-a-new-runtime-cluster-üõ†Ô∏è" tabindex="-1">Disaster Recovery: Restoring a Garden Cluster to a new Runtime Cluster üõ†Ô∏è <a class="header-anchor" href="#disaster-recovery-restoring-a-garden-cluster-to-a-new-runtime-cluster-üõ†Ô∏è" aria-label="Permalink to &quot;Disaster Recovery: Restoring a Garden Cluster to a new Runtime Cluster üõ†Ô∏è&quot;">‚Äã</a></h1><p>This documentation outlines the procedure for restoring a <strong>Garden cluster</strong> into a new runtime cluster. The primary goal is to minimize the impact on stakeholders and other components, particularly by preventing the invalidation of credentials issued before the restore.</p><h2 id="disclaimer" tabindex="-1">Disclaimer <a class="header-anchor" href="#disclaimer" aria-label="Permalink to &quot;Disclaimer&quot;">‚Äã</a></h2><div class="important custom-block github-alert"><p class="custom-block-title">IMPORTANT</p><p>The restoration process described here assumes that no other actors (like <code>gardener-operator</code>, <code>etcd-druid</code>, DNS controller, etc.) which also existed in the previous runtime cluster are active anymore. It is crucial to ensure that these components are scaled down or disabled, for example by invalidating their credentials to avoid conflicts.</p></div><h2 id="table-of-contents" tabindex="-1">Table of Contents <a class="header-anchor" href="#table-of-contents" aria-label="Permalink to &quot;Table of Contents&quot;">‚Äã</a></h2><ul><li><a href="/docs/gardener/disaster_recovery_garden/#required-backup-components-building-blocks">Required Backup Components (Building Blocks)</a></li><li><a href="/docs/gardener/disaster_recovery_garden/#restoration-procedure">Restoration Procedure</a></li><li><a href="/docs/gardener/disaster_recovery_garden/#additional-information-and-considerations">Additional Information and Considerations</a></li><li><a href="/docs/gardener/disaster_recovery_garden/#testing-locally">Testing Locally</a></li></ul><h2 id="required-backup-components-building-blocks" tabindex="-1">Required Backup Components (Building Blocks) <a class="header-anchor" href="#required-backup-components-building-blocks" aria-label="Permalink to &quot;Required Backup Components (Building Blocks)&quot;">‚Äã</a></h2><p>The restoration process requires specific building blocks ‚Äî like <code>etcd</code> backup, credentials and configuration components ‚Äî to be supplied, which necessitates their continuous backup. The following sections provides details for these components.</p><h3 id="etcd-backup" tabindex="-1">ETCD backup <a class="header-anchor" href="#etcd-backup" aria-label="Permalink to &quot;ETCD backup&quot;">‚Äã</a></h3><p>The Garden cluster&#39;s ETCD is managed by <code>etcd-druid</code>, which can take care of performing continuous backups. This can be configured in the <code>Garden</code> resource and is strongly recommended for any setup.</p><div class="important custom-block github-alert"><p class="custom-block-title">IMPORTANT</p><p>Without ETCD backups, a restore is not possible.</p></div><p>Reference:</p><ul><li><a href="/docs/gardener/concepts/backup-restore/">Backup and Restore Concept</a></li><li><a href="/docs/gardener/concepts/operator/#etcd">Garden ETCD</a></li><li><a href="https://github.com/gardener/gardener/blob/1f9458b6eb73a8d1f489f003403e16d01bd014a9/example/operator/20-garden.yaml#L86-L93" target="_blank" rel="noreferrer">Example Backup Configuration</a></li></ul><h3 id="garden-resource" tabindex="-1"><code>Garden</code> Resource <a class="header-anchor" href="#garden-resource" aria-label="Permalink to &quot;\`Garden\` Resource&quot;">‚Äã</a></h3><p>The <code>Garden</code> resource should be backed up in its entirety including the <code>status</code> subresource. The <code>status</code> contains critical information like the current state of credentials rotation.</p><p>Failure to capture changes in the <code>status</code>, specifically for <code>.status.encryptedResources</code> and <code>.status.credentials</code> will lead to data loss. Finding a reasonable backup frequency depends on the frequency of changes applied to the <code>Garden</code> and operations triggered.</p><h3 id="runtime-data" tabindex="-1">Runtime Data <a class="header-anchor" href="#runtime-data" aria-label="Permalink to &quot;Runtime Data&quot;">‚Äã</a></h3><p>To ensure a successful and less-disruptive restore, the following data containing state information must be backed up from the runtime cluster. These are stored as <code>Secrets</code> in the <strong><code>garden</code> namespace</strong> and their names are typically suffixed by content hashes and, if triggered, a hash indicating recent rotation (e.g., <code>ca-f6032ea0-5e58a</code>).</p><p>Preserving the encryption keys is absolutely critical, while the other secrets are necessary to avoid invalidating existing credentials.</p><h4 id="_1-encryption-keys-and-configurations" tabindex="-1">1. Encryption Keys and Configurations <a class="header-anchor" href="#_1-encryption-keys-and-configurations" aria-label="Permalink to &quot;1. Encryption Keys and Configurations&quot;">‚Äã</a></h4><p>These exist separately for both the <code>kube-apiserver</code> and the <code>gardener-apiserver</code>. Without them, data stored in <code>etcd</code> cannot be decrypted, leading to complete data loss.</p><ul><li><code>kube-apiserver-etcd-encryption-key</code></li><li><code>kube-apiserver-etcd-encryption-configuration</code></li><li><code>gardener-apiserver-etcd-encryption-key</code></li><li><code>gardener-apiserver-etcd-encryption-configuration</code></li></ul><h4 id="_2-manually-rotated-certificate-authorities-cas" tabindex="-1">2. Manually-Rotated Certificate Authorities (CAs) <a class="header-anchor" href="#_2-manually-rotated-certificate-authorities-cas" aria-label="Permalink to &quot;2. Manually-Rotated Certificate Authorities (CAs)&quot;">‚Äã</a></h4><p>The following CAs must be preserved:</p><ul><li><code>ca</code></li><li><code>ca-front-proxy</code></li><li><code>ca-etcd</code></li><li><code>ca-etcd-peer</code></li><li><code>ca-gardener</code></li><li><code>ca-client</code></li></ul><h4 id="_3-signing-keys" tabindex="-1">3. Signing Keys <a class="header-anchor" href="#_3-signing-keys" aria-label="Permalink to &quot;3. Signing Keys&quot;">‚Äã</a></h4><ul><li><code>service-account-key</code></li><li><code>gardener-apiserver-workload-identity-signing-key</code></li></ul><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p>It is <strong>not</strong> necessary to store or restore secrets that have &quot;bundle&quot; in their name.</p></div><h3 id="infrastructure-credentials" tabindex="-1">Infrastructure Credentials <a class="header-anchor" href="#infrastructure-credentials" aria-label="Permalink to &quot;Infrastructure Credentials&quot;">‚Äã</a></h3><p>Typically, a <code>Garden</code> resources references infrastructure credentials for a DNS provider and the <code>etcd</code> backup bucket. For a restore to succeed, these credentials must be valid and available in the new runtime cluster.</p><hr><h2 id="restoration-procedure" tabindex="-1">Restoration Procedure <a class="header-anchor" href="#restoration-procedure" aria-label="Permalink to &quot;Restoration Procedure&quot;">‚Äã</a></h2><p>The following steps detail the restoration process.</p><h3 id="step-1-shut-down-actors-in-the-previous-runtime-cluster" tabindex="-1">Step 1: Shut down Actors in the previous Runtime Cluster <a class="header-anchor" href="#step-1-shut-down-actors-in-the-previous-runtime-cluster" aria-label="Permalink to &quot;Step 1: Shut down Actors in the previous Runtime Cluster&quot;">‚Äã</a></h3><p>To avoid any conflicts caused by actors still running in the previous runtime cluster, ensure that all relevant components are scaled down or disabled.</p><p>If it is still possible, scale down the following <code>Deployments</code> in the <code>garden</code> namespace:</p><ul><li><code>gardener-operator</code></li><li><code>etcd-druid</code></li><li><code>gardener-resource-manager</code></li><li><code>gardener-apiserver</code></li><li><code>virtual-garden-kube-apiserver</code></li></ul><p>If it is still possible, scale down the following <code>StatefulSets</code> in the <code>garden</code> namespace:</p><ul><li><code>virtual-garden-etcd-main</code></li><li><code>virtual-garden-etcd-events</code></li></ul><p>If it is still possible, scale down the following <code>Deployments</code> in the <code>runtime-extension-provider-&lt;infrastructure&gt;</code> namespace, where <code>&lt;infrastructure&gt;</code> is the provider extension used to manage the <code>DNSRecord</code> resource:</p><ul><li><code>gardener-extension-provider-&lt;infrastructure&gt;</code></li></ul><p>There might be a case, where scaling down is not possible anymore. In this case, ensure that the credentials used by these components are invalidated before continuity with the restore procedure.</p><p>Specifically, invalidate the credentials referenced in the <code>garden</code> resource at:</p><ul><li><code>.spec.dns.providers[].secretRef.name</code></li><li><code>.spec.virtualCluster.etcd.main.backup.secretRef.name</code></li></ul><p>This will ensure that these components cannot update external resources anymore.</p><h3 id="step-2-create-a-copy-of-etcd-backups" tabindex="-1">Step 2: Create a Copy of ETCD Backups <a class="header-anchor" href="#step-2-create-a-copy-of-etcd-backups" aria-label="Permalink to &quot;Step 2: Create a Copy of ETCD Backups&quot;">‚Äã</a></h3><p>In order to avoid data loss due to mistakes, it is strongly recommended to create a copy of the <code>etcd</code> backup. This ensures that the restore procedure can be tried again with a pristine <code>etcd</code> backup in case of failure.</p><h3 id="step-3-create-a-new-runtime-cluster" tabindex="-1">Step 3: Create a new Runtime Cluster <a class="header-anchor" href="#step-3-create-a-new-runtime-cluster" aria-label="Permalink to &quot;Step 3: Create a new Runtime Cluster&quot;">‚Äã</a></h3><p>Provision a new runtime cluster where the Garden cluster will be restored into.</p><h3 id="step-4-adjust-cidrs" tabindex="-1">Step 4: Adjust CIDRs <a class="header-anchor" href="#step-4-adjust-cidrs" aria-label="Permalink to &quot;Step 4: Adjust CIDRs&quot;">‚Äã</a></h3><p>In case the new runtime cluster has different CIDRs than the previous one, the <code>Garden</code> resource must be adjusted accordingly before applying it to the new cluster.</p><h3 id="step-5-deploy-the-gardener-operator" tabindex="-1">Step 5: Deploy the <code>gardener-operator</code> <a class="header-anchor" href="#step-5-deploy-the-gardener-operator" aria-label="Permalink to &quot;Step 5: Deploy the \`gardener-operator\`&quot;">‚Äã</a></h3><p>Deploy the <code>gardener-operator</code> into the new runtime cluster as described <a href="/docs/gardener/concepts/operator/#deployment">here</a>. Ensure that it is the same version as the one used in the previous cluster to avoid compatibility issues.</p><h3 id="step-6-apply-backed-up-resources" tabindex="-1">Step 6: Apply Backed-up Resources <a class="header-anchor" href="#step-6-apply-backed-up-resources" aria-label="Permalink to &quot;Step 6: Apply Backed-up Resources&quot;">‚Äã</a></h3><ol><li><strong>Scale Down <code>gardener-operator</code>:</strong> Scale down the <code>gardener-operator</code> deployment to prevent it from immediately reconciling a new <code>Garden</code> resource.</li><li><strong>Delete Webhooks:</strong> Delete the <a href="/docs/gardener/concepts/operator/#defaulting">mutating</a> and <a href="/docs/gardener/concepts/operator/#validation">validating</a> webhooks registered for the <code>Garden</code> resource to unblock later operations. Both webhooks are named <code>gardener-operator</code>. Once the operator is scaled up, it will recreate them.</li><li><strong>Deploy State Secrets:</strong> Deploy the correct backed-up secrets for CAs, encryption, and signing keys into the new cluster.</li><li><strong>Deploy Infrastructure Secrets:</strong> Deploy valid infrastructure credentials (e.g., for DNS and <code>etcd</code> backup) into the new cluster.</li><li><strong>Apply <code>Garden</code> Resource:</strong> Apply the backed-up <strong><code>Garden</code> resource</strong> to the new cluster.</li></ol><h3 id="step-7-configure-credential-rotation-status" tabindex="-1">Step 7: Configure Credential Rotation Status <a class="header-anchor" href="#step-7-configure-credential-rotation-status" aria-label="Permalink to &quot;Step 7: Configure Credential Rotation Status&quot;">‚Äã</a></h3><p>This step is critical for <code>Garden</code> resources where credential rotation was in the <strong><code>Prepared</code></strong> phase. This ensures the <code>gardener-operator</code> takes the correct code path and can complete the rotation later.</p><p>Patch the <strong>status subresource</strong> of the garden resource with content similar to the snippet below, reflecting the last completed rotation steps.</p><p>Patching can be done with <code>kubectl edit garden &lt;garden-name&gt; --subresource=status</code> or by applying a yaml file with <code>kubectl apply -f &lt;file&gt; --subresource=status</code>.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">observedGeneration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">credentials</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rotation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    certificateAuthorities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      lastInitiationFinishedTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-06-27T10:43:01Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      lastInitiationTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-06-27T10:39:57Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      phase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Prepared</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Must be set if rotation was in Prepared phase</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    etcdEncryptionKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      lastInitiationFinishedTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-06-27T10:43:01Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      lastInitiationTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-06-27T10:39:57Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      phase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Prepared</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Must be set if rotation was in Prepared phase</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    observability</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      lastCompletionTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-06-27T10:43:01Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      lastInitiationTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-06-27T10:39:57Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    serviceAccountKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      lastInitiationFinishedTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-06-27T10:43:01Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      lastInitiationTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-06-27T10:39:57Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      phase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Prepared</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Must be set if rotation was in Prepared phase</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    workloadIdentityKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      lastInitiationFinishedTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-06-27T10:43:01Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      lastInitiationTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-06-27T10:39:57Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      phase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Prepared</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Must be set if rotation was in Prepared phase</span></span></code></pre></div><h3 id="step-8-configure-encrypted-resources" tabindex="-1">Step 8: Configure Encrypted Resources <a class="header-anchor" href="#step-8-configure-encrypted-resources" aria-label="Permalink to &quot;Step 8: Configure Encrypted Resources&quot;">‚Äã</a></h3><p>If the <code>Garden</code> specifies <strong>additional resources for encryption</strong> in the spec, this must be reflected in the status <strong>before the first reconciliation</strong>. Failure to do so will make the <code>gardener-operator</code> assume that these resources were not yet encrypted. As the consequence, it will attempt to encrypt them but the process will never finish, which will block the restore procedure.</p><p>Take the <code>.status.encryptedResources</code> section from the backed-up <code>Garden</code> resource and apply it.</p><p>In case the information is not present, it can be derived from the following fields in the spec: * <code>garden.spec.virtualCluster.kubernetes.kubeAPIServer.encryptionConfig.resources</code> * <code>garden.spec.virtualCluster.gardener.gardenerAPIServer.encryptionConfig.resources</code></p><p>Patching can be done with <code>kubectl edit garden &lt;garden-name&gt; --subresource=status</code> or by applying a yaml file with <code>kubectl apply -f &lt;file&gt; --subresource=status</code>.</p><h3 id="step-9-start-restoration" tabindex="-1">Step 9: Start Restoration <a class="header-anchor" href="#step-9-start-restoration" aria-label="Permalink to &quot;Step 9: Start Restoration&quot;">‚Äã</a></h3><p><strong>Scale up <code>gardener-operator</code>:</strong> Scale the <code>gardener-operator</code> deployment back up. It will now reconcile the <code>Garden</code> resource with the correct initial status.</p><h3 id="step-10-restoring-multi-member-etcd-clusters-ha-configuration" tabindex="-1">Step 10: Restoring multi-member ETCD clusters (HA configuration) <a class="header-anchor" href="#step-10-restoring-multi-member-etcd-clusters-ha-configuration" aria-label="Permalink to &quot;Step 10: Restoring multi-member ETCD clusters (HA configuration)&quot;">‚Äã</a></h3><ul><li>For a Garden running with an <strong>HA configuration</strong>, restoring <strong>the etcd cluster requires manual steps</strong>.</li><li>Follow the specific procedure documented in the <code>etcd-druid</code> repository: <ul><li><strong>Reference:</strong> <code>https://github.com/gardener/etcd-druid/blob/master/docs/usage/recovering-etcd-clusters.md</code></li></ul></li><li>Apply the steps to the <code>etcd-main</code> cluster.</li></ul><hr><h2 id="additional-information-and-considerations" tabindex="-1">Additional Information and Considerations <a class="header-anchor" href="#additional-information-and-considerations" aria-label="Permalink to &quot;Additional Information and Considerations&quot;">‚Äã</a></h2><h4 id="_1-restoring-from-credentials-rotation-phase-prepared" tabindex="-1">1. Restoring from Credentials Rotation Phase <code>Prepared</code> <a class="header-anchor" href="#_1-restoring-from-credentials-rotation-phase-prepared" aria-label="Permalink to &quot;1. Restoring from Credentials Rotation Phase \`Prepared\`&quot;">‚Äã</a></h4><p>When restoring from the <code>Prepared</code> phase, the secrets deployed in Step 1 will have two suffixes: the content hash and a second suffix indicating a non-empty <code>last-rotation-initiation-time</code> label.</p><h4 id="_2-restoring-from-credentials-rotation-phase-preparing" tabindex="-1">2. Restoring from Credentials Rotation Phase <code>Preparing</code> <a class="header-anchor" href="#_2-restoring-from-credentials-rotation-phase-preparing" aria-label="Permalink to &quot;2. Restoring from Credentials Rotation Phase \`Preparing\`&quot;">‚Äã</a></h4><p>If the cluster is being restored from the <code>Preparing</code> phase (meaning rotation was actively in progress but not yet completed), be extra careful. The encryption state of resources in <strong>etcd</strong> might require both the new and the old encryption keys to be available to the encryption configurations.</p><p>Whether this is the case or not depends on the time of the last successful backup of etcd data.</p><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p>There are always two encryption configurations: one for the <code>kube-apiserver</code> and one for the <code>gardener-apiserver</code>.</p></div><p>See <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/" target="_blank" rel="noreferrer">Encryption At Rest</a> for more details.</p><h4 id="_3-encryption-keys" tabindex="-1">3. Encryption Keys <a class="header-anchor" href="#_3-encryption-keys" aria-label="Permalink to &quot;3. Encryption Keys&quot;">‚Äã</a></h4><p>When performing a restore, ensure that the encryption keys and configurations deployed match the state that existed in the former runtime cluster. Mismatched keys or an incorrect rotation status can cause the <code>gardener-operator</code> to issue new encryption keys. This in turn will render existing data inaccessible. Depending on the conditions, it might also cause data in <code>etcd</code> to be encrypted with new keys, leading to permanent data loss.</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>Therefore, it is strongly recommended to create a copy of the etcd backups before starting the restore procedure. Having the ability to retry the restore procedure with a pristine etcd backup is crucial in case of mistakes.</p></div><h4 id="_4-using-a-copy-of-etcd-backups" tabindex="-1">4. Using a Copy of ETCD Backups <a class="header-anchor" href="#_4-using-a-copy-of-etcd-backups" aria-label="Permalink to &quot;4. Using a Copy of ETCD Backups&quot;">‚Äã</a></h4><p>In case the restore procedure fails due to misconfiguration or mistakes, having a copy of the etcd backups allows retrying the restore without data loss. To use the copy, &quot;simply&quot; replace the contents of the backup bucket with the copied data before starting the restore procedure again.</p><p>However, there might be cases where the <a href="/docs/gardener/immutable-backup-buckets/">backup bucket is configured with immutability</a>. Overwriting data in the existing bucket will not be possible in this case. Instead, a new bucket has to be created and referenced.</p><p>Firstly, create a new backup bucket in the storage provider used. Then, copy the contents of the preserved etcd backup copy into the new bucket. Finally, update the <code>Garden</code> resource to reference the new bucket at <code>.spec.virtualCluster.etcd.main.backup.bucketName</code> before applying it.</p><h2 id="testing-locally" tabindex="-1">Testing Locally <a class="header-anchor" href="#testing-locally" aria-label="Permalink to &quot;Testing Locally&quot;">‚Äã</a></h2><p>Disaster Recovery can be tested with the <a href="/docs/gardener/local_setup/">local development setup</a>. This may help to gain confidence before performing the procedure on production clusters.</p><h3 id="preparation" tabindex="-1">Preparation <a class="header-anchor" href="#preparation" aria-label="Permalink to &quot;Preparation&quot;">‚Äã</a></h3><p>For testing purposes, create a local <code>kind</code> cluster and deploy a Garden cluster into it by following the <a href="/docs/gardener/deployment/getting_started_locally/">Local Development Setup Guide</a>. The recommended way is to use the <code>gardener-operator</code> and its respective <code>make</code> targets. At the time of writing this, the following commands can be used:</p><div class="language-console vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">console</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">make kind-multi-zone-up operator-up operator-seed-up</span></span></code></pre></div><p>Once everything is up and running, create a couple of resources (<code>Project</code>, <code>Secret</code>, ...) in the virtual Garden cluster used to validate and restore procedure.</p><p>Depending on the testcases which should be covered, trigger a credentials rotation, configure an HA setup or add additional resources to be encrypted.</p><p>Finally, create a <code>ServiceAccount</code> in the virtual Garden cluster and have the API server issue a token for it.</p><div class="language-console vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">console</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">kubectl create token &lt;service-account-name&gt; -n &lt;namespace&gt; --duration=24h</span></span></code></pre></div><p>Store the token into a <a href="https://kubernetes.io/docs/reference/config-api/kubeconfig.v1/#AuthInfo" target="_blank" rel="noreferrer">kubeconfig file</a> and test, that it can be used to access the virtual Garden cluster. After a successful restore, this token should still be accepted.</p><h3 id="persisting-backup-and-state-data" tabindex="-1">Persisting Backup and State Data <a class="header-anchor" href="#persisting-backup-and-state-data" aria-label="Permalink to &quot;Persisting Backup and State Data&quot;">‚Äã</a></h3><p>Create backups of the state and infrastructure credentials secrets in the <code>garden</code> namespace as described above. Additionally, export the <code>Garden</code> resource including its status subresource.</p><p>To persist the <code>etcd</code> backups, create a copy of the local directory, where the <code>backup-restore</code> sidecar writes to. For local development setups, this is <code>dev/local-backupbuckets/</code> and the directory is prefixed with <code>garden-</code>. Note, that backups are created periodically, so wait some minutes to ensure that latest changes are included.</p><h3 id="causing-a-disaster" tabindex="-1">Causing a Disaster <a class="header-anchor" href="#causing-a-disaster" aria-label="Permalink to &quot;Causing a Disaster&quot;">‚Äã</a></h3><p>To simulate a disaster, simply delete the kind cluster:</p><div class="language-console vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">console</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">make kind-multi-zone-down</span></span></code></pre></div><h3 id="restoring-the-garden-cluster" tabindex="-1">Restoring the Garden Cluster <a class="header-anchor" href="#restoring-the-garden-cluster" aria-label="Permalink to &quot;Restoring the Garden Cluster&quot;">‚Äã</a></h3><p>To start with the restore part, create a new kind cluster:</p><div class="language-console vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">console</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">make kind-multi-zone-up operator-up</span></span></code></pre></div><p>Subsequently, copy the persisted etcd backups into the new local backup bucket directory at <code>dev/local-backupbuckets/</code>.</p><p>Before the <code>Garden</code> can be applied, the name of the backup bucket needs to be added to the <code>Garden</code> resource at <code>.spec.virtualCluster.etcd.main.backup.bucketName</code>. The name matches the directory name of the local backup bucket created earlier (prefixed with <code>garden-</code>).</p><p>Now, follow the restoration procedure as described above, starting with scaling down the <code>gardener-operator</code>, deploying the secrets, applying the <code>Garden</code> resource and patching the status subresource, if necessary.</p><h3 id="validation" tabindex="-1">Validation <a class="header-anchor" href="#validation" aria-label="Permalink to &quot;Validation&quot;">‚Äã</a></h3><p>The <code>Garden</code> resource should reconcile successfully and etcd should contain data from before the disaster. Finally, use the token created before to validate that existing credentials are still valid after the restore.</p>`,109)]))}const g=t(r,[["render",o]]);export{u as __pageData,g as default};

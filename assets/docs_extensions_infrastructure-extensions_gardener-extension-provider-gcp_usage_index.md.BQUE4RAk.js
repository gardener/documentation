import{_ as e,c as i,o as a,a2 as n}from"./chunks/framework.Bfq10Vlj.js";const t="/assets/attribute_mapping.CzsjCJNq.png",g=JSON.parse('{"title":"Usage","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener-extension-provider-gcp","github_subdir":"docs/usage","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/usage.md","to":"usage.md"},"persona":"Users","title":"Usage","prev":false,"next":false},"headers":[],"relativePath":"docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/usage/index.md","filePath":"docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/usage.md","lastUpdated":null}'),l={name:"docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/usage/index.md"};function o(r,s,p,h,d,c){return a(),i("div",null,s[0]||(s[0]=[n(`<h1 id="using-the-gcp-provider-extension-with-gardener-as-end-user" tabindex="-1">Using the GCP provider extension with Gardener as end-user <a class="header-anchor" href="#using-the-gcp-provider-extension-with-gardener-as-end-user" aria-label="Permalink to &quot;Using the GCP provider extension with Gardener as end-user&quot;">​</a></h1><p>The <a href="https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml" target="_blank" rel="noreferrer"><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a few fields that are meant to contain provider-specific configuration.</p><p>This document describes the configurable options for GCP and provides an example <code>Shoot</code> manifest with minimal configuration that can be used to create a GCP cluster (modulo the landscape-specific information like cloud profile names, secret binding names, etc.).</p><h2 id="accessing-gcp-apis" tabindex="-1">Accessing GCP APIs <a class="header-anchor" href="#accessing-gcp-apis" aria-label="Permalink to &quot;Accessing GCP APIs&quot;">​</a></h2><p>In order for Gardener to create a Kubernetes cluster using GCP infrastructure components, a Shoot has to provide an authentication mechanism giving sufficient permissions to the desired GCP project. Every shoot cluster references a <code>SecretBinding</code> or a <a href="https://gardener.cloud/docs/gardener/api-reference/security/#security.gardener.cloud/v1alpha1.CredentialsBinding" target="_blank" rel="noreferrer"><code>CredentialsBinding</code></a>.</p><div class="important custom-block github-alert"><p class="custom-block-title">IMPORTANT</p><p>While <code>SecretBinding</code>s can only reference <code>Secret</code>s, <code>CredentialsBinding</code>s can also reference <code>WorkloadIdentity</code>s which provide an alternative authentication method. <code>WorkloadIdentity</code>s do not directly contain credentials but are rather a representation of the workload that is going to access the user&#39;s account. If the user has configured <a href="https://cloud.google.com/iam/docs/workload-identity-federation" target="_blank" rel="noreferrer">Workload Identity Federation</a> with Gardener&#39;s Workload Identity Issuer then the GCP infrastructure components can access the user&#39;s account without the need of preliminary exchange of credentials.</p></div><div class="important custom-block github-alert"><p class="custom-block-title">IMPORTANT</p><p>The <code>SecretBinding</code>/<code>CredentialsBinding</code> is configurable in the <a href="https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml" target="_blank" rel="noreferrer">Shoot cluster</a> with the field <code>secretBindingName</code>/<code>credentialsBindingName</code>. <code>SecretBinding</code>s are considered legacy and will be deprecated in the future. It is advised to use <code>CredentialsBinding</code>s instead.</p></div><h3 id="gcp-service-account-credentials" tabindex="-1">GCP Service Account Credentials <a class="header-anchor" href="#gcp-service-account-credentials" aria-label="Permalink to &quot;GCP Service Account Credentials&quot;">​</a></h3><p>The required credentials for the GCP project are a <a href="https://cloud.google.com/iam/docs/service-accounts#service_account_keys" target="_blank" rel="noreferrer">Service Account Key</a> to authenticate as a <a href="https://cloud.google.com/compute/docs/access/service-accounts" target="_blank" rel="noreferrer">GCP Service Account</a>. A service account is a special account that can be used by services and applications to interact with Google Cloud Platform APIs. Applications can use service account credentials to authorize themselves to a set of APIs and perform actions within the permissions granted to the service account.</p><p>Make sure to <a href="https://cloud.google.com/service-usage/docs/enable-disable" target="_blank" rel="noreferrer">enable the Google Identity and Access Management (IAM) API</a>. <a href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" target="_blank" rel="noreferrer">Create a Service Account</a> that shall be used for the Shoot cluster. <a href="https://cloud.google.com/iam/docs/granting-changing-revoking-access" target="_blank" rel="noreferrer">Grant at least the following IAM roles</a> to the Service Account.</p><ul><li>Service Account Admin</li><li>Service Account Token Creator</li><li>Service Account User</li><li>Compute Admin</li></ul><p>Create a <a href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys#creating_service_account_keys" target="_blank" rel="noreferrer">JSON Service Account key</a> for the Service Account. Provide it in the <code>Secret</code> (base64 encoded for field <code>serviceaccount.json</code>), that is being referenced by the <code>SecretBinding</code> in the Shoot cluster configuration.</p><p>This <code>Secret</code> must look as follows:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Secret</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core-gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-dev</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Opaque</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  serviceaccount.json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">base64(serviceaccount-json)</span></span></code></pre></div><div class="warning custom-block github-alert"><p class="custom-block-title">WARNING</p><p>Depending on your API usage it can be problematic to reuse the same Service Account Key for different Shoot clusters due to rate limits. Please consider spreading your Shoots over multiple Service Accounts on different GCP projects if you are hitting those limits, see <a href="https://cloud.google.com/compute/docs/api-rate-limits" target="_blank" rel="noreferrer">https://cloud.google.com/compute/docs/api-rate-limits</a>.</p></div><h3 id="gcp-workload-identity-federation" tabindex="-1">GCP Workload Identity Federation <a class="header-anchor" href="#gcp-workload-identity-federation" aria-label="Permalink to &quot;GCP Workload Identity Federation&quot;">​</a></h3><p>Users can choose to trust Gardener&#39;s Workload Identity Issuer and eliminate the need for providing GCP Service Account credentials.</p><p>As a first step users should configure <a href="https://cloud.google.com/iam/docs/workload-identity-federation-with-kubernetes#kubernetes" target="_blank" rel="noreferrer">Workload Identity Federation</a> with Gardener&#39;s Workload Identity Issuer.</p><div class="tip custom-block github-alert"><p class="custom-block-title">TIP</p><p>You can retrieve Gardener&#39;s Workload Identity Issuer URL directly from the Garden cluster by reading the contents of the <a href="https://gardener.cloud/docs/gardener/gardener/gardener_info_configmap/" target="_blank" rel="noreferrer">Gardener Info ConfigMap</a>.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gardener-system-public</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> configmap</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gardener-info</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yaml</span></span></code></pre></div></div><p>In the example attribute mapping shown below all <code>WorkloadIdentity</code>s that are created in the <code>garden-myproj</code> namespace will be authenticated. Now that the Workload Identity Federation is configured the user should download the credential configuration file.</p><div class="important custom-block github-alert"><p class="custom-block-title">IMPORTANT</p><p>If required, users can use a stricter mapping to authenticate only certain <code>WorkloadIdentity</code>s. Please, refer to the <a href="https://cloud.google.com/iam/docs/workload-identity-federation#mapping" target="_blank" rel="noreferrer">attribute mappings documentation</a> for more information.</p></div><p><img src="`+t+`" alt="Attribute Mapping"></p><p>Users should now create a Service Account that is going to be impersonated by the federated identity. Make sure to <a href="https://cloud.google.com/service-usage/docs/enable-disable" target="_blank" rel="noreferrer">enable the Google Identity and Access Management (IAM) API</a>. <a href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" target="_blank" rel="noreferrer">Create a Service Account</a> that shall be used for the Shoot cluster. <a href="https://cloud.google.com/iam/docs/granting-changing-revoking-access" target="_blank" rel="noreferrer">Grant at least the following IAM roles</a> to the Service Account.</p><ul><li>Service Account Token Creator</li><li>Service Account User</li><li>Compute Admin</li></ul><p>As a next step a resource of type <code>WorkloadIdentity</code> should be created in the Garden cluster and configured with the information from the already downloaded credential configuration file. This identity will be used to impersonate the Service Account in order to call GCP APIs.</p><p>Mind that the <code>service_account_impersonation_url</code> is probably not present in the downloaded credential configuration file. You can use the example template or download a new credential configuration file once we grant the permission to the federated identity to impersonate the Service Account.</p><p>A sample of such resource is shown below:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">security.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">WorkloadIdentity</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-myproj</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  audiences</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # This is the audience that you configure during workload identity pool creation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/&lt;pool_name&gt;/providers/&lt;provider_name&gt;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  targetSystem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    providerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp.provider.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">WorkloadIdentityConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      projectID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp-project-name</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # This is the name of the project which the workload identity will access</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # Use the downloaded credential configuration file to set this field. The credential_source field is not important to Gardener and should be omitted.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      credentialsConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        universe_domain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;googleapis.com&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;external_account&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        audience</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;//iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/&lt;pool_name&gt;/providers/&lt;provider_name&gt;&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        subject_token_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;urn:ietf:params:oauth:token-type:jwt&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        service_account_impersonation_url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/&lt;service_account_email&gt;:generateAccessToken&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        token_url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://sts.googleapis.com/v1/token&quot;</span></span></code></pre></div><p>Now users should give permissions to the <code>WorkloadIdentity</code> to impersonate the Service Account. In order to construct the principal that will be used for impersonation retrieve the subject of the created <code>WorkloadIdentity</code>.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SUBJECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> garden-myproj</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> workloadidentity</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o=jsonpath=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;{.status.sub}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;principal://iam.googleapis.com/projects/&lt;project_number&gt;/locations/global/workloadIdentityPools/&lt;pool_name&gt;/subject/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$SUBJECT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span></code></pre></div><p>The principal template is also shown in the Google Console Workload Identity Pool UI.</p><p>Users should give this principal the Role <code>Workload Identity User</code> so that it can impersonate the Service Account. One can do this through the Service Account <code>Permissions</code> tab, through the Google Console Workload Identity Pool UI or by using the <a href="https://cloud.google.com/iam/docs/workload-identity-federation-with-kubernetes#use-service-account-impersonation" target="_blank" rel="noreferrer">gcloud cli</a>.</p><p>As a final step create a <code>CredentialsBinding</code> referencing the GCP <code>WorkloadIdentity</code> and use it in your <code>Shoot</code> definitions.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">security.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CredentialsBinding</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-myproj</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">credentialsRef</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">security.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">WorkloadIdentity</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-myproj</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">provider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-myproj</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  credentialsBindingName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span></code></pre></div><div class="warning custom-block github-alert"><p class="custom-block-title">WARNING</p><p>One can omit the creation of Service Account and directly grant access to the federated identity&#39;s principal, skipping the Service Account impersonation. This although recommended, will not always work because federated identities do not fall under the <a href="https://cloud.google.com/iam/docs/principals-overview#all-authenticated-users" target="_blank" rel="noreferrer"><code>allAuthenticatedUsers</code></a> category and cannot access machine images that are not made available to <a href="https://cloud.google.com/iam/docs/principals-overview#all-users" target="_blank" rel="noreferrer"><code>allUsers</code></a>. This means that machine images should be made available to <code>allUsers</code> or permissions should be explicitly given to the federated identity in order for this to work.</p><p>GCP imposes some restrictions on which images can be accessible to <code>allUsers</code>. As of now, <a href="https://github.com/gardenlinux/gardenlinux" target="_blank" rel="noreferrer">Gardenlinux</a> images are not published in a way that they can be accessed by <code>allUsers</code>. See the following issue for more details <a href="https://github.com/gardenlinux/glci/issues/148" target="_blank" rel="noreferrer">https://github.com/gardenlinux/glci/issues/148</a>.</p></div><h2 id="infrastructureconfig" tabindex="-1"><code>InfrastructureConfig</code> <a class="header-anchor" href="#infrastructureconfig" aria-label="Permalink to &quot;\`InfrastructureConfig\`&quot;">​</a></h2><p>The infrastructure configuration mainly describes how the network layout looks like in order to create the shoot worker nodes in a later step, thus, prepares everything relevant to create VMs, load balancers, volumes, etc.</p><p>An example <code>InfrastructureConfig</code> for the GCP extension looks as follows:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp.provider.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">InfrastructureConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">networks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># vpc:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   name: my-vpc</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   cloudRouter:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     name: my-cloudrouter</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  workers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10.250.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># internal: 10.251.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># cloudNAT:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   minPortsPerVM: 2048</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   maxPortsPerVM: 65536</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   endpointIndependentMapping:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#     enabled: false</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   enableDynamicPortAllocation: false</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   natIPNames:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   - name: manualnat1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   - name: manualnat2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   udpIdleTimeoutSec: 30</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   icmpIdleTimeoutSec: 30</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   tcpEstablishedIdleTimeoutSec: 1200</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   tcpTransitoryIdleTimeoutSec: 30</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   tcpTimeWaitTimeoutSec: 120</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># flowLogs:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   aggregationInterval: INTERVAL_5_SEC</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   flowSampling: 0.2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   metadata: INCLUDE_ALL_METADATA</span></span></code></pre></div><p>The <code>networks.vpc</code> section describes whether you want to create the shoot cluster in an already existing VPC or whether to create a new one:</p><ul><li><p>If <code>networks.vpc.name</code> is given then you have to specify the VPC name of the existing VPC that was created by other means (manually, other tooling, ...). If you want to get a fresh VPC for the shoot then just omit the <code>networks.vpc</code> field.</p></li><li><p>If a VPC name is not given then we will create the cloud router + NAT gateway to ensure that worker nodes don&#39;t get external IPs.</p></li><li><p>If a VPC name is given then a cloud router name must also be given, failure to do so would result in validation errors and possibly clusters without egress connectivity.</p></li><li><p>If a VPC name is given and calico shoot clusters are created without a network overlay within one VPC make sure that the pod CIDR specified in <code>shoot.spec.networking.pods</code> is not overlapping with any other pod CIDR used in that VPC. Overlapping pod CIDRs will lead to disfunctional shoot clusters.</p></li></ul><p>The <code>networks.workers</code> section describes the CIDR for a subnet that is used for all shoot worker nodes, i.e., VMs which later run your applications.</p><p>The <code>networks.internal</code> section is optional and can describe a CIDR for a subnet that is used for <a href="https://cloud.google.com/load-balancing/docs/internal/" target="_blank" rel="noreferrer">internal load balancers</a>,</p><p>The <code>networks.cloudNAT.minPortsPerVM</code> is optional and is used to define the <a href="https://cloud.google.com/nat/docs/overview#number_of_nat_ports_and_connections" target="_blank" rel="noreferrer">minimum number of ports allocated to a VM for the CloudNAT</a></p><p>The <code>networks.cloudNAT.natIPNames</code> is optional and is used to specify the names of the manual ip addresses which should be used by the nat gateway</p><p>The <code>networks.cloudNAT.endpointIndependentMapping</code> is optional and is used to define the <a href="https://cloud.google.com/nat/docs/ports-and-addresses#ports-reuse-endpoints" target="_blank" rel="noreferrer">endpoint mapping behavior</a>. You can enable it or disable it at any point by toggling <code>networks.cloudNAT.endpointIndependentMapping.enabled</code>. By default, it is disabled.</p><p><code>networks.cloudNAT.enableDynamicPortAllocation</code> is optional (default: <code>false</code>) and allows one to enable dynamic port allocation (<a href="https://cloud.google.com/nat/docs/ports-and-addresses#dynamic-port" target="_blank" rel="noreferrer">https://cloud.google.com/nat/docs/ports-and-addresses#dynamic-port</a>). Note that enabling this puts additional restrictions on the permitted values for <code>networks.cloudNAT.minPortsPerVM</code> and <code>networks.cloudNAT.minPortsPerVM</code>, namely that they now both are required to be powers of two. Also, <code>maxPortsPerVM</code> may not be given if dynamic port allocation is <em>disabled</em>.</p><p><code>networks.cloudNAT.udpIdleTimeoutSec</code>, <code>networks.cloudNAT.icmpIdleTimeoutSec</code>, <code>networks.cloudNAT.tcpEstablishedIdleTimeoutSec</code>, <code>networks.cloudNAT.tcpTransitoryIdleTimeoutSec</code>, and <code>networks.cloudNAT.tcpTimeWaitTimeoutSec</code> give more fine-granular control over various timeout-values. For more details see <a href="https://cloud.google.com/nat/docs/public-nat#specs-timeouts" target="_blank" rel="noreferrer">https://cloud.google.com/nat/docs/public-nat#specs-timeouts</a>.</p><p>The specified CIDR ranges must be contained in the VPC CIDR specified above, or the VPC CIDR of your already existing VPC. You can freely choose these CIDRs and it is your responsibility to properly design the network layout to suit your needs.</p><p>The <code>networks.flowLogs</code> section describes the configuration for the VPC flow logs. In order to enable the VPC flow logs at least one of the following parameters needs to be specified in the flow log section:</p><ul><li><p><code>networks.flowLogs.aggregationInterval</code> an optional parameter describing the aggregation interval for collecting flow logs. For more details, see <a href="https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html#aggregation_interval" target="_blank" rel="noreferrer">aggregation_interval reference</a>.</p></li><li><p><code>networks.flowLogs.flowSampling</code> an optional parameter describing the sampling rate of VPC flow logs within the subnetwork where 1.0 means all collected logs are reported and 0.0 means no logs are reported. For more details, see <a href="https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html#flow_sampling" target="_blank" rel="noreferrer">flow_sampling reference</a>.</p></li><li><p><code>networks.flowLogs.metadata</code> an optional parameter describing whether metadata fields should be added to the reported VPC flow logs. For more details, see <a href="https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html#metadata" target="_blank" rel="noreferrer">metadata reference</a>.</p></li></ul><p>Apart from the VPC and the subnets the GCP extension will also create a dedicated service account for this shoot, and firewall rules.</p><h2 id="controlplaneconfig" tabindex="-1"><code>ControlPlaneConfig</code> <a class="header-anchor" href="#controlplaneconfig" aria-label="Permalink to &quot;\`ControlPlaneConfig\`&quot;">​</a></h2><p>The control plane configuration mainly contains values for the GCP-specific control plane components. Today, the only component deployed by the GCP extension is the <code>cloud-controller-manager</code>.</p><p>An example <code>ControlPlaneConfig</code> for the GCP extension looks as follows:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp.provider.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ControlPlaneConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">zone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">europe-west1-b</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cloudControllerManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># featureGates:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   SomeKubernetesFeature: true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">storage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  managedDefaultStorageClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  managedDefaultVolumeSnapshotClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#  csiFilestore:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#    enabled: true</span></span></code></pre></div><p>The <code>zone</code> field tells the cloud-controller-manager in which zone it should mainly operate. You can still create clusters in multiple availability zones, however, the cloud-controller-manager requires one &quot;main&quot; zone. ⚠️ You always have to specify this field!</p><p>The <code>cloudControllerManager.featureGates</code> contains a map of explicitly enabled or disabled feature gates. For production usage it&#39;s not recommend to use this field at all as you can enable alpha features or disable beta/stable features, potentially impacting the cluster stability. If you don&#39;t want to configure anything for the <code>cloudControllerManager</code> simply omit the key in the YAML specification.</p><p>The members of the <code>storage</code> allows to configure the provided storage classes further. If <code>storage.managedDefaultStorageClass</code> is enabled (the default), the <code>default</code> StorageClass deployed will be marked as default (via <code>storageclass.kubernetes.io/is-default-class</code> annotation). Similarly, if <code>storage.managedDefaultVolumeSnapshotClass</code> is enabled (the default), the <code>default</code> VolumeSnapshotClass deployed will be marked as default. In case you want to set a different StorageClass or VolumeSnapshotClass as default you need to set the corresponding option to <code>false</code> as at most one class should be marked as default in each case and the ResourceManager will prevent any changes from the Gardener managed classes to take effect.</p><p>Furthermore, the <code>storage.csiFilestore.enabled</code> field can be set to <code>true</code> to enable the <a href="https://cloud.google.com/filestore/docs/csi-driver" target="_blank" rel="noreferrer">GCP Filestore CSI driver</a>. Additionally, you have to make sure that your IAM user has the permission <code>roles/file.editor</code> and that the filestore API is enabled in your GCP project.</p><h2 id="workerconfig" tabindex="-1">WorkerConfig <a class="header-anchor" href="#workerconfig" aria-label="Permalink to &quot;WorkerConfig&quot;">​</a></h2><p>The worker configuration contains:</p><ul><li><p>Local SSD interface for the additional volumes attached to GCP worker machines.</p><p>If you attach the disk with <code>SCRATCH</code> type, either an <code>NVMe</code> interface or a <code>SCSI</code> interface must be specified. It is only meaningful to provide this volume interface if only <code>SCRATCH</code> data volumes are used.</p></li><li><p>Volume Encryption config that specifies values for <code>kmsKeyName</code> and <code>kmsKeyServiceAccountName</code>.</p><ul><li>The <code>kmsKeyName</code> is the key name of the cloud kms disk encryption key and must be specified if CMEK disk encryption is needed.</li><li>The <code>kmsKeyServiceAccount</code> is the service account granted the <code>roles/cloudkms.cryptoKeyEncrypterDecrypter</code> on the <code>kmsKeyName</code> If empty, then the role should be given to the Compute Engine Service Agent Account. This CESA account usually has the name: <code>service-PROJECT_NUMBER@compute-system.iam.gserviceaccount.com</code>. See: <a href="https://cloud.google.com/iam/docs/service-agents#compute-engine-service-agent" target="_blank" rel="noreferrer">https://cloud.google.com/iam/docs/service-agents#compute-engine-service-agent</a></li><li>Prior to use, the operator should add IAM policy binding using the gcloud CLI:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gcloud projects add-iam-policy-binding projectId --member</span></span>
<span class="line"><span>serviceAccount:name@projectIdgserviceaccount.com --role roles/cloudkms.cryptoKeyEncrypterDecrypter</span></span></code></pre></div></li><li>Setting <code>.spec.provider.workers[].(data)Volumes[].encrypted</code> has no impact because GCP disks are encrypted by default.</li></ul></li><li><p>Setting a volume image with <code>dataVolumes.sourceImage</code>. However, this parameter should only be used with particular caution. For example Gardenlinux works with filesystem LABELs only and creating another disk form the very same image causes the LABELs to be duplicated. See: <a href="https://github.com/gardener/gardener-extension-provider-gcp/issues/323" target="_blank" rel="noreferrer">https://github.com/gardener/gardener-extension-provider-gcp/issues/323</a></p></li><li><p>Some hyperdisks allow adjustment of their default values for <code>provisionedIops</code> and <code>provisionedThroughput</code>. Keep in mind though that Hyperdisk Extreme and Hyperdisk Throughput volumes can&#39;t be used as boot disks.</p></li><li><p>Service Account with their specified scopes, authorized for this worker.</p><p>Service accounts created in advance that generate access tokens that can be accessed through the metadata server and used to authenticate applications on the instance.</p><p><strong>Note</strong>: If you do not provide service accounts for your workers, the Compute Engine default service account will be used. For more details on the default account, see <a href="https://cloud.google.com/compute/docs/access/service-accounts#default_service_account" target="_blank" rel="noreferrer">https://cloud.google.com/compute/docs/access/service-accounts#default_service_account</a>. If the <code>DisableGardenerServiceAccountCreation</code> feature gate is disabled, Gardener will create a shared service accounts to use for all instances. This feature gate is currently in beta and it will no longer be possible to re-enable the service account creation via feature gate flag.</p></li><li><p>GPU with its type and count per node. This will attach that GPU to all the machines in the worker grp</p><p><strong>Note</strong>:</p><ul><li><p>A rolling upgrade of the worker group would be triggered in case the <code>acceleratorType</code> or <code>count</code> is updated.</p></li><li><p>Some machineTypes like <a href="https://cloud.google.com/blog/products/compute/announcing-google-cloud-a2-vm-family-based-on-nvidia-a100-gpu" target="_blank" rel="noreferrer">a2 family</a> come with already attached gpu of <code>a100</code> type and pre-defined count. If your workerPool consists of such machineTypes, please specify exact GPU configuration for the machine type as specified in Google cloud documentation. <code>acceleratorType</code> to use for families with attached gpu are stated below:</p><ol><li><em>a2 family</em> -&gt; <code>nvidia-tesla-a100</code></li><li><em>g2 family</em> -&gt; <code>nvidia-l4</code></li></ol></li><li><p>Sufficient quota of gpu is needed in the GCP project. This includes quota to support autoscaling if enabled.</p></li><li><p>GPU-attached machines can&#39;t be live migrated during host maintenance events. Find out how to handle that in your application <a href="https://cloud.google.com/compute/docs/gpus/gpu-host-maintenance" target="_blank" rel="noreferrer">here</a></p></li><li><p>GPU count specified here is considered for forming node template during scale-from-zero in Cluster Autoscaler</p></li></ul></li><li><p>The <code>.nodeTemplate</code> is used to specify resource information of the machine during runtime. This then helps in Scale-from-Zero. Some points to note for this field:</p><ul><li>Currently only cpu, gpu and memory are configurable.</li><li>a change in the value lead to a rolling update of the machine in the workerpool</li><li>all the resources needs to be specified</li></ul><p>An example <code>WorkerConfig</code> for the GCP looks as follows:</p></li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp.provider.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">WorkerConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">volume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  interface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NVME</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  encryption</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    kmsKeyName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;projects/projectId/locations/&lt;zoneName&gt;/keyRings/&lt;keyRingName&gt;/cryptoKeys/alpha&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    kmsKeyServiceAccount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user@projectId.iam.gserviceaccount.com&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dataVolumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">test</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    sourceImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">projects/sap-se-gcp-gardenlinux/global/images/gardenlinux-gcp-gardener-prod-amd64-1443-3-c261f887</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    provisionedIops</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3000</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    provisionedThroughput</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">140</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">serviceAccount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  email</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">foo@bar.com</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  scopes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://www.googleapis.com/auth/cloud-platform</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">gpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  acceleratorType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">nvidia-tesla-t4</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  count</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">nodeTemplate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># (to be specified only if the node capacity would be different from cloudprofile info during runtime)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  capacity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    gpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">50Gi</span></span></code></pre></div><h2 id="example-shoot-manifest" tabindex="-1">Example <code>Shoot</code> manifest <a class="header-anchor" href="#example-shoot-manifest" aria-label="Permalink to &quot;Example \`Shoot\` manifest&quot;">​</a></h2><p>Please find below an example <code>Shoot</code> manifest:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">johndoe-gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-dev</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  cloudProfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  region</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">europe-west1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  credentialsBindingName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core-gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  provider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    infrastructureConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp.provider.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">InfrastructureConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      networks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        workers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10.250.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    controlPlaneConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp.provider.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ControlPlaneConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      zone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">europe-west1-b</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    workers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">worker-xoluy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      machine</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">n1-standard-4</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      minimum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      maximum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      volume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">50Gi</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pd-standard</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      zones</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">europe-west1-b</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  networking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    nodes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10.250.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">calico</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  kubernetes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.33.3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  maintenance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    autoUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kubernetesVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      machineImageVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  addons</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    kubernetesDashboard</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    nginxIngress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><h2 id="csi-volume-provisioners" tabindex="-1">CSI volume provisioners <a class="header-anchor" href="#csi-volume-provisioners" aria-label="Permalink to &quot;CSI volume provisioners&quot;">​</a></h2><p>Every GCP shoot cluster will be deployed with the GCP PD CSI driver. It is compatible with the legacy in-tree volume provisioner that was deprecated by the Kubernetes community and will be removed in future versions of Kubernetes. End-users might want to update their custom <code>StorageClass</code>es to the new <code>pd.csi.storage.gke.io</code> provisioner.</p><h2 id="support-for-volumeattributesclasses-beta-in-k8s-1-31" tabindex="-1">Support for VolumeAttributesClasses (Beta in k8s 1.31) <a class="header-anchor" href="#support-for-volumeattributesclasses-beta-in-k8s-1-31" aria-label="Permalink to &quot;Support for VolumeAttributesClasses (Beta in k8s 1.31)&quot;">​</a></h2><p>To have the CSI-driver configured to support the necessary features for <a href="https://kubernetes.io/docs/concepts/storage/volume-attributes-classes/" target="_blank" rel="noreferrer">VolumeAttributesClasses</a> on GCP for shoots with a k8s-version greater than 1.31, use the <code>gcp.provider.extensions.gardener.cloud/enable-volume-attributes-class</code> annotation on the shoot. Keep in mind to also enable the required feature flags and runtime-config on the common kubernetes controllers (as outlined in the link above) in the shoot-spec.</p><h2 id="support-for-csi-driver-data-cache-feature" tabindex="-1">Support for CSI-driver data cache feature <a class="header-anchor" href="#support-for-csi-driver-data-cache-feature" aria-label="Permalink to &quot;Support for CSI-driver data cache feature&quot;">​</a></h2><p>To enable data caching for the CSI-driver use the <code>gcp.provider.extensions.gardener.cloud/enable-csi-data-cache</code> annotation on the shoot. This feature is currently experimental and not yet fully documented.</p><h2 id="kubernetes-versions-per-worker-pool" tabindex="-1">Kubernetes Versions per Worker Pool <a class="header-anchor" href="#kubernetes-versions-per-worker-pool" aria-label="Permalink to &quot;Kubernetes Versions per Worker Pool&quot;">​</a></h2><p>This extension supports <code>gardener/gardener</code>&#39;s <code>WorkerPoolKubernetesVersion</code> feature gate, i.e., having <a href="https://github.com/gardener/gardener/blob/8a9c88866ec5fce59b5acf57d4227eeeb73669d7/example/90-shoot.yaml#L69-L70" target="_blank" rel="noreferrer">worker pools with overridden Kubernetes versions</a> since <code>gardener-extension-provider-gcp@v1.21</code>.</p><h2 id="shoot-ca-certificate-and-serviceaccount-signing-key-rotation" tabindex="-1">Shoot CA Certificate and <code>ServiceAccount</code> Signing Key Rotation <a class="header-anchor" href="#shoot-ca-certificate-and-serviceaccount-signing-key-rotation" aria-label="Permalink to &quot;Shoot CA Certificate and \`ServiceAccount\` Signing Key Rotation&quot;">​</a></h2><p>This extension supports <code>gardener/gardener</code>&#39;s <code>ShootCARotation</code> and <code>ShootSARotation</code> feature gates since <code>gardener-extension-provider-gcp@v1.23</code>.</p>`,78)]))}const u=e(l,[["render",o]]);export{g as __pageData,u as default};

import{_ as a,c as i,o,a2 as t}from"./chunks/framework.Bfq10Vlj.js";const u=JSON.parse('{"title":"Topology Aware Routing","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/operations","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/topology_aware_routing.md","to":"topology_aware_routing.md"},"persona":"Operators","title":"Topology Aware Routing","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/topology_aware_routing/index.md","filePath":"docs/gardener/topology_aware_routing.md","lastUpdated":null}'),s={name:"docs/gardener/topology_aware_routing/index.md"};function n(r,e,l,h,d,c){return o(),i("div",null,e[0]||(e[0]=[t(`<h1 id="topology-aware-traffic-routing" tabindex="-1">Topology-Aware Traffic Routing <a class="header-anchor" href="#topology-aware-traffic-routing" aria-label="Permalink to &quot;Topology-Aware Traffic Routing&quot;">​</a></h1><h2 id="motivation" tabindex="-1">Motivation <a class="header-anchor" href="#motivation" aria-label="Permalink to &quot;Motivation&quot;">​</a></h2><p>The enablement of <a href="/docs/gardener/high-availability/shoot_high_availability/">highly available shoot control-planes</a> requires multi-zone seed clusters. A garden runtime cluster can also be a multi-zone cluster. The topology-aware routing is introduced to reduce costs and to improve network performance by avoiding the cross availability zone traffic, if possible. The cross availability zone traffic is charged by the cloud providers and it comes with higher latency compared to the traffic within the same zone. The topology-aware routing feature enables topology-aware routing for <code>Service</code>s deployed in a seed or garden runtime cluster. For the clients consuming these topology-aware services, <code>kube-proxy</code> favors the endpoints which are located in the same zone where the traffic originated from. In this way, the cross availability zone traffic is avoided.</p><h2 id="how-it-works" tabindex="-1">How it works <a class="header-anchor" href="#how-it-works" aria-label="Permalink to &quot;How it works&quot;">​</a></h2><p>The topology-aware routing feature relies on the Kubernetes features <a href="https://kubernetes.io/docs/concepts/services-networking/topology-aware-hints/" target="_blank" rel="noreferrer"><code>TopologyAwareHints</code></a> or <a href="https://kubernetes.io/docs/reference/networking/virtual-ips/#traffic-distribution" target="_blank" rel="noreferrer"><code>ServiceTrafficDistribution</code></a> based on the runtime cluster&#39;s Kubernetes versions.</p><p>For Kubernetes versions &lt; 1.31, the <code>TopologyAwareHints</code> feature is being used on in combination with the <a href="/docs/gardener/topology_aware_routing/#endpointslice-hints-mutating-webhook">EndpointSlice hints mutating webhook</a>.</p><p>For Kubernetes versions &gt;= 1.31, the <code>ServiceTrafficDistribution</code> feature is being used on. The <a href="/docs/gardener/topology_aware_routing/#endpointslice-hints-mutating-webhook">EndpointSlice hints mutating webhook</a> is enabled for Kubernetes 1.31 to allow graceful migration from <code>TopologyAwareHints</code> to <code>ServiceTrafficDistribution</code>.</p><h3 id="how-topologyawarehints-works" tabindex="-1">How <code>TopologyAwareHints</code> works <a class="header-anchor" href="#how-topologyawarehints-works" aria-label="Permalink to &quot;How \`TopologyAwareHints\` works&quot;">​</a></h3><p>The <a href="/docs/gardener/topology_aware_routing/#endpointslice-hints-mutating-webhook">EndpointSlice hints mutating webhook</a> and <a href="/docs/gardener/topology_aware_routing/#kube-proxy">kube-proxy</a> sections reveal the implementation details (and the drawbacks) of the <code>TopologyAwareHints</code> feature. For more details, see <a href="https://kubernetes.io/docs/concepts/services-networking/topology-aware-routing/" target="_blank" rel="noreferrer">upstream documentation</a> of the feature.</p><h5 id="endpointslice-hints-mutating-webhook" tabindex="-1">EndpointSlice Hints Mutating Webhook <a class="header-anchor" href="#endpointslice-hints-mutating-webhook" aria-label="Permalink to &quot;EndpointSlice Hints Mutating Webhook&quot;">​</a></h5><p>The component that is responsible for providing hints in the EndpointSlices resources is the <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/" target="_blank" rel="noreferrer">kube-controller-manager</a>, in particular this is the <a href="https://kubernetes.io/docs/concepts/services-networking/topology-aware-hints/" target="_blank" rel="noreferrer">EndpointSlice controller</a>. However, there are several drawbacks with the TopologyAwareHints feature that don&#39;t allow us to use it in its native way:</p><ul><li><p>The algorithm in the EndpointSlice controller is based on a CPU-balance heuristic. From the TopologyAwareHints documentation:</p><blockquote><p>The controller allocates a proportional amount of endpoints to each zone. This proportion is based on the allocatable CPU cores for nodes running in that zone. For example, if one zone had 2 CPU cores and another zone only had 1 CPU core, the controller would allocate twice as many endpoints to the zone with 2 CPU cores.</p></blockquote><p>In case it is not possible to achieve a balanced distribution of the endpoints, as a safeguard mechanism the controller removes hints from the EndpointSlice resource. In our setup, the clients and the servers are well-known and usually the traffic a component receives does not depend on the zone&#39;s allocatable CPU. Many components deployed by Gardener are scaled automatically by VPA. In case of an overload of a replica, the VPA should provide and apply enhanced CPU and memory resources. Additionally, Gardener uses the cluster-autoscaler to upscale/downscale Nodes dynamically. Hence, it is not possible to ensure a balanced allocatable CPU across the zones.</p></li><li><p>The TopologyAwareHints feature does not work at low-endpoint counts. It falls apart for a Service with less than 10 Endpoints.</p></li><li><p>Hints provided by the EndpointSlice controller are not deterministic. With cluster-autoscaler running and load increasing, hints can be removed in the next moment. There is no option to enforce the zone-level topology.</p></li></ul><p>For more details, see the following issue <a href="https://github.com/kubernetes/kubernetes/issues/113731" target="_blank" rel="noreferrer">kubernetes/kubernetes#113731</a>.</p><p>To circumvent these issues with the EndpointSlice controller, a mutating webhook in the gardener-resource-manager assigns hints to EndpointSlice resources. For each endpoint in the EndpointSlice, it sets the endpoint&#39;s hints to the endpoint&#39;s zone. The webhook overwrites the hints provided by the EndpointSlice controller in kube-controller-manager. For more details, see the <a href="/docs/gardener/concepts/resource-manager/#endpointslice-hints">webhook&#39;s documentation</a>.</p><h5 id="kube-proxy" tabindex="-1">kube-proxy <a class="header-anchor" href="#kube-proxy" aria-label="Permalink to &quot;kube-proxy&quot;">​</a></h5><p>By default, with kube-proxy running in <code>iptables</code> mode, traffic is distributed randomly across all endpoints, regardless of where it originates from. In a cluster with 3 zones, traffic is more likely to go to another zone than to stay in the current zone. With the topology-aware routing feature, kube-proxy filters the endpoints it routes to based on the hints in the EndpointSlice resource. In most of the cases, kube-proxy will prefer the endpoint(s) in the same zone. For more details, see the <a href="https://kubernetes.io/docs/concepts/services-networking/topology-aware-hints/#implementation-kube-proxy" target="_blank" rel="noreferrer">Kubernetes documentation</a>.</p><h3 id="how-servicetrafficdistribution-works" tabindex="-1">How <code>ServiceTrafficDistribution</code> works <a class="header-anchor" href="#how-servicetrafficdistribution-works" aria-label="Permalink to &quot;How \`ServiceTrafficDistribution\` works&quot;">​</a></h3><p>We reported the drawbacks related to the <code>TopologyAwareHints</code> feature in <a href="https://github.com/kubernetes/kubernetes/issues/113731" target="_blank" rel="noreferrer">kubernetes/kubernetes#113731</a>. As result, the Kubernetes community implemented the <code>ServiceTrafficDistribution</code> feature.</p><p>The <code>ServiceTrafficDistribution</code> allows expressing preferences for how traffic should be routed to Service endpoints. For more details, see <a href="https://kubernetes.io/docs/reference/networking/virtual-ips/#traffic-distribution" target="_blank" rel="noreferrer">upstream documentation</a> of the feature.</p><p>The <code>PreferSameZone</code> strategy allows traffic to be routed to Service endpoints in topology-aware and predictable manner. It is simpler than <code>service.kubernetes.io/topology-mode: auto</code> - if there are Service endpoints which reside in the same zone as the client, traffic is routed to one of the endpoints within the same zone as the client. If the client&#39;s zone does not have any available Service endpoints, traffic is routed to any available endpoint within the cluster.</p><h2 id="how-to-make-a-service-topology-aware" tabindex="-1">How to make a Service topology-aware <a class="header-anchor" href="#how-to-make-a-service-topology-aware" aria-label="Permalink to &quot;How to make a Service topology-aware&quot;">​</a></h2><h3 id="how-to-make-a-service-topology-aware-in-kubernetes-1-31" tabindex="-1">How to make a Service topology-aware in Kubernetes &lt; 1.31 <a class="header-anchor" href="#how-to-make-a-service-topology-aware-in-kubernetes-1-31" aria-label="Permalink to &quot;How to make a Service topology-aware in Kubernetes &lt; 1.31&quot;">​</a></h3><p>In Kubernetes &lt; 1.31, <code>TopologyAwareHints</code> and EndpointSlice Hints mutating webhook are being used to make a Service topology-aware. The following annotation and label have to be added to the Service:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    service.kubernetes.io/topology-mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;auto&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    endpoint-slice-hints.resources.gardener.cloud/consider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;true&quot;</span></span></code></pre></div><p>The <code>service.kubernetes.io/topology-mode=auto</code> annotation is needed for kube-proxy. One of the prerequisites on kube-proxy side for using topology-aware routing is the corresponding Service to be annotated with the <code>service.kubernetes.io/topology-mode=auto</code>. For more details, see the following <a href="https://github.com/kubernetes/kubernetes/blob/b46a3f887ca979b1a5d14fd39cb1af43e7e5d12d/pkg/proxy/topology.go#L140-L186" target="_blank" rel="noreferrer">kube-proxy function</a>. The <code>endpoint-slice-hints.resources.gardener.cloud/consider=true</code> label is needed for gardener-resource-manager to prevent the EndpointSlice hints mutating webhook from selecting all EndpointSlice resources but only the ones that are labeled with the consider label.</p><p>The Gardener extensions can use this approach to make a Service they deploy topology-aware.</p><h3 id="how-to-make-a-service-topology-aware-in-kubernetes-1-31-1" tabindex="-1">How to make a Service topology-aware in Kubernetes 1.31 <a class="header-anchor" href="#how-to-make-a-service-topology-aware-in-kubernetes-1-31-1" aria-label="Permalink to &quot;How to make a Service topology-aware in Kubernetes 1.31&quot;">​</a></h3><p>In Kubernetes 1.31, <code>ServiceTrafficDistribution</code> and EndpointSlice Hints mutating webhook are being used to make a Service topology-aware. The <code>.spec.trafficDistribution</code> field has to be set to <code>PreferClose</code> and the label <code>endpoint-slice-hints.resources.gardener.cloud/consider=true</code> needs to be added:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    endpoint-slice-hints.resources.gardener.cloud/consider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  trafficDistribution</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">PreferClose</span></span></code></pre></div><h3 id="how-to-make-a-service-topology-aware-in-kubernetes-1-32-to-1-33" tabindex="-1">How to make a Service topology-aware in Kubernetes 1.32 to 1.33 <a class="header-anchor" href="#how-to-make-a-service-topology-aware-in-kubernetes-1-32-to-1-33" aria-label="Permalink to &quot;How to make a Service topology-aware in Kubernetes 1.32 to 1.33&quot;">​</a></h3><p>In Kubernetes 1.32 to 1.33, <code>ServiceTrafficDistribution</code> is being used to make a Service topology-aware. The <code>.spec.trafficDistribution</code> field has to be set to <code>PreferClose</code>:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  trafficDistribution</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">PreferClose</span></span></code></pre></div><h3 id="how-to-make-a-service-topology-aware-in-kubernetes-1-34-and-later" tabindex="-1">How to make a Service topology-aware in Kubernetes 1.34 and later <a class="header-anchor" href="#how-to-make-a-service-topology-aware-in-kubernetes-1-34-and-later" aria-label="Permalink to &quot;How to make a Service topology-aware in Kubernetes 1.34 and later&quot;">​</a></h3><p>The value <code>PreferClose</code> has been deprecated in favor of <code>PreferSameZone</code> and <code>PreferSameNode</code>. <code>PreferSameZone</code> is an alias for the existing <code>PreferClose</code> to clarify its semantics. For more information, read the details in the <a href="https://kubernetes.io/blog/2025/08/27/kubernetes-v1-34-release/#preferclose-traffic-distribution-is-deprecated" target="_blank" rel="noreferrer">Kubernetes deprecation announcement</a>. In Kubernetes 1.34 and later, <code>ServiceTrafficDistribution</code> is still used to make a Service topology-aware. The <code>.spec.trafficDistribution</code> field should be set to <code>PreferSameZone</code>:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  trafficDistribution</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">PreferSameZone</span></span></code></pre></div><h2 id="prerequisites-for-making-a-service-topology-aware" tabindex="-1">Prerequisites for making a Service topology-aware <a class="header-anchor" href="#prerequisites-for-making-a-service-topology-aware" aria-label="Permalink to &quot;Prerequisites for making a Service topology-aware&quot;">​</a></h2><ol><li>The Pods backing the Service should be spread on most of the available zones. This constraint should be ensured with appropriate scheduling constraints (topology spread constraints, (anti-)affinity). Enabling the feature for a Service with a single backing Pod or Pods all located in the same zone does not lead to a benefit.</li><li>The component should be scaled up by <code>VerticalPodAutoscaler</code>. In case of an overload (a large portion of the of the traffic is originating from a given zone), the <code>VerticalPodAutoscaler</code> should provide better resource recommendations for the overloaded backing Pods.</li><li>Consider the <a href="https://kubernetes.io/docs/concepts/services-networking/topology-aware-hints/#constraints" target="_blank" rel="noreferrer"><code>TopologyAwareHints</code> constraints</a>.</li></ol><blockquote><p>Note: The topology-aware routing feature is considered as alpha feature. Use it only for evaluation purposes.</p></blockquote><h2 id="topology-aware-services-in-the-seed-cluster" tabindex="-1">Topology-aware Services in the Seed cluster <a class="header-anchor" href="#topology-aware-services-in-the-seed-cluster" aria-label="Permalink to &quot;Topology-aware Services in the Seed cluster&quot;">​</a></h2><h5 id="etcd-main-client-and-etcd-events-client" tabindex="-1">etcd-main-client and etcd-events-client <a class="header-anchor" href="#etcd-main-client-and-etcd-events-client" aria-label="Permalink to &quot;etcd-main-client and etcd-events-client&quot;">​</a></h5><p>The <code>etcd-main-client</code> and <code>etcd-events-client</code> Services are topology-aware. They are consumed by the kube-apiserver.</p><h5 id="kube-apiserver" tabindex="-1">kube-apiserver <a class="header-anchor" href="#kube-apiserver" aria-label="Permalink to &quot;kube-apiserver&quot;">​</a></h5><p>The <code>kube-apiserver</code> Service is topology-aware if the shoot uses layer 4 load-balancing. If it is using layer 7 load-balancing it is not. It is consumed by the controllers running in the Shoot control plane.<br> Layer 7 load-balancing is active when <code>IstioTLSTermination</code> feature gate is active on the Seed and the Shoot did not opt out. Please see this <a href="/docs/gardener/kube_apiserver_loadbalancing/">documentation</a> for more details.</p><blockquote><p>Note: The <code>istio-ingressgateway</code> component routes traffic in topology-aware manner - if possible, it routes traffic to the target <code>kube-apiserver</code> Pods in the same zone. If there is no healthy <code>kube-apiserver</code> Pod available in the same zone, the traffic is routed to any of the healthy Pods in the other zones. This behaviour is unconditionally enabled.</p></blockquote><h5 id="gardener-resource-manager" tabindex="-1">gardener-resource-manager <a class="header-anchor" href="#gardener-resource-manager" aria-label="Permalink to &quot;gardener-resource-manager&quot;">​</a></h5><p>The <code>gardener-resource-manager</code> Service that is part of the Shoot control plane is topology-aware. The resource-manager serves webhooks and the Service is consumed by the kube-apiserver for the webhook communication.</p><h5 id="vpa-webhook" tabindex="-1">vpa-webhook <a class="header-anchor" href="#vpa-webhook" aria-label="Permalink to &quot;vpa-webhook&quot;">​</a></h5><p>The <code>vpa-webhook</code> Service that is part of the Shoot control plane is topology-aware. It is consumed by the kube-apiserver for the webhook communication.</p><h2 id="topology-aware-services-in-the-garden-runtime-cluster" tabindex="-1">Topology-aware Services in the garden runtime cluster <a class="header-anchor" href="#topology-aware-services-in-the-garden-runtime-cluster" aria-label="Permalink to &quot;Topology-aware Services in the garden runtime cluster&quot;">​</a></h2><h5 id="virtual-garden-etcd-main-client-and-virtual-garden-etcd-events-client" tabindex="-1">virtual-garden-etcd-main-client and virtual-garden-etcd-events-client <a class="header-anchor" href="#virtual-garden-etcd-main-client-and-virtual-garden-etcd-events-client" aria-label="Permalink to &quot;virtual-garden-etcd-main-client and virtual-garden-etcd-events-client&quot;">​</a></h5><p>The <code>virtual-garden-etcd-main-client</code> and <code>virtual-garden-etcd-events-client</code> Services are topology-aware. <code>virtual-garden-etcd-main-client</code> is consumed by <code>virtual-garden-kube-apiserver</code> and <code>gardener-apiserver</code>, <code>virtual-garden-etcd-events-client</code> is consumed by <code>virtual-garden-kube-apiserver</code>.</p><h5 id="virtual-garden-kube-apiserver" tabindex="-1">virtual-garden-kube-apiserver <a class="header-anchor" href="#virtual-garden-kube-apiserver" aria-label="Permalink to &quot;virtual-garden-kube-apiserver&quot;">​</a></h5><p>The <code>virtual-garden-kube-apiserver</code> Service is topology-aware if it uses layer 4 load-balancing. If it is using layer 7 load-balancing it is not. It is consumed by <code>virtual-garden-kube-controller-manager</code>, <code>gardener-controller-manager</code>, <code>gardener-scheduler</code>, <code>gardener-admission-controller</code>, extension admission components, <code>gardener-dashboard</code> and other components. Layer 7 load-balancing is active when <code>IstioTLSTermination</code> feature gate is active in <code>gardener-operator</code>. Please see this <a href="/docs/gardener/kube_apiserver_loadbalancing/">documentation</a> for more details.</p><h5 id="gardener-apiserver" tabindex="-1">gardener-apiserver <a class="header-anchor" href="#gardener-apiserver" aria-label="Permalink to &quot;gardener-apiserver&quot;">​</a></h5><p>The <code>gardener-apiserver</code> Service is topology-aware. It is consumed by <code>virtual-garden-kube-apiserver</code>. The aggregation layer in <code>virtual-garden-kube-apiserver</code> proxies requests sent for the Gardener API types to the <code>gardener-apiserver</code>.</p><h5 id="gardener-admission-controller" tabindex="-1">gardener-admission-controller <a class="header-anchor" href="#gardener-admission-controller" aria-label="Permalink to &quot;gardener-admission-controller&quot;">​</a></h5><p>The <code>gardener-admission-controller</code> Service is topology-aware. It is consumed by <code>virtual-garden-kube-apiserver</code> and <code>gardener-apiserver</code> for the webhook communication.</p><h2 id="how-to-enable-the-topology-aware-routing-for-a-seed-cluster" tabindex="-1">How to enable the topology-aware routing for a Seed cluster? <a class="header-anchor" href="#how-to-enable-the-topology-aware-routing-for-a-seed-cluster" aria-label="Permalink to &quot;How to enable the topology-aware routing for a Seed cluster?&quot;">​</a></h2><p>For a Seed cluster the topology-aware routing functionality can be enabled in the Seed specification:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Seed</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  settings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    topologyAwareRouting</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><p>The topology-aware routing setting can be only enabled for a Seed cluster with more than one zone. gardenlet enables topology-aware Services only for Shoot control planes with failure tolerance type <code>zone</code> (<code>.spec.controlPlane.highAvailability.failureTolerance.type=zone</code>). Control plane Pods of non-HA Shoots and HA Shoots with failure tolerance type <code>node</code> are pinned to single zone. For more details, see <a href="/docs/gardener/high-availability-of-components/">High Availability Of Deployed Components</a>.</p><h2 id="how-to-enable-the-topology-aware-routing-for-a-garden-runtime-cluster" tabindex="-1">How to enable the topology-aware routing for a garden runtime cluster? <a class="header-anchor" href="#how-to-enable-the-topology-aware-routing-for-a-garden-runtime-cluster" aria-label="Permalink to &quot;How to enable the topology-aware routing for a garden runtime cluster?&quot;">​</a></h2><p>For a garden runtime cluster the topology-aware routing functionality can be enabled in the Garden resource specification:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">operator.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Garden</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  runtimeCluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    settings</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      topologyAwareRouting</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><p>The topology-aware routing setting can be only enabled for a garden runtime cluster with more than one zone.</p>`,65)]))}const k=a(s,[["render",n]]);export{u as __pageData,k as default};

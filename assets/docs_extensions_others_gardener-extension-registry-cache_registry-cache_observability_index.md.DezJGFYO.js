import{_ as t,c as s,o as a,a2 as r}from"./chunks/framework.Bfq10Vlj.js";const u=JSON.parse('{"title":"Observability","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener-extension-registry-cache","github_subdir":"docs/usage/registry-cache","params":{"github_branch":"main"},"path_base_for_github_subdir":{"from":"content/docs/extensions/others/gardener-extension-registry-cache/registry-cache/observability.md","to":"observability.md"},"persona":"Users","title":"Observability","prev":false,"next":false},"headers":[],"relativePath":"docs/extensions/others/gardener-extension-registry-cache/registry-cache/observability/index.md","filePath":"docs/extensions/others/gardener-extension-registry-cache/registry-cache/observability.md","lastUpdated":null}'),i={name:"docs/extensions/others/gardener-extension-registry-cache/registry-cache/observability/index.md"};function o(l,e,n,c,h,d){return a(),s("div",null,e[0]||(e[0]=[r(`<h1 id="registry-cache-observability" tabindex="-1">Registry Cache Observability <a class="header-anchor" href="#registry-cache-observability" aria-label="Permalink to &quot;Registry Cache Observability&quot;">​</a></h1><p>The <code>registry-cache</code> extension exposes metrics for the registry caches running in the Shoot cluster so that they can be easily viewed by cluster owners and operators in the Shoot&#39;s Prometheus and Plutono instances. The exposed monitoring data provides an overview of the performance of the pull-through caches, including hit rate and network traffic data.</p><h2 id="metrics" tabindex="-1">Metrics <a class="header-anchor" href="#metrics" aria-label="Permalink to &quot;Metrics&quot;">​</a></h2><p>A registry cache serves <a href="https://github.com/distribution/distribution/blob/v3.0.0/registry/proxy/proxymetrics.go#L12-L21" target="_blank" rel="noreferrer">several metrics</a>. The metrics are scraped by the <a href="/docs/gardener/monitoring/#shoot-prometheus">Shoot&#39;s Prometheus instance</a>.</p><p>The <code>Registry Caches</code> dashboard in the Shoot&#39;s Plutono instance contains several panels which are built using the registry cache metrics. From the <code>Registry</code> dropdown menu you can select the upstream for which you wish the metrics to be displayed (by default, metrics are summed for all upstream registries).</p><p>Following is a list of all exposed registry cache metrics. The <code>upstream_host</code> label can be used to determine the upstream host to which the metrics are related, while the <code>type</code> label can be used to determine weather the metric is for an image <code>blob</code> or an image <code>manifest</code>:</p><h4 id="registry-proxy-requests-total" tabindex="-1">registry_proxy_requests_total <a class="header-anchor" href="#registry-proxy-requests-total" aria-label="Permalink to &quot;registry_proxy_requests_total&quot;">​</a></h4><p>The number of total incoming request received.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id="registry-proxy-hits-total" tabindex="-1">registry_proxy_hits_total <a class="header-anchor" href="#registry-proxy-hits-total" aria-label="Permalink to &quot;registry_proxy_hits_total&quot;">​</a></h4><p>The number of total cache hits; i.e. the requested content exists in the registry cache&#39;s image store and it is served from there (upstream is not contacted at all for serving the requested content).</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id="registry-proxy-misses-total" tabindex="-1">registry_proxy_misses_total <a class="header-anchor" href="#registry-proxy-misses-total" aria-label="Permalink to &quot;registry_proxy_misses_total&quot;">​</a></h4><p>The number of total cache misses; i.e. the requested content does not exist in the registry cache&#39;s image store and it is fetched from the upstream.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id="registry-proxy-pulled-bytes-total" tabindex="-1">registry_proxy_pulled_bytes_total <a class="header-anchor" href="#registry-proxy-pulled-bytes-total" aria-label="Permalink to &quot;registry_proxy_pulled_bytes_total&quot;">​</a></h4><p>The size of total bytes that the registry cache has pulled from the upstream.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h4 id="registry-proxy-pushed-bytes-total" tabindex="-1">registry_proxy_pushed_bytes_total <a class="header-anchor" href="#registry-proxy-pushed-bytes-total" aria-label="Permalink to &quot;registry_proxy_pushed_bytes_total&quot;">​</a></h4><p>The size of total bytes pushed to the registry cache&#39;s clients.</p><ul><li>Type: Counter</li><li>Labels: <code>upstream_host</code> <code>type</code></li></ul><h2 id="alerts" tabindex="-1">Alerts <a class="header-anchor" href="#alerts" aria-label="Permalink to &quot;Alerts&quot;">​</a></h2><p>There are two alerts defined for the registry cache <code>PersistentVolume</code> in the Shoot&#39;s Prometheus instance:</p><h4 id="registrycachepersistentvolumeusagecritical" tabindex="-1">RegistryCachePersistentVolumeUsageCritical <a class="header-anchor" href="#registrycachepersistentvolumeusagecritical" aria-label="Permalink to &quot;RegistryCachePersistentVolumeUsageCritical&quot;">​</a></h4><p>This indicates that the registry cache <code>PersistentVolume</code> is almost full and less than 5% is free. When there is no available disk space, no new images will be cached. However, image pull operations are not affected. An alert is fired when the following expression evaluates to true:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>100 * (</span></span>
<span class="line"><span> kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&quot;^cache-volume-registry-.+$&quot;}</span></span>
<span class="line"><span>   /</span></span>
<span class="line"><span> kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~&quot;^cache-volume-registry-.+$&quot;}</span></span>
<span class="line"><span>) &lt; 5</span></span></code></pre></div><h4 id="registrycachepersistentvolumefullinfourdays" tabindex="-1">RegistryCachePersistentVolumeFullInFourDays <a class="header-anchor" href="#registrycachepersistentvolumefullinfourdays" aria-label="Permalink to &quot;RegistryCachePersistentVolumeFullInFourDays&quot;">​</a></h4><p>This indicates that the registry cache <code>PersistentVolume</code> is expected to fill up within four days based on recent sampling. An alert is fired when the following expression evaluates to true:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>100 * (</span></span>
<span class="line"><span> kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&quot;^cache-volume-registry-.+$&quot;}</span></span>
<span class="line"><span>   /</span></span>
<span class="line"><span> kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~&quot;^cache-volume-registry-.+$&quot;}</span></span>
<span class="line"><span>) &lt; 15</span></span>
<span class="line"><span>and</span></span>
<span class="line"><span>predict_linear(kubelet_volume_stats_available_bytes{persistentvolumeclaim=~&quot;^cache-volume-registry-.+$&quot;}[30m], 4 * 24 * 3600) &lt;= 0</span></span></code></pre></div><p>Users can subscribe to these alerts by following the Gardener <a href="/docs/gardener/monitoring/alerting/#alerting-for-users">alerting guide</a>.</p><h2 id="logging" tabindex="-1">Logging <a class="header-anchor" href="#logging" aria-label="Permalink to &quot;Logging&quot;">​</a></h2><p>To view the registry cache logs in Plutono, navigate to the <code>Explore</code> tab and select <code>vali</code> from the <code>Explore</code> dropdown menu. Afterwards enter the following <code>vali</code> query:</p><ul><li><code>{container_name=&quot;registry-cache&quot;}</code> to view the logs for all registries.</li><li><code>{pod_name=~&quot;registry-&lt;upstream_host&gt;.+&quot;}</code> to view the logs for specific upstream registry.</li></ul>`,33)]))}const y=t(i,[["render",o]]);export{u as __pageData,y as default};

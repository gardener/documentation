import{_ as s,c as a,o as t,a2 as i}from"./chunks/framework.Bfq10Vlj.js";const n="/assets/tailscale.drawio.CD25ewsG.svg",u=JSON.parse('{"title":"Tailscale","description":"","frontmatter":{"github_repo":"https://github.com/gardener/documentation","github_subdir":"website/documentation/guides/administer-shoots","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/guides/administer-shoots/tailscale.md","to":"tailscale.md"},"title":"Tailscale","prev":false,"next":false},"headers":[],"relativePath":"docs/guides/administer-shoots/tailscale/index.md","filePath":"docs/guides/administer-shoots/tailscale.md","lastUpdated":null}'),l={name:"docs/guides/administer-shoots/tailscale/index.md"};function r(h,e,o,p,c,d){return t(),a("div",null,e[0]||(e[0]=[i('<h1 id="access-the-kubernetes-apiserver-from-your-tailnet" tabindex="-1">Access the Kubernetes apiserver from your tailnet <a class="header-anchor" href="#access-the-kubernetes-apiserver-from-your-tailnet" aria-label="Permalink to &quot;Access the Kubernetes apiserver from your tailnet&quot;">​</a></h1><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>If you would like to strengthen the security of your Kubernetes cluster even further, this guide post explains how this can be achieved.</p><p>The most common way to secure a Kubernetes cluster which was created with Gardener is to apply the ACLs described in the <a href="https://github.com/stackitcloud/gardener-extension-acl" target="_blank" rel="noreferrer">Gardener ACL Extension</a> repository or to use <a href="/docs/gardener/networking/exposureclasses/">ExposureClass</a>, which exposes the Kubernetes apiserver in a corporate network not exposed to the public internet.</p><p>However, those solutions are not without their drawbacks. Managing the ACL extension becomes fairly difficult with the growing number of participants, especially in a dynamic environment and work from home scenarios, and using ExposureClass requires you to first have a corporate network suitable for this purpose.</p><p>But there is a solution which bridges the gap between these two approaches by the use of a mesh VPN based on <a href="https://www.wireguard.com/" target="_blank" rel="noreferrer">WireGuard</a>.</p><h2 id="tailscale" tabindex="-1">Tailscale <a class="header-anchor" href="#tailscale" aria-label="Permalink to &quot;Tailscale&quot;">​</a></h2><p>Tailscale is a mesh VPN network which uses Wireguard under the hood, but automates the key exchange procedure. Please consult the official <a href="https://tailscale.com/kb/1151/what-is-tailscale" target="_blank" rel="noreferrer">tailscale documentation</a> for a detailed explanation.</p><h2 id="target-architecture" tabindex="-1">Target Architecture <a class="header-anchor" href="#target-architecture" aria-label="Permalink to &quot;Target Architecture&quot;">​</a></h2><p><img src="'+n+`" alt="architecture"></p><h3 id="installation" tabindex="-1">Installation <a class="header-anchor" href="#installation" aria-label="Permalink to &quot;Installation&quot;">​</a></h3><p>In order to be able to access the Kubernetes apiserver only from a tailscale VPN, you need this steps:</p><ol><li>Create a tailscale account and ensure <a href="https://tailscale.com/kb/1081/magicdns?q=magic" target="_blank" rel="noreferrer">MagicDNS</a> is enabled.</li><li>Create an OAuth ClientID and Secret <a href="https://tailscale.com/kb/1236/kubernetes-operator#prerequisites" target="_blank" rel="noreferrer">OAuth ClientID and Secret</a>. Don&#39;t forget to create the required tags.</li><li>Install the tailscale operator <a href="https://tailscale.com/kb/1236/kubernetes-operator#installation" target="_blank" rel="noreferrer">tailscale operator</a>.</li></ol><p>If all went well after the operator installation, you should be able to see the tailscale operator by running <code>tailscale status</code>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># tailscale status</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">100.83.240.121</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  tailscale-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   tagged-devices</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> linux</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   -</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span></code></pre></div><h3 id="expose-the-kubernetes-apiserver" tabindex="-1">Expose the Kubernetes apiserver <a class="header-anchor" href="#expose-the-kubernetes-apiserver" aria-label="Permalink to &quot;Expose the Kubernetes apiserver&quot;">​</a></h3><p>Now you are ready to expose the Kubernetes apiserver in the tailnet by annotating the service which was created by Gardener:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> annotate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubernetes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tailscale.com/expose=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tailscale.com/hostname=kubernetes</span></span></code></pre></div><p>It is required to <code>kubernetes</code> as the hostname, because this is part of the certificate common name of the Kubernetes apiserver.</p><p>After annotating the service, it will be exposed in the tailnet and can be shown by running <code>tailscale status</code>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># tailscale status</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">100.83.240.121</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  tailscale-operator</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   tagged-devices</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> linux</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   -</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">100.96.191.87</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   kubernetes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           tagged-devices</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> linux</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   idle,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19548</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 71656</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span></code></pre></div><h3 id="modify-the-kubeconfig" tabindex="-1">Modify the kubeconfig <a class="header-anchor" href="#modify-the-kubeconfig" aria-label="Permalink to &quot;Modify the kubeconfig&quot;">​</a></h3><p>In order to access the cluster via the VPN, you must modify the kubeconfig to point to the Kubernetes service exposed in the tailnet, by changing the <code>server</code> entry to <code>https://kubernetes</code>.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">clusters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      certificate-authority-data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;base64 encoded secret&gt;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://kubernetes</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">my-cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span></code></pre></div><h3 id="enable-acls-to-block-all-ips" tabindex="-1">Enable ACLs to Block All IPs <a class="header-anchor" href="#enable-acls-to-block-all-ips" aria-label="Permalink to &quot;Enable ACLs to Block All IPs&quot;">​</a></h3><p>Now you are ready to use your cluster from every device which is part of your tailnet. Therefore you can now block all access to the Kubernetes apiserver with the ACL extension.</p><h2 id="caveats" tabindex="-1">Caveats <a class="header-anchor" href="#caveats" aria-label="Permalink to &quot;Caveats&quot;">​</a></h2><h3 id="multiple-kubernetes-clusters" tabindex="-1">Multiple Kubernetes Clusters <a class="header-anchor" href="#multiple-kubernetes-clusters" aria-label="Permalink to &quot;Multiple Kubernetes Clusters&quot;">​</a></h3><p>You can actually not join multiple Kubernetes Clusters to join your <code>tailnet</code> because the <code>kubernetes</code> service in every cluster would overlap.</p><h3 id="headscale" tabindex="-1">Headscale <a class="header-anchor" href="#headscale" aria-label="Permalink to &quot;Headscale&quot;">​</a></h3><p>It is possible to host a tailscale coordination by your own if you do not want to rely on the service tailscale.com offers. The <a href="https://github.com/juanfont/headscale" target="_blank" rel="noreferrer">headscale project</a> is a open source implementation of this.</p><p>This works for basic tailscale VPN setups, but not for the tailscale operator described here, because <code>headscale</code> does not implement all required API endpoints for the tailscale operator. The details can be found in this <a href="https://github.com/juanfont/headscale/issues/1202" target="_blank" rel="noreferrer">Github Issue</a>.</p>`,32)]))}const b=s(l,[["render",r]]);export{u as __pageData,b as default};

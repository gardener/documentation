import{_ as s,c as i,o as t,a2 as a}from"./chunks/framework.Bfq10Vlj.js";const n="/assets/otel-gardener-shoot.wPeVi8ol.png",l="/assets/otel-mtls-kube-rbac-proxy.CjcmiEkO.png",r="/assets/otel-victoria-logs.CN7BezR6.png",h="/assets/otel-prometheus.KW2Fc1E7.png",u=JSON.parse('{"title":"Getting Started with OpenTelemetry on a Gardener Shoot Cluster","description":"","frontmatter":{"aliases":["/blog/2025/06/30/getting-started-with-opentelemetry-on-gardener-shoot-cluster"],"authors":[{"avatar":"https://avatars.githubusercontent.com/nickytd","email":"nickytd@gmail.com","login":"nickytd","name":"Niki Dokovski"}],"github_repo":"https://github.com/gardener/documentation","github_subdir":"website/blog/2025/06","linkTitle":"Getting started with OpenTelemetry on a Gardener shoot cluster","newsSubtitle":"June 30, 2025","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/blog/2025/06/06-30-getting-started-with-opentelemetry-on-gardener-shoot-cluster.md","to":"06-30-getting-started-with-opentelemetry-on-gardener-shoot-cluster.md"},"publishdate":"2025-06-30","title":"Getting Started with OpenTelemetry on a Gardener Shoot Cluster"},"headers":[],"relativePath":"blog/2025/06/06-30-getting-started-with-opentelemetry-on-gardener-shoot-cluster/index.md","filePath":"blog/2025/06/06-30-getting-started-with-opentelemetry-on-gardener-shoot-cluster.md","lastUpdated":null}'),o={name:"blog/2025/06/06-30-getting-started-with-opentelemetry-on-gardener-shoot-cluster/index.md"};function p(c,e,k,d,g,m){return t(),i("div",null,e[0]||(e[0]=[a('<h1 id="getting-started-with-opentelemetry-on-a-gardener-shoot-cluster" tabindex="-1">Getting Started with OpenTelemetry on a Gardener Shoot Cluster <a class="header-anchor" href="#getting-started-with-opentelemetry-on-a-gardener-shoot-cluster" aria-label="Permalink to &quot;Getting Started with OpenTelemetry on a Gardener Shoot Cluster&quot;">​</a></h1><p>In this blog post, we will explore how to set up an <a href="https://opentelemetry.io/" target="_blank" rel="noreferrer">OpenTelemetry</a> based observability stack on a Gardener shoot cluster. OpenTelemetry is an open-source observability framework that provides a set of APIs, SDKs, agents, and instrumentation to collect telemetry data from applications and systems. It provides a unified approach for collecting, processing, and exporting telemetry data such as traces, metrics, and logs. In addition, it gives flexibility in designing observability stacks, helping avoid vendor lock-in and allowing users to choose the most suitable tools for their use cases.</p><p>Here we will focus on setting up OpenTelemetry for a Gardener shoot cluster, collecting both logs and metrics and exporting them to various backends. We will use the <a href="https://github.com/open-telemetry/opentelemetry-operator" target="_blank" rel="noreferrer">OpenTelemetry Operator</a> to simplify the deployment and management of OpenTelemetry collectors on Kubernetes and demonstrate some best practices for configuration including security and performance considerations.</p><h2 id="prerequisites" tabindex="-1">Prerequisites <a class="header-anchor" href="#prerequisites" aria-label="Permalink to &quot;Prerequisites&quot;">​</a></h2><p>To follow along with this guide, you will need:</p><ul><li>A Gardener Shoot Cluster.</li><li><code>kubectl</code> configured to access the cluster.</li><li><code>shoot-cert-service</code> enabled on the shoot cluster, to manage TLS certificates for the OpenTelemetry Collectors and backends.</li></ul><h2 id="component-overview-of-the-sample-opentelemetry-stack" tabindex="-1">Component Overview of the Sample OpenTelemetry Stack <a class="header-anchor" href="#component-overview-of-the-sample-opentelemetry-stack" aria-label="Permalink to &quot;Component Overview of the Sample OpenTelemetry Stack&quot;">​</a></h2><p><img src="'+n+'" alt="OpenTelemetry Stack"></p><h2 id="setting-up-a-gardener-shoot-for-mtls-certificate-management" tabindex="-1">Setting Up a Gardener Shoot for mTLS Certificate Management <a class="header-anchor" href="#setting-up-a-gardener-shoot-for-mtls-certificate-management" aria-label="Permalink to &quot;Setting Up a Gardener Shoot for mTLS Certificate Management&quot;">​</a></h2><p>Here we use a self managed mTLS architecture with an illustration purpose. In a production environment, you would typically use a managed certificate authority (CA) or a service mesh to handle mTLS certificates and encryption. However, there might be cases where you want to have flexibility in authentication and authorization mechanisms, for example, by leveraging Kubernetes RBAC to determine whether a service is authorized to connect to a backend or not. In our illustration, we will use a <code>kube-rbac-proxy</code> as a sidecar to the backends, to enforce the mTLS authentication and authorization. The <code>kube-rbac-proxy</code> is a reverse proxy that uses Kubernetes RBAC to control access to services, allowing us to define fine-grained access control policies.</p><p><img src="'+l+`" alt="otel-mtls"></p><p>The <code>kube-rbac-proxy</code> extracts the identity of the client (OpenTelemetry collector) from the CommonName (CN) field of the TLS certificate and uses it to perform authorization checks against the Kubernetes API server. This enables fine-grained access control policies based on client identity, ensuring that only authorized clients can connect to the backends.</p><p>First, set up the <code>Issuer</code> certificate in the Gardener shoot cluster, allowing you to later issue and manage TLS certificates for the OpenTelemetry collectors and the backends. To allow a custom issuer, the shoot cluster shall be configured with the <code>shoot-cert-service</code> extension.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">my-shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">my-project</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  extensions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot-cert-service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      providerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">service.cert.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CertConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        shootIssuers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span></code></pre></div><p>Once the shoot is reconciled, the <code>Issuer.cert.gardener.cloud</code> resources will be available. We can use <code>openssl</code> to create a self-signed CA certificate that will be used to sign the TLS certificates for the OpenTelemetry Collector and backends.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> genrsa</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./ca.key</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4096</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> req</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -x509</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -nodes</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./ca.key</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sha256</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -days</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 365</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./ca.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -subj</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/CN=ca&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Create namespace and apply the CA secret and issuer</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> certs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    --dry-run=client</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yaml</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Create the CA secret in the certs namespace</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secret</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tls</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> certs</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    --key=./ca.key</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --cert=./ca.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    --dry-run=client</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yaml</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span></code></pre></div><p>Next, we will create the cluster <code>Issuer</code> resource, referencing the CA secret we just created.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cert.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Issuer</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">issuer-selfsigned</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">certs</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ca</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    privateKeySecretRef</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ca</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">certs</span></span></code></pre></div><p>Later, we can create <code>Certificate</code> resources to securely connect the OpenTelemetry collectors to the backends.</p><h2 id="setting-up-the-opentelemetry-operator" tabindex="-1">Setting Up the OpenTelemetry Operator <a class="header-anchor" href="#setting-up-the-opentelemetry-operator" aria-label="Permalink to &quot;Setting Up the OpenTelemetry Operator&quot;">​</a></h2><p>To deploy the OpenTelemetry Operator on your Gardener Shoot Cluster, we can use the <a href="https://github.com/open-telemetry/opentelemetry-helm-charts/tree/main/charts/opentelemetry-operator" target="_blank" rel="noreferrer">project helm chart</a> with a minimum configuration. The important part is to set the <code>collector</code> image to the latest <code>contrib</code> distribution image which determines the set of receivers, processors, and exporters plugins that will be available in the OpenTelemetry collector instance. There are several <a href="https://github.com/open-telemetry/opentelemetry-collector-releases" target="_blank" rel="noreferrer">pre-built distributions</a> available such as: <code>otelcol</code>, <code>otelcol-contrib</code>, <code>otelcol-k8s</code>, <code>otelcol-otlp</code>, and <code>otelcol-ebpf-profiler</code>. For the purpose of this guide, we will use the <code>otelcol-contrib</code> distribution, which includes a wide range of plugins for various backends and data sources.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">manager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  collectorImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    repository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;otel/opentelemetry-collector-contrib&quot;</span></span></code></pre></div><h2 id="setting-up-the-backends-prometheus-victoria-logs" tabindex="-1">Setting Up the Backends (prometheus, victoria-logs) <a class="header-anchor" href="#setting-up-the-backends-prometheus-victoria-logs" aria-label="Permalink to &quot;Setting Up the Backends (prometheus, victoria-logs)&quot;">​</a></h2><p>Setting up the backends is a straightforward process. We will use plain resource manifests for illustration purposes, outlining the important parts allowing OpenTelemetry collectors to connect securely to the backends using mTLS. An important part is enabling the respective <code>OTLP</code> ingestion endpoints on the backends, which will be used by the OpenTelemetry collectors to send telemetry data. In a production environment, the lifecycle of the backends will be probably managed by the respective component&#39;s operators</p><h3 id="setting-up-prometheus-metrics-backend" tabindex="-1">Setting Up Prometheus (Metrics Backend) <a class="header-anchor" href="#setting-up-prometheus-metrics-backend" aria-label="Permalink to &quot;Setting Up Prometheus (Metrics Backend)&quot;">​</a></h3><p>Here is the complete list of manifests for deploying a single prometheus instance with the <code>OTLP</code> ingestion endpoint and a <code>kube-rbac-proxy</code> sidecar for mTLS authentication and authorization:</p><ul><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-prometheus/certificate.yaml" target="_blank" rel="noreferrer">Prometheus Certificate</a> That is the serving certificate of the <code>kube-rbac-proxy</code> sidecar. The OpenTelemetry collector needs to trust the signing CA, hence we use the same <code>Issuer</code> we created earlier.</p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-prometheus/prometheus.yaml" target="_blank" rel="noreferrer">Prometheus</a> The prometheus needs to be configured to allow <code>OTLP</code> ingestion endpoint: <a href="https://prometheus.io/docs/guides/opentelemetry/#enable-the-OTLP-receiver" target="_blank" rel="noreferrer"><code>--web.enable-OTLP-receiver</code></a>. That allows the OpenTelemetry collector to push metrics to the Prometheus instance (via the <code>kube-rbac-proxy</code> sidecar).</p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-prometheus/prometheus-config.yml" target="_blank" rel="noreferrer">Prometheus Configuration</a> In Prometheus&#39; case, the <code>OpenTelemetry</code> resource attributes usually set by the collectors can be used to determine labels for the metrics. This is illustrated in the collector&#39;s <code>prometheus</code> receiver configuration. A common and unified set of labels across all metrics collected by the OpenTelemetry collector is a fundamental requirement for sharing and understanding the data across different teams and systems. This common set is defined by the <a href="https://opentelemetry.io/docs/specs/semconv/" target="_blank" rel="noreferrer">OpenTelemetry Semantic Conventions</a> specification. For example ,<code>k8s.pod.name</code>, <code>k8s.namespace.name</code>, <code>k8s.node.name</code>, etc. are some of the common labels that can be used to identify the source of the observability signals. Those are also common across the different types of telemetry data (traces, metrics, logs), serving correlation and analysis use cases.</p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-prometheus/mtls-rbac.yaml" target="_blank" rel="noreferrer">mTLS Proxy rbac</a> This example defines a <code>Role</code> allowing requests to the prometheus backend to pass the kube-rbac-proxy.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">rules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiGroups</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;authorization.kubernetes.io&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  resources</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">observabilityapps/prometheus</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  verbs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;get&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;create&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># GET, POST</span></span></code></pre></div><p>In this example, we allow <code>GET</code> and <code>POST</code> requests to reach the prometheus upstream service, if the request is authenticated with a valid mTLS certificate and the identified user is allowed to access the Prometheus service by the corresponding <code>RoleBinding</code>. <code>PATCH</code> and <code>DELETE</code> requests are not allowed. The mapping between the http request methods and the Kubernetes RBAC verbs is seen at <a href="https://github.com/brancz/kube-rbac-proxy/blob/8d0b850862fc4dac71a0e2cbd8a3c8a1c5fdc61a/pkg/proxy/proxy.go#L47" target="_blank" rel="noreferrer">kube-rbac-proxy/proxy.go</a>.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">subjects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiGroup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">User</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">client</span></span></code></pre></div></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-prometheus/mtls-ra.yml" target="_blank" rel="noreferrer">mTLS Proxy resource-attributes</a><code>kube-rbac-proxy</code> creates Kubernetes <code>SubjectAccessReview</code> to determine if the request is allowed to pass. The <code>SubjectAccessReview</code> is created with the <code>resourceAttributes</code> set to the upstream service, in this case the Prometheus service.</p></li></ul><h3 id="setting-up-victoria-logs-logs-backend" tabindex="-1">Setting Up victoria-logs (Logs Backend) <a class="header-anchor" href="#setting-up-victoria-logs-logs-backend" aria-label="Permalink to &quot;Setting Up victoria-logs (Logs Backend)&quot;">​</a></h3><p>In our example, we will use <a href="https://docs.victoriametrics.com/victorialogs/" target="_blank" rel="noreferrer">victoria-logs</a> as the logs backend. victoria-logs is a high-performance, cost-effective, and scalable log management solution. It is designed to work seamlessly with Kubernetes and provides powerful querying capabilities. It is important to note that any <code>OTLP</code> compatible backend can be used as a logs backend, allowing flexibility in choosing the best tool for the concrete needs.</p><p>Here is the complete manifests for deploying a single <code>victoria-logs</code> instance with the <code>OTLP</code> ingestion endpoint enabled and <code>kube-rbac-proxy</code> sidecar for mTLS authentication and authorization, using the upstream helm chart:</p><ul><li><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-VictoriaLogs/certificate.yaml" target="_blank" rel="noreferrer">Victoria-Logs Certificate</a> That is the serving certificate of the <code>kube-rbac-proxy</code> sidecar. The OpenTelemetry collector needs to trust the signing CA hence we use the same <code>Issuer</code> we created earlier.</li><li><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-victorialogs/values.yaml" target="_blank" rel="noreferrer">Victoria-Logs chart values</a> The certificate secret shall be mounted in the VictoriaLogs pod as a volume, as it is referenced by the <code>kube-rbac-proxy</code> sidecar.</li><li><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-victorialogs/mtls-rbac.yaml" target="_blank" rel="noreferrer">Victoria-Logs mTLS Proxy rbac</a> There is no fundamental difference compared to how we configured the Prometheus mTLS proxy. The <code>Role</code> allows requests to the VictoriaLogs backend to pass the kube-rbac-proxy.</li><li><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-victorialogs/mtls-ra.yml" target="_blank" rel="noreferrer">Victoria-Logs mTLS Proxy resource-attributes</a></li></ul><p>By now we shall have a working Prometheus and victoria-logs backends, both secured with mTLS and ready to accept telemetry data from the OpenTelemetry collector.</p><h3 id="setting-up-the-opentelemetry-collectors" tabindex="-1">Setting Up the OpenTelemetry Collectors <a class="header-anchor" href="#setting-up-the-opentelemetry-collectors" aria-label="Permalink to &quot;Setting Up the OpenTelemetry Collectors&quot;">​</a></h3><p>We are going to deploy two OpenTelemetry collectors: <code>k8s-events</code> and <code>shoot-metrics</code>. Both collectors will emit their own telemetry data in addition to the data collected from the respective receivers.</p><h4 id="k8s-events-collector" tabindex="-1"><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/k8s-events-otel.yaml" target="_blank" rel="noreferrer">k8s-events</a> collector <a class="header-anchor" href="#k8s-events-collector" aria-label="Permalink to &quot;[k8s-events](https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/k8s-events-otel.yaml) collector&quot;">​</a></h4><p>In this example, we use 2 receivers:</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/k8seventsreceiver" target="_blank" rel="noreferrer">k8s_events receiver</a> to collect Kubernetes events from the cluster.</li><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/k8sclusterreceiver" target="_blank" rel="noreferrer">k8s_cluster receiver</a> to collect Kubernetes cluster metrics.</li></ul><p>Here is an example of Kubernetes events persited in the <code>victoria-logs</code> backend. It filters logs which represents events from <code>kube-system</code> namesapce related to a rollout restart of the target statefulset. Then it formats the UI to show the event reason and object name. <img src="`+r+`" alt="otel-victoria-logs"></p><p>The collector features few important configurations related to reliability and performance. The collected metrics points are are sent in batches to the Prometheus backend using the corresponding OTLP exporter and the memory consumption of the collector is also limited. In general, it is always a good practice to set a memory limiter and batch processing in the collector pipeline.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">processors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  memory_limiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    check_interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1s</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    limit_percentage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    spike_limit_percentage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  batch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">5s</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    send_batch_size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span></span></code></pre></div><p>Allowing the collector to emit its own telemetry data is configured in the service section of the collector configuration.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Configure the collector own telemetry</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  telemetry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Emit collector logs to stdout, you can also push them to a backend.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    logs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      level</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">info</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      encoding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">console</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      output_paths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">stdout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      error_output_paths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">stderr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Push collector internal metrics to Prometheus</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    metrics</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      level</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">detailed</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      readers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># push metrics to Prometheus backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          periodic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30000</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10000</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            exporter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              OTLP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">                protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">http/protobuf</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">                endpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;\${env:PROMETHEUS_URL}/api/v1/OTLP/v1/metrics&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">                insecure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Ensure server certificate is validated against the CA</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">                certificate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/cert/ca.crt</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">                client_certificate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/cert/tls.crt</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">                client_key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/cert/tls.key</span></span></code></pre></div><p>The majority of the samples use an prometheus receiver to scrape the collector metrics endpoint, however that is not a clean solution because it puts the metrics via the pipeline, thus consuming resources and potentially causing performance issues. Instead, we use the <code>periodic</code> reader to push the metrics directly to the Prometheus backend.</p><p>Since the <code>k8s-events</code> collector obtains telemetry data from the kube-apiserver, it requires a corresponding set of permissions defined at <a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/k8s-events-rbac.yaml" target="_blank" rel="noreferrer">k8s-events rbac</a> manifests.</p><h4 id="shoot-metrics-collector" tabindex="-1"><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/shoot-metrics-otel.yaml" target="_blank" rel="noreferrer">shoot-metrics</a> collector <a class="header-anchor" href="#shoot-metrics-collector" aria-label="Permalink to &quot;[shoot-metrics](https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/shoot-metrics-otel.yaml) collector&quot;">​</a></h4><p>In this example, we have a single receiver:</p><ul><li><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/prometheusreceiver" target="_blank" rel="noreferrer">prometheus receiver</a> scraping metrics from Gardener managed exporters present in the shoot cluster, including the <code>kubelet</code> system service metrics. This receiver accepts standard Prometheus scrape configurations using <code>kubernetes_sd_configs</code> to discover the targets dynamically. The <code>kubernetes_sd_configs</code> allows the receiver to discover Kubernetes resources such as pods, nodes, and services, and scrape their metrics endpoints.</li></ul><p>Here, the example illustrates the <code>prometheus</code> receiver scraping metrics from the <code>kubelet</code> service, adding node kubernetes labels as labels to the scraped metrics and filtering the metrics to keep only the relevant ones. Since the kubelet metrics endpoint is secured, it needs the corresponding bearer token to be provided in the scrape configuration. The bearer token is automatically mounted in the pod by Kubernetes, allowing the OpenTelemetry collector to authenticate with the kubelet service.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">job_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot-kube-kubelet</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  honor_labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  scheme</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  tls_config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    insecure_skip_verify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  metrics_path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/metrics</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  bearer_token_file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  kubernetes_sd_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">role</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">node</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  relabel_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">source_labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">job</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      target_label</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">__tmp_prometheus_job_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">target_label</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">job</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      replacement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kube-kubelet</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">replace</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">target_label</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">type</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      replacement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">replace</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">source_labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">__meta_kubernetes_node_address_InternalIP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      target_label</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">instance</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">replace</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">regex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">__meta_kubernetes_node_label_(.+)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">labelmap</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      replacement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;k8s_node_label_$\${1}&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  metric_relabel_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">source_labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">__name__</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      regex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">^(kubelet_running_pods|process_max_fds|process_open_fds|kubelet_volume_stats_available_bytes|kubelet_volume_stats_capacity_bytes|kubelet_volume_stats_used_bytes|kubelet_image_pull_duration_seconds_bucket|kubelet_image_pull_duration_seconds_sum|kubelet_image_pull_duration_seconds_count)$</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">keep</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">source_labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespace</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      regex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(^$|^kube-system$)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">keep</span></span></code></pre></div><p>The collector also illustrates collecting metrics from <code>cadvisor</code> endpoints and Gardener specific exporters such as <code>shoot-apiserver-proxy</code>, <code>shoot-coredns</code>, etc. The exporters usually reside in the <code>kube-system</code> namespace and are configured to expose metrics on a specific port.</p><p>Since we aimed at unified set of resources attribues accross all telemetry data, we can translate exporters metrics which do not conform the conventions in OpenTelemetry. Here is an example of translating the metrics, produced by the kubelet, to the OpenTelemetry conventions using the <code>transform/metrics</code> processor:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Convert Prometheus metrics names to OpenTelemetry metrics names</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">transform/metrics</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  error_mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ignore</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  metric_statements</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">datapoint</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      statements</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">set(attributes[&quot;k8s.container.name&quot;], attributes[&quot;container&quot;]) where attributes[&quot;container&quot;] != nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">delete_key(attributes, &quot;container&quot;) where attributes[&quot;container&quot;] != nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">set(attributes[&quot;k8s.pod.name&quot;], attributes[&quot;pod&quot;]) where attributes[&quot;pod&quot;] != nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">delete_key(attributes, &quot;pod&quot;) where attributes[&quot;pod&quot;] != nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">set(attributes[&quot;k8s.namespace.name&quot;], attributes[&quot;namespace&quot;]) where attributes[&quot;namespace&quot;] != nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">delete_key(attributes, &quot;namespace&quot;) where attributes[&quot;namespace&quot;] != nil</span></span></code></pre></div><p>Here is a visualization of <code>container_network_transmit_bytes_total</code> metric collected from the <code>cadvisor</code> endpoint of the <code>kubelet</code> service, showing the network traffic in bytes transmitted by the <code>vpn-shoot</code> containers. <img src="`+h+'" alt="otel-prometheus"></p><p>Similarly to the <code>k8s-events</code> collector, the <code>shoot-metrics</code> collector also emits its own telemetry data, including metrics and logs. The collector is configured to push its own metrics to the Prometheus backend using the <code>periodic</code> reader, avoiding the need for a separate Prometheus scrape configuration. It requires a corresponding set of permissions defined at <a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/shoot-metrics-rbac.yaml" target="_blank" rel="noreferrer">shoot-metrics rbac</a> manifest.</p><h2 id="summary" tabindex="-1">Summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;Summary&quot;">​</a></h2><p>In this blog post, we have explored how to set up an OpenTelemetry based observability stack on a Gardener Shoot Cluster. We have demonstrated how to deploy the OpenTelemetry Operator, configure the backends prometheus and victoria-logs), and deploy OpenTelemetry collectors to obtain telemetry data from the cluster. We have also discussed best practices for configuration, including security and performance considerations. In this blog we have shown the unified set of resource attributes that can be used to identify the source of the telemetry data, allowing correlation and analysis across different teams and systems. We have demonstrated how to transform metrics labels which do not conform to the OpenTelemetry conventions, achieving a unified set of labels across all telemetry data. Finally, we have illustrated how to securely connect the OpenTelemetry collectors to the backends using mTLS and <code>kube-rbac-proxy</code> for authentication and authorization.</p><p>We hope this guide will inspire you to get started with OpenTelemetry on a Gardener managed shoot cluster and equip you with ideas and best practices for building a powerful observability stack that meets your needs. For more information, please refer to the <a href="https://opentelemetry.io/docs/" target="_blank" rel="noreferrer">OpenTelemetry documentation</a> and the <a href="https://gardener.cloud/docs/" target="_blank" rel="noreferrer">Gardener documentation</a>.</p><h2 id="manifests-list" tabindex="-1">Manifests List <a class="header-anchor" href="#manifests-list" aria-label="Permalink to &quot;Manifests List&quot;">​</a></h2><ul><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-prometheus/certificate.yaml" target="_blank" rel="noreferrer">Prometheus certificate</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-prometheus/prometheus.yaml" target="_blank" rel="noreferrer">Prometheus workload</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-prometheus/prometheus-config.yml" target="_blank" rel="noreferrer">Prometheus configuration</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-prometheus/mtls-rbac.yaml" target="_blank" rel="noreferrer">Prometheus mTLS proxy rbac</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-prometheus/mtls-ra.yml" target="_blank" rel="noreferrer">Prometheus mTLS proxy resource-attributes</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-victorialogs/certificate.yaml" target="_blank" rel="noreferrer">Victoria-Logs certificate</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-victorialogs/values.yaml" target="_blank" rel="noreferrer">Victoria-Logs helm chart values</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-victorialogs/mtls-rbac.yaml" target="_blank" rel="noreferrer">Victoria-Logs mTLS proxy rbac</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-victorialogs/mtls-ra.yml" target="_blank" rel="noreferrer">Victoria-Logs mTLS proxy resource-attributes</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/otel-certificate.yaml" target="_blank" rel="noreferrer">OpenTelemetry collectors client certificate</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/k8s-events-otel.yaml" target="_blank" rel="noreferrer">K8S-Events collector</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/k8s-events-rbac.yaml" target="_blank" rel="noreferrer">K8S-Events rbac</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/shoot-metrics-otel.yaml" target="_blank" rel="noreferrer">Shoot-Metrics collector</a></p></li><li><p><a href="https://github.com/gardener/documentation/blob/master/website/blog/2025/06/manifests/otel-collectors/shoot-metrics-rbac.yaml" target="_blank" rel="noreferrer">Shoot-Metrics rbac</a></p></li></ul>',59)]))}const y=s(o,[["render",p]]);export{u as __pageData,y as default};

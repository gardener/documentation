import{_ as t,c as a,o as i,a2 as o}from"./chunks/framework.Bfq10Vlj.js";const u=JSON.parse('{"title":"Dual-stack network migration","description":"Migrate IPv4 shoots to dual-stack IPv4,IPv6 network","frontmatter":{"aliases":["/docs/gardener/dual-stack-networking-migration/"],"description":"Migrate IPv4 shoots to dual-stack IPv4,IPv6 network","github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/usage/networking","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/networking/dual-stack-networking-migration.md","to":"dual-stack-networking-migration.md"},"persona":"Users","title":"Dual-stack network migration","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/networking/dual-stack-networking-migration/index.md","filePath":"docs/gardener/networking/dual-stack-networking-migration.md","lastUpdated":null}'),s={name:"docs/gardener/networking/dual-stack-networking-migration/index.md"};function n(r,e,l,d,c,p){return i(),a("div",null,e[0]||(e[0]=[o(`<h1 id="dual-stack-network-migration" tabindex="-1">Dual-Stack Network Migration <a class="header-anchor" href="#dual-stack-network-migration" aria-label="Permalink to &quot;Dual-Stack Network Migration&quot;">​</a></h1><p>This document provides a guide for migrating IPv4-only Gardener shoot clusters to dual-stack networking (IPv4 and IPv6).</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>Dual-stack networking allows clusters to operate with both IPv4 and IPv6 protocols. This configuration is controlled via the <code>spec.networking.ipFamilies</code> field, which accepts the following values:</p><ul><li><code>[IPv4]</code></li><li><code>[IPv6]</code></li><li><code>[IPv4, IPv6]</code></li><li><code>[IPv6, IPv4]</code></li></ul><h3 id="key-considerations" tabindex="-1">Key Considerations <a class="header-anchor" href="#key-considerations" aria-label="Permalink to &quot;Key Considerations&quot;">​</a></h3><ul><li>Single stack IPv4 clusters can be migrated to dual-stack by adding IPv6 as second element.</li><li>The migration of single stack IPv6 clusters to dual-stack is not supported.</li><li>A dual-stack cluster cannot be migrated to single-stack. Migration from single-stack to dual-stack is a one-way process and cannot be undone.</li><li>Migration involves multiple reconciliation runs to ensure a smooth transition without disruptions.</li></ul><h2 id="preconditions" tabindex="-1">Preconditions <a class="header-anchor" href="#preconditions" aria-label="Permalink to &quot;Preconditions&quot;">​</a></h2><p>Gardener supports multiple different network configurations, including running with pod overlay network or native routing. Currently, there is only native routing as supported operating mode for dual-stack networking in Gardener. This means that the pod overlay network needs to be disabled before starting the dual-stack migration. Otherwise, pod-to-pod cross-node communication may not work as expected after the migration.</p><p>At the moment, this only affects IPv4-only clusters, which should be migrated to dual-stack networking. IPv6-only clusters always use native routing.</p><p>You can check whether your cluster uses overlay network or native routing by looking for <code>spec.networking.providerConfig.overlay.enabled</code> in your cluster&#39;s manifest. If it is set to <code>true</code> or not present, the cluster is using the pod overlay network. If it is set to <code>false</code>, the cluster is using native routing.</p><p>Please note that there are infrastructure-specific limitations with regards to cluster size due to one route being added per node. Therefore, please consult the documentation of your infrastructure if your cluster should grow beyond 50 nodes and adapt the route limit quotas accordingly before switching to native routing.</p><p>To disable the pod overlay network and thereby switch to native routing, adjust your cluster specification as follows:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  networking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    providerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      overlay</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span></code></pre></div><h2 id="migration-process" tabindex="-1">Migration Process <a class="header-anchor" href="#migration-process" aria-label="Permalink to &quot;Migration Process&quot;">​</a></h2><p>The migration process should usually take place during the corresponding shoot maintenance time window. If you wish to run the migration process earlier, then you need to roll the nodes yourself and then trigger a reconcile so that the status of the <code>DualStackNodesMigrationReady</code> constraint is set to <code>true</code>. Once this is the case a new reconcile needs to be triggered to update the final components as described in step 5.</p><p>To help with manual rollout, Gardener provides a way to trigger the rollout per worker pool rollout by annotating the <code>Shoot</code> with the <code>rollout-workers</code> operation annotation and specifying which pool names you&#39;d like to be rolled out:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>kubectl -n &lt;shoot-namespace&gt; annotate shoot &lt;shoot-name&gt; gardener.cloud/operation=rollout-workers=&lt;pool1-name&gt;[,&lt;pool2-name&gt;,...]</span></span></code></pre></div><p>For more information, please refer to the <a href="/docs/gardener/shoot-operations/worker_pool_manual_rollout/">manual worker pool rollout</a> documentation.</p><h3 id="step-1-update-networking-configuration" tabindex="-1">Step 1: Update Networking Configuration <a class="header-anchor" href="#step-1-update-networking-configuration" aria-label="Permalink to &quot;Step 1: Update Networking Configuration&quot;">​</a></h3><p>Modify the <code>spec.networking.ipFamilies</code> field to include the desired dual-stack configuration. For example, change <code>[IPv4]</code> to <code>[IPv4, IPv6]</code>.</p><h3 id="step-2-infrastructure-reconciliation" tabindex="-1">Step 2: Infrastructure Reconciliation <a class="header-anchor" href="#step-2-infrastructure-reconciliation" aria-label="Permalink to &quot;Step 2: Infrastructure Reconciliation&quot;">​</a></h3><p>Changing the <code>ipFamilies</code> field triggers an infrastructure reconciliation. This step applies necessary changes to the underlying infrastructure to support dual-stack networking.</p><h3 id="step-3-control-plane-updates" tabindex="-1">Step 3: Control Plane Updates <a class="header-anchor" href="#step-3-control-plane-updates" aria-label="Permalink to &quot;Step 3: Control Plane Updates&quot;">​</a></h3><p>Depending on the infrastructure, control plane components will be updated or reconfigured to support dual-stack networking.</p><h3 id="step-4-node-rollout" tabindex="-1">Step 4: Node Rollout <a class="header-anchor" href="#step-4-node-rollout" aria-label="Permalink to &quot;Step 4: Node Rollout&quot;">​</a></h3><p>Nodes must support the new network protocol. However, node rollout is a manual step and is not triggered automatically. It should be performed during a maintenance window to minimize disruptions. Over time, this step may occur automatically, for example, during Kubernetes minor version updates that involve node replacements.</p><p>Cluster owners can monitor the progress of this step by checking the <code>DualStackNodesMigrationReady</code> constraint in the shoot status. During shoot reconciliation, the system verifies if all nodes support dual-stack networking and updates the migration state accordingly.</p><h3 id="step-5-control-plane-and-cni-configuration" tabindex="-1">Step 5: Control Plane and CNI Configuration <a class="header-anchor" href="#step-5-control-plane-and-cni-configuration" aria-label="Permalink to &quot;Step 5: Control Plane and CNI Configuration&quot;">​</a></h3><p>Once all nodes are migrated, the remaining control plane components and the Container Network Interface (CNI) are configured for dual-stack networking. The nodes migration constraint is removed at the end of this step and the constraint <code>DNSServiceMigrationReady</code> is added with status <code>progressing</code>.</p><h3 id="step-6-restart-of-coredns-pods" tabindex="-1">Step 6: Restart of CoreDNS Pods <a class="header-anchor" href="#step-6-restart-of-coredns-pods" aria-label="Permalink to &quot;Step 6: Restart of CoreDNS Pods&quot;">​</a></h3><p>With the next reconciliation, CoreDNS pods are restarted to obtain IPv6 addresses. The constraint <code>DNSServiceMigrationReady</code> is set to status <code>true</code> once all pods have both IPv4 and IPv6 addresses.</p><h3 id="step-7-switch-service-kube-dns-to-dual-stack" tabindex="-1">Step 7: Switch Service <code>kube-dns</code> to Dual-Stack <a class="header-anchor" href="#step-7-switch-service-kube-dns-to-dual-stack" aria-label="Permalink to &quot;Step 7: Switch Service \`kube-dns\` to Dual-Stack&quot;">​</a></h3><p>When all CoreDNS pods have IPv6 addresses, the <code>kube-dns</code> service will be configured as a dual-stack service with both IPv4 and IPv6 cluster IPs and the constraint <code>DNSServiceMigrationReady</code> will be removed.</p><h2 id="post-migration-behavior" tabindex="-1">Post-Migration Behavior <a class="header-anchor" href="#post-migration-behavior" aria-label="Permalink to &quot;Post-Migration Behavior&quot;">​</a></h2><p>After completing the migration:</p><ul><li>The shoot cluster supports dual-stack networking.</li><li>The <code>kube-dns</code> service operates with both IPv4 and IPv6 cluster IPs.</li><li>CoreDNS pods handle DNS queries for both address families.</li><li>New pods will receive IP addresses from both address families.</li><li>Existing pods will only receive a second IP address upon recreation.</li><li>If full dual-stack networking is required, all pods need to be rolled.</li><li>Existing services remain IPv4-only until recreated with dual-stack configuration.</li></ul><h1 id="migrate-from-dual-stack-to-single-stack-ipv4" tabindex="-1">Migrate from Dual-Stack to Single-Stack IPv4 <a class="header-anchor" href="#migrate-from-dual-stack-to-single-stack-ipv4" aria-label="Permalink to &quot;Migrate from Dual-Stack to Single-Stack IPv4&quot;">​</a></h1><p>In general, it should not be necessary to migrate from dual-stack to single-stack IPv4. However, if unforeseen problems arise, clusters can be migrated back to single-stack networking. This migration is possible even if the original dual-stack migration is not fully completed.</p><h2 id="important-considerations" tabindex="-1">Important Considerations <a class="header-anchor" href="#important-considerations" aria-label="Permalink to &quot;Important Considerations&quot;">​</a></h2><p><strong>⚠️ Partial Reversibility</strong>: The migration back to single-stack is not a complete reversal of the dual-stack migration:</p><ul><li><strong>Infrastructure remnants</strong>: Not all infrastructure changes can be reverted. IPv6 addresses will still be present in the shoot status, representing IPv6 addresses of infrastructure resources that were created during the dual-stack migration.</li><li><strong>Pod range assignment</strong>: Depending on the infrastructure provider, the method for pod range assignment may differ compared to IPv4 shoots that were never migrated to dual-stack.</li></ul><h2 id="migration-process-1" tabindex="-1">Migration Process <a class="header-anchor" href="#migration-process-1" aria-label="Permalink to &quot;Migration Process&quot;">​</a></h2><p>The migration back to single-stack follows a similar pattern to the dual-stack migration but in reverse:</p><h3 id="step-1-update-networking-configuration-1" tabindex="-1">Step 1: Update Networking Configuration <a class="header-anchor" href="#step-1-update-networking-configuration-1" aria-label="Permalink to &quot;Step 1: Update Networking Configuration&quot;">​</a></h3><p>Remove IPv6 from the <code>spec.networking.ipFamilies</code> field. Change the configuration from <code>[IPv4, IPv6]</code> back to <code>[IPv4]</code>.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  networking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ipFamilies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">IPv4</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Remove IPv6 entry</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span></code></pre></div><p>The shoot will reconcile automatically after the configuration change. Control plane components will be reconfigured to IPv4 single-stack mode. During this step, the <code>DualStackNodesMigrationReady</code> constraint is set to <code>true</code>, indicating that nodes and pods still have IPv6 addresses but the control plane is ready for the migration.</p><h3 id="step-2-node-rollout" tabindex="-1">Step 2: Node Rollout <a class="header-anchor" href="#step-2-node-rollout" aria-label="Permalink to &quot;Step 2: Node Rollout&quot;">​</a></h3><p>After the control plane reconfiguration, all nodes must be rolled to remove IPv6 configuration and addresses.</p><p><strong>Note</strong>: Nodes and pods will continue to have IPv6 addresses until they are rolled/recreated.</p><p>After rolling all nodes, the <code>DualStackNodesMigrationReady</code> constraint will be removed automatically during the next reconciliation. At this point:</p><ul><li>All nodes will have only IPv4 addresses</li><li>All pods will have only IPv4 addresses</li><li>The cluster operates in single-stack IPv4 mode</li></ul><h2 id="post-migration-state" tabindex="-1">Post-Migration State <a class="header-anchor" href="#post-migration-state" aria-label="Permalink to &quot;Post-Migration State&quot;">​</a></h2><p>After completing the migration back to single-stack:</p><ul><li>The cluster operates with IPv4-only networking</li><li>New pods receive only IPv4 addresses</li><li>Services operate with IPv4 cluster IPs only</li><li>Some infrastructure resources may retain IPv6 addresses in their metadata (as noted in the considerations above)</li></ul>`,56)]))}const g=t(s,[["render",n]]);export{u as __pageData,g as default};

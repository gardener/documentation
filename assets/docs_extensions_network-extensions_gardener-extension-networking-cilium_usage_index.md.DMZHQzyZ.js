import{_ as s,c as i,o as a,a2 as n}from"./chunks/framework.Bfq10Vlj.js";const c=JSON.parse('{"title":"Usage","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener-extension-networking-cilium","github_subdir":"docs/usage","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/extensions/network-extensions/gardener-extension-networking-cilium/usage.md","to":"usage.md"},"persona":"Users","title":"Usage","prev":false,"next":false},"headers":[],"relativePath":"docs/extensions/network-extensions/gardener-extension-networking-cilium/usage/index.md","filePath":"docs/extensions/network-extensions/gardener-extension-networking-cilium/usage.md","lastUpdated":null}'),t={name:"docs/extensions/network-extensions/gardener-extension-networking-cilium/usage/index.md"};function l(o,e,h,p,r,d){return a(),i("div",null,e[0]||(e[0]=[n(`<h1 id="using-the-networking-cilium-extension-with-gardener-as-end-user" tabindex="-1">Using the Networking Cilium extension with Gardener as end-user <a class="header-anchor" href="#using-the-networking-cilium-extension-with-gardener-as-end-user" aria-label="Permalink to &quot;Using the Networking Cilium extension with Gardener as end-user&quot;">​</a></h1><p>The <a href="https://github.com/gardener/gardener/blob/master/example/90-shoot.yaml" target="_blank" rel="noreferrer"><code>core.gardener.cloud/v1beta1.Shoot</code> resource</a> declares a <code>networking</code> field that is meant to contain network-specific configuration.</p><p>In this document we are describing how this configuration looks like for Cilium and provide an example <code>Shoot</code> manifest with minimal configuration that you can use to create a cluster.</p><h2 id="cilium-hubble" tabindex="-1">Cilium Hubble <a class="header-anchor" href="#cilium-hubble" aria-label="Permalink to &quot;Cilium Hubble&quot;">​</a></h2><p>Hubble is a fully distributed networking and security observability platform build on top of Cilium and BPF. It is optional and is deployed to the cluster when enabled in the <code>NetworkConfig</code>. If the dashboard is not externally exposed</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>kubectl port-forward -n kube-system deployment/hubble-ui 8081</span></span></code></pre></div><p>can be used to acess it locally.</p><h2 id="example-networkingconfig-manifest" tabindex="-1">Example <code>NetworkingConfig</code> manifest <a class="header-anchor" href="#example-networkingconfig-manifest" aria-label="Permalink to &quot;Example \`NetworkingConfig\` manifest&quot;">​</a></h2><p>An example <code>NetworkingConfig</code> for the Cilium extension looks as follows:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cilium.networking.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">hubble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#debug: false</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#tunnel: vxlan</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#store: kubernetes</span></span></code></pre></div><h2 id="networkingconfig-options" tabindex="-1"><code>NetworkingConfig</code> options <a class="header-anchor" href="#networkingconfig-options" aria-label="Permalink to &quot;\`NetworkingConfig\` options&quot;">​</a></h2><p>The <code>hubble.enabled</code> field describes whether hubble should be deployed into the cluster or not (default).</p><p>The <code>debug</code> field describes whether you want to run cilium in debug mode or not (default), change this value to <code>true</code> to use debug mode.</p><p>The <code>tunnel</code> field describes the encapsulation mode for communication between nodes. Possible values are <code>vxlan</code> (default), <code>geneve</code> or <code>disabled</code>.</p><p>The <code>bpfSocketLBHostnsOnly.enabled</code> field describes whether socket LB will be skipped for services when inside a pod namespace (default), in favor of service LB at the pod interface. Socket LB is still used when in the host namespace. This feature is required when using cilium with a service mesh like istio or linkerd.</p><p>Setting the field <code>cni.exclusive</code> to <code>false</code> might be useful when additional plugins, such as Istio or Linkerd, wish to chain after Cilium. This action disables the default behavior of Cilium, which is to overwrite changes to the CNI configuration file.</p><p>The <code>egressGateway.enabled</code> field describes whether egress gateways are enabled or not (default). To use this feature kube-proxy must be disabled. This can be done with the following configuration in the Shoot:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  kubernetes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    kubeProxy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span></code></pre></div><p>The egress gateway feature is only supported in gardener with an overlay network (shoot.spec.networking.providerConfig.overlay.enabled: true) at the moment. This is due to the reason that bpf masquerading is required for the egress gateway feature. Once the overlay network is enabled <code>bpf.masquerade</code> is set to <code>true</code> in the cilium configmap.</p><p>The <code>snatToUpstreamDNS.enabled</code> field describes whether the traffic to the upstream dns server should be masqueraded or not (default). This is needed on some infrastructures where traffic to the dns server with the pod CIDR range is blocked.</p><p>The <code>policyAuditMode</code> field describes whether the <a href="https://docs.cilium.io/en/latest/security/policy-creation/#enable-policy-audit-mode-entire-daemon" target="_blank" rel="noreferrer">policy audit mode</a> is enabled for the entire Cilium Daemon or not (default). When enabled, this will log all dropped packets due to policy enforcement. It is useful for testing your network policies before enforcing them. Policy audit mode can be enabled on the shoot by adding the following configuration:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cilium.networking.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">policyAuditMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><blockquote><p>⚠️ When you have enabled the policy audit mode, network policies are NOT enforced but only observed. This means that traffic that would have been denied by a network policy is allowed, but logged as <code>AUDIT</code> in Hubble.</p></blockquote><h3 id="transparent-encryption" tabindex="-1">Transparent Encryption <a class="header-anchor" href="#transparent-encryption" aria-label="Permalink to &quot;Transparent Encryption&quot;">​</a></h3><p>It is possible to enable transparent encryption of Cilium-managed host traffic and traffic between Cilium-managed endpoint. Currently only <a href="https://docs.cilium.io/en/stable/security/network/encryption-wireguard/" target="_blank" rel="noreferrer">Wireguard encryption</a> is supported.</p><p>An example cilium networking configuration could look like this:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cilium.networking.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">encryption</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">wireguard</span></span></code></pre></div><p>You can enable the feature <a href="https://docs.cilium.io/en/stable/security/network/encryption-wireguard/#node-to-node-encryption-beta" target="_blank" rel="noreferrer"><code>node-to-node encryption</code></a> of cilium using the <code>nodeToNodeEnabled</code> field.</p><p>Find the API documentation for encryption <a href="https://github.com/gardener/gardener-extension-networking-cilium/blob/master/hack/api-reference/cilium.md#cilium.networking.extensions.gardener.cloud/v1alpha1.Encryption" target="_blank" rel="noreferrer">here</a></p><h2 id="example-shoot-manifest" tabindex="-1">Example <code>Shoot</code> manifest <a class="header-anchor" href="#example-shoot-manifest" aria-label="Permalink to &quot;Example \`Shoot\` manifest&quot;">​</a></h2><p>Please find below an example <code>Shoot</code> manifest with cilium networking configuration:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">aws-cilium</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-dev</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  networking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cilium</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    providerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cilium.networking.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      hubble</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    pods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">100.96.0.0/11</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    nodes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10.250.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">100.64.0.0/13</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span></code></pre></div><p>If you would like to see a provider specific shoot example, please check out the documentation of the well-known extensions. A list of them can be found <a href="https://github.com/gardener/gardener/tree/master/extensions#infrastructure-provider" target="_blank" rel="noreferrer">here</a>.</p><h2 id="high-availabilty" tabindex="-1">High Availabilty <a class="header-anchor" href="#high-availabilty" aria-label="Permalink to &quot;High Availabilty&quot;">​</a></h2><p>The cilium-operator operates in high availability (HA) mode when the worker group in the shoot specification is configured with a minimum of at least two nodes as shown in the following example:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>spec:</span></span>
<span class="line"><span>  provider:</span></span>
<span class="line"><span>    workers:</span></span>
<span class="line"><span>      - ...</span></span>
<span class="line"><span>        maximum: 5</span></span>
<span class="line"><span>        minimum: 2</span></span>
<span class="line"><span>...</span></span></code></pre></div><p>This setup prevents unnecessary node spin-ups and reduces the compute costs in single-node clusters.</p>`,37)]))}const g=s(t,[["render",l]]);export{c as __pageData,g as default};

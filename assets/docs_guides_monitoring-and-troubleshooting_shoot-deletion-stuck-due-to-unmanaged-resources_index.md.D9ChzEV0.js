import{_ as t,c as a,o as s,a2 as o}from"./chunks/framework.Bfq10Vlj.js";const h=JSON.parse('{"title":"Shoot Deletion Stuck Due to Unmanaged Resources","description":"Identifying, managing, and cleaning up unmanaged resources","frontmatter":{"category":"Debugging","description":"Identifying, managing, and cleaning up unmanaged resources","github_repo":"https://github.com/gardener/documentation","github_subdir":"website/documentation/guides/monitoring-and-troubleshooting","level":"intermediate","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/guides/monitoring-and-troubleshooting/shoot-deletion-stuck-due-to-unmanaged-resources.md","to":"shoot-deletion-stuck-due-to-unmanaged-resources.md"},"scope":"app-developer","title":"Shoot Deletion Stuck Due to Unmanaged Resources","prev":false,"next":false},"headers":[],"relativePath":"docs/guides/monitoring-and-troubleshooting/shoot-deletion-stuck-due-to-unmanaged-resources/index.md","filePath":"docs/guides/monitoring-and-troubleshooting/shoot-deletion-stuck-due-to-unmanaged-resources.md","lastUpdated":null}'),n={name:"docs/guides/monitoring-and-troubleshooting/shoot-deletion-stuck-due-to-unmanaged-resources/index.md"};function i(r,e,l,c,d,u){return s(),a("div",null,e[0]||(e[0]=[o(`<h1 id="shoot-deletion-stuck-due-to-unmanaged-resources" tabindex="-1">Shoot Deletion Stuck Due to Unmanaged Resources <a class="header-anchor" href="#shoot-deletion-stuck-due-to-unmanaged-resources" aria-label="Permalink to &quot;Shoot Deletion Stuck Due to Unmanaged Resources&quot;">​</a></h1><h2 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">​</a></h2><p>In cloud environments, particularly when using Kubernetes and related infrastructure, users often encounter challenges with unmanaged resources. These are resources that remain active or are not automatically cleaned up when a shoot is deleted. Unmanaged resources can lead to increased costs, security risks, and operational inefficiencies. This guide provides an overview of how to identify, manage, and clean up unmanaged resources effectively.</p><h2 id="understanding-unmanaged-resources" tabindex="-1">Understanding Unmanaged Resources <a class="header-anchor" href="#understanding-unmanaged-resources" aria-label="Permalink to &quot;Understanding Unmanaged Resources&quot;">​</a></h2><p>Unmanaged resources are cloud resources that are not automatically deleted or managed by Gardener. These can include:</p><ul><li><strong>Load Balancers</strong>: Often created by Kubernetes services, they may persist if not properly deleted.</li><li><strong>Security Groups</strong>: Used to control access to resources, they can remain if dependencies are not cleared.</li><li><strong>Subnets and Network Interfaces</strong>: Part of your network setup, these can be left behind if not explicitly deleted.</li><li><strong>Persistent Volumes</strong>: Storage resources that may not be deleted when a pod is terminated.</li></ul><h2 id="identifying-unmanaged-resources" tabindex="-1">Identifying Unmanaged Resources <a class="header-anchor" href="#identifying-unmanaged-resources" aria-label="Permalink to &quot;Identifying Unmanaged Resources&quot;">​</a></h2><ol><li><strong>Use Cloud Provider Tools</strong>: Utilize the cloud provider&#39;s console or CLI to list resources. For example, AWS CLI commands like <code>aws ec2 describe-instances</code> or <code>aws elbv2 describe-load-balancers</code> can help identify active resources.</li><li><strong>Kubernetes Tools</strong>: Use kubectl commands to list resources within your Kubernetes cluster. Commands like <code>kubectl get services</code> or <code>kubectl get pv</code> can help identify resources that may not be managed.</li><li><strong>Monitoring and Alerts</strong>: Set up monitoring and alerts to notify you of resources that remain active beyond their expected lifecycle.</li></ol><h2 id="examples-of-unmanaged-resources-blocking-deletion" tabindex="-1">Examples of Unmanaged Resources Blocking Deletion <a class="header-anchor" href="#examples-of-unmanaged-resources-blocking-deletion" aria-label="Permalink to &quot;Examples of Unmanaged Resources Blocking Deletion&quot;">​</a></h2><h3 id="case-1-shoot-stuck-due-to-resources-in-kube-system" tabindex="-1">Case 1: Shoot Stuck Due to Resources in kube-system <a class="header-anchor" href="#case-1-shoot-stuck-due-to-resources-in-kube-system" aria-label="Permalink to &quot;Case 1: Shoot Stuck Due to Resources in kube-system&quot;">​</a></h3><p>Your shoot reports a message of the type:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Could not clean all old resources: 1 error occurred: deletion of old resource &quot;v1/Service/kube-system/addons-nginx-ingress-controller&quot; is still pending</span></span></code></pre></div><ol><li><strong>Check Resource Status</strong>: Use kubectl to check the status of the resource. You can do this by running:</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>kubectl get service addons-nginx-ingress-controller -n kube-system -o yaml</span></span></code></pre></div><p>Look for any finalizers or conditions that might be preventing the deletion.</p><ol start="2"><li><strong>Remove Finalizers</strong>: If the resource has custom finalizers (i.e. not gardener specific, but customer own finalizers) that are preventing its deletion, you can remove them manually. Edit the resource to remove the finalizers:</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>kubectl edit service addons-nginx-ingress-controller -n kube-system</span></span></code></pre></div><p>Remove the finalizers section from the YAML and save the changes.</p><ol start="3"><li><p><strong>Check for Dependencies</strong>: Ensure there are no other resources or dependencies that might be preventing the deletion. This could include other services, endpoints or configurations that depend on the service.</p></li><li><p><strong>Retry Deletion</strong>: After addressing any issues, retry the deletion process.</p></li></ol><h3 id="case-2-shoot-stuck-due-to-openstack-networks" tabindex="-1">Case 2: Shoot Stuck Due to OpenStack Networks <a class="header-anchor" href="#case-2-shoot-stuck-due-to-openstack-networks" aria-label="Permalink to &quot;Case 2: Shoot Stuck Due to OpenStack Networks&quot;">​</a></h3><p>Your shoot reports a message of the type:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>failed to &quot;delete network&quot;: Expected HTTP response code [202 204] when accessing [DELETE https://network.example.com/v2.0/networks/387c61df-2f17-4e8b-a18d-7571078c78c2], but got 500 instead: {&quot;NeutronError&quot;: {&quot;type&quot;: &quot;HTTPInternalServerError&quot;, &quot;message&quot;: &quot;Request Failed: internal server error while processing your request.&quot;, &quot;detail&quot;: &quot;&quot;}}</span></span></code></pre></div><ol><li><p><strong>Retry the Operation</strong>: Sometimes, transient issues can cause a 500 error. Wait a few minutes and try the deletion operation again.</p></li><li><p><strong>Check for Dependencies</strong>: Ensure that there are no resources still attached to the network, such as instances, routers or subnets. These dependencies can prevent the network from being deleted. Use the cloud provider&#39;s console or CLI to list and detach any dependent resources.</p></li><li><p><strong>Contact Cloud Provider Support</strong>: Since this is an internal server error, it may require intervention from the cloud provider&#39;s support team. Provide them with the error message and any relevant details to help them diagnose the issue.</p></li><li><p><strong>Check for Known Issues</strong>: Look for any announcements or known issues from the cloud provider that might be related to network operations in your region.</p></li></ol><p>When dealing with network deletion problems in OpenStack, you can use various commands to debug and identify the issues. Here are some useful OpenStack CLI commands to help you troubleshoot network deletion problems:</p><h4 id="_1-list-networks" tabindex="-1">1. List Networks <a class="header-anchor" href="#_1-list-networks" aria-label="Permalink to &quot;1. List Networks&quot;">​</a></h4><p>To see all networks and their details, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>openstack network list</span></span></code></pre></div><p>This command will show you all the networks in your OpenStack environment, including their IDs and statuses.</p><h4 id="_2-show-network-details" tabindex="-1">2. Show Network Details <a class="header-anchor" href="#_2-show-network-details" aria-label="Permalink to &quot;2. Show Network Details&quot;">​</a></h4><p>To get detailed information about a specific network, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>openstack network show &lt;network-id&gt;</span></span></code></pre></div><p>Replace &quot;&lt; network-id &gt; &quot; with the ID of the network you are trying to delete. This will provide information about the network&#39;s configuration and any resources associated with it.</p><h4 id="_3-list-subnets" tabindex="-1">3. List Subnets <a class="header-anchor" href="#_3-list-subnets" aria-label="Permalink to &quot;3. List Subnets&quot;">​</a></h4><p>To check if there are any subnets associated with the network, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>openstack subnet list --network &lt;network-id&gt;</span></span></code></pre></div><p>This will list all subnets associated with the specified network.</p><h4 id="_4-show-subnet-details" tabindex="-1">4. Show Subnet Details <a class="header-anchor" href="#_4-show-subnet-details" aria-label="Permalink to &quot;4. Show Subnet Details&quot;">​</a></h4><p>To get detailed information about a specific subnet, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>openstack subnet show &lt;subnet-id&gt;</span></span></code></pre></div><p>Replace <code>&lt; subnet-id &gt;</code> with the ID of the subnet you want to inspect.</p><h4 id="_5-list-ports" tabindex="-1">5. List Ports <a class="header-anchor" href="#_5-list-ports" aria-label="Permalink to &quot;5. List Ports&quot;">​</a></h4><p>To find out if there are any ports still attached to the network, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>openstack port list --network &lt;network-id&gt;</span></span></code></pre></div><p>This command will list all ports associated with the network, which might prevent its deletion.</p><h4 id="_6-show-port-details" tabindex="-1">6. Show Port Details <a class="header-anchor" href="#_6-show-port-details" aria-label="Permalink to &quot;6. Show Port Details&quot;">​</a></h4><p>To get detailed information about a specific port, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>openstack port show &lt;port-id&gt;</span></span></code></pre></div><p>Replace <code>&lt; port-id &gt;</code> with the ID of the port you want to inspect.</p><h4 id="_7-list-routers" tabindex="-1">7. List Routers <a class="header-anchor" href="#_7-list-routers" aria-label="Permalink to &quot;7. List Routers&quot;">​</a></h4><p>To check if there are any routers connected to the network, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>openstack router list</span></span></code></pre></div><p>This will list all routers in your environment. You can then check if any are connected to the network in question.</p><h4 id="_8-show-router-details" tabindex="-1">8. Show Router Details <a class="header-anchor" href="#_8-show-router-details" aria-label="Permalink to &quot;8. Show Router Details&quot;">​</a></h4><p>To get detailed information about a specific router, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>openstack router show &lt;router-id&gt;</span></span></code></pre></div><p>Replace <code>&lt; router-id &gt;</code> with the ID of the router you want to inspect.</p><h4 id="_9-check-for-floating-ips" tabindex="-1">9. Check for Floating IPs <a class="header-anchor" href="#_9-check-for-floating-ips" aria-label="Permalink to &quot;9. Check for Floating IPs&quot;">​</a></h4><p>To see if there are any floating IPs associated with the network, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>openstack floating ip list</span></span></code></pre></div><p>This will list all floating IPs, which might be associated with resources in the network.</p><h4 id="_10-delete-resources" tabindex="-1">10. Delete Resources <a class="header-anchor" href="#_10-delete-resources" aria-label="Permalink to &quot;10. Delete Resources&quot;">​</a></h4><p>Once you&#39;ve identified any resources that might be preventing the network deletion, use the appropriate openstack commands to delete them, such as:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>openstack port delete &lt;port-id&gt;</span></span>
<span class="line"><span>openstack subnet delete &lt;subnet-id&gt;</span></span>
<span class="line"><span>openstack router delete &lt;router-id&gt;</span></span></code></pre></div><h3 id="case-3-shoot-stuck-due-to-aws-loadbalancers" tabindex="-1">Case 3: Shoot Stuck Due to AWS LoadBalancers <a class="header-anchor" href="#case-3-shoot-stuck-due-to-aws-loadbalancers" aria-label="Permalink to &quot;Case 3: Shoot Stuck Due to AWS LoadBalancers&quot;">​</a></h3><p>Your shoot reports a message of the type:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Error deleting Infrastructure: 2 errors occurred:\\n\\t* failed to \\&quot;Destroying Kubernetes load balancers and security groups\\&quot;: failed to destroy load balancers and security groups: could not delete loadbalancer for arn arn:aws:elasticloadbalancing:eu-central-1:xxxxxxx:loadbalancer/net/some-load-balancer-name/d22d72f6f5563eff: operation error Elastic Load Balancing v2: DeleteLoadBalancer, https response error StatusCode: 400, RequestID: 9e0ad839-dc0d-4809-a6d6-1d8373ad8516, ResourceInUse: Load balancer &#39;arn:aws:elasticloadbalancing:eu-central-1:xxxxxxxxx:loadbalancer/net/some-load-balancer-name/d22d72f6f5563eff&#39; cannot be deleted because it is currently associated with another service\\n\\t* failed to \\&quot;delete zones resources\\&quot;: 2 errors occurred:\\n\\t* failed to \\&quot;delete subnet resource eu-central-1a-SubnetPublicUtility\\&quot;: operation error EC2: DeleteSubnet, context deadline exceeded\\n\\t* failed to \\&quot;delete subnet resource eu-central-1b-SubnetPublicUtility\\&quot;: operation error EC2: DeleteSubnet, context deadline exceeded\\n\\n\\n\\n&quot;</span></span></code></pre></div><h4 id="_1-load-balancer-deletion-issue" tabindex="-1">1. Load Balancer Deletion Issue <a class="header-anchor" href="#_1-load-balancer-deletion-issue" aria-label="Permalink to &quot;1. Load Balancer Deletion Issue&quot;">​</a></h4><ul><li><strong>Identify Associations</strong>: The load balancer is associated with another service, which is preventing its deletion. Use the AWS Management Console or CLI to identify what services or resources are using the load balancer. This could include target groups, listeners or other AWS services.</li><li><strong>Detach or Delete Associations</strong>: Once you identify the associations, detach or delete them. For example, if there are target groups or listeners associated with the load balancer, remove them.</li><li><strong>Check for Dependencies</strong>: Ensure that there are no other dependencies, such as DNS records or security groups, that might be linked to the load balancer.</li><li><strong>Retry Deletion</strong>: After removing all associations and dependencies, attempt to delete the load balancer again.</li></ul><h4 id="_2-subnet-deletion-timeout" tabindex="-1">2. Subnet Deletion Timeout <a class="header-anchor" href="#_2-subnet-deletion-timeout" aria-label="Permalink to &quot;2. Subnet Deletion Timeout&quot;">​</a></h4><ul><li><strong>Check for Resources in Subnets</strong>: Ensure there are no resources like EC2 instances, NAT gateways or network interfaces still using the subnets <code>eu-central-1a-SubnetPublicUtility</code> and <code>eu-central-1b-SubnetPublicUtility</code>. Use the AWS Console or CLI to list resources in these subnets.</li><li><strong>Delete or Reassign Resources</strong>: Delete or reassign any resources using the subnets. For example, terminate instances or detach network interfaces.</li></ul><h4 id="debug-commands" tabindex="-1">Debug Commands <a class="header-anchor" href="#debug-commands" aria-label="Permalink to &quot;Debug Commands&quot;">​</a></h4><p>When encountering issues with deleting a load balancer in AWS, you can use the AWS CLI to debug and identify the problems. Here are some useful commands to help you troubleshoot load balancer deletion issues:</p><h5 id="_1-list-load-balancers" tabindex="-1">1. List Load Balancers <a class="header-anchor" href="#_1-list-load-balancers" aria-label="Permalink to &quot;1. List Load Balancers&quot;">​</a></h5><p>To see all load balancers and their details, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>aws elbv2 describe-load-balancers</span></span></code></pre></div><p>This command will list all load balancers in your AWS account, including their ARNs and statuses.</p><h5 id="_2-describe-a-specific-load-balancer" tabindex="-1">2. Describe a Specific Load Balancer <a class="header-anchor" href="#_2-describe-a-specific-load-balancer" aria-label="Permalink to &quot;2. Describe a Specific Load Balancer&quot;">​</a></h5><p>To get detailed information about a specific load balancer, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>aws elbv2 describe-load-balancers --load-balancer-arns &lt;load-balancer-arn&gt;</span></span></code></pre></div><p>Replace <code>&lt; load-balancer-arn &gt;</code> with the ARN of the load balancer you are trying to delete. This will provide information about the load balancer&#39;s configuration and any resources associated with it.</p><h5 id="_3-list-target-groups" tabindex="-1">3. List Target Groups <a class="header-anchor" href="#_3-list-target-groups" aria-label="Permalink to &quot;3. List Target Groups&quot;">​</a></h5><p>To check if there are any target groups associated with the load balancer, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>aws elbv2 describe-target-groups --load-balancer-arn &lt;load-balancer-arn&gt;</span></span></code></pre></div><p>This will list all target groups associated with the specified load balancer.</p><h5 id="_4-describe-target-group-details" tabindex="-1">4. Describe Target Group Details <a class="header-anchor" href="#_4-describe-target-group-details" aria-label="Permalink to &quot;4. Describe Target Group Details&quot;">​</a></h5><p>To get detailed information about a specific target group, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>aws elbv2 describe-target-groups --target-group-arns &lt;target-group-arn&gt;</span></span></code></pre></div><p>Replace <code>&lt; target-group-arn &gt;</code> with the ARN of the target group you want to inspect.</p><h5 id="_5-list-listeners" tabindex="-1">5. List Listeners <a class="header-anchor" href="#_5-list-listeners" aria-label="Permalink to &quot;5. List Listeners&quot;">​</a></h5><p>To find out if there are any listeners still attached to the load balancer, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>aws elbv2 describe-listeners --load-balancer-arn &lt;load-balancer-arn&gt;</span></span></code></pre></div><p>This command will list all listeners associated with the load balancer, which might prevent its deletion.</p><h5 id="_6-describe-listener-details" tabindex="-1">6. Describe Listener Details <a class="header-anchor" href="#_6-describe-listener-details" aria-label="Permalink to &quot;6. Describe Listener Details&quot;">​</a></h5><p>To get detailed information about a specific listener, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>aws elbv2 describe-listeners --listener-arns &lt;listener-arn&gt;</span></span></code></pre></div><p>Replace <code>&lt; listener-arn &gt;</code> with the ARN of the listener you want to inspect.</p><h5 id="_7-check-for-security-groups" tabindex="-1">7. Check for Security Groups <a class="header-anchor" href="#_7-check-for-security-groups" aria-label="Permalink to &quot;7. Check for Security Groups&quot;">​</a></h5><p>To see if there are any security groups associated with the load balancer, use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>aws ec2 describe-security-groups --group-ids &lt;security-group-id&gt;</span></span></code></pre></div><p>Ensure that the security groups are not being used by other resources.</p><h5 id="_8-delete-resources" tabindex="-1">8. Delete Resources <a class="header-anchor" href="#_8-delete-resources" aria-label="Permalink to &quot;8. Delete Resources&quot;">​</a></h5><p>Once you&#39;ve identified any resources that might be preventing the load balancer deletion, use the appropriate aws commands to delete them, such as:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>aws elbv2 delete-listener --listener-arn &lt;listener-arn&gt;</span></span>
<span class="line"><span>aws elbv2 delete-target-group --target-group-arn &lt;target-group-arn&gt;</span></span></code></pre></div>`,103)]))}const g=t(n,[["render",i]]);export{h as __pageData,g as default};

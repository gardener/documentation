import{_ as o,c as t,o as c,a2 as r}from"./chunks/framework.Bfq10Vlj.js";const p=JSON.parse('{"title":"Etcd Cluster Resource Protection","description":"","frontmatter":{"github_repo":"https://github.com/gardener/etcd-druid","github_subdir":"docs/concepts","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/other-components/etcd-druid/concepts/etcd-cluster-resource-protection.md","to":"etcd-cluster-resource-protection.md"},"title":"Etcd Cluster Resource Protection","prev":false,"next":false},"headers":[],"relativePath":"docs/other-components/etcd-druid/concepts/etcd-cluster-resource-protection/index.md","filePath":"docs/other-components/etcd-druid/concepts/etcd-cluster-resource-protection.md","lastUpdated":null}'),n={name:"docs/other-components/etcd-druid/concepts/etcd-cluster-resource-protection/index.md"};function d(a,e,i,s,l,u){return c(),t("div",null,e[0]||(e[0]=[r('<h1 id="etcd-cluster-resource-protection" tabindex="-1">Etcd Cluster Resource Protection <a class="header-anchor" href="#etcd-cluster-resource-protection" aria-label="Permalink to &quot;Etcd Cluster Resource Protection&quot;">​</a></h1><p><code>etcd-druid</code> provisions and manages <a href="/docs/other-components/etcd-druid/concepts/etcd-cluster-components/">kubernetes resources (a.k.a components)</a> for each <code>Etcd</code> cluster. To ensure that each component&#39;s specification is in line with the configured attributes defined in <code>Etcd</code> custom resource and to protect unintended changes done to any of these <em>managed components</em> a <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noreferrer">Validating Webhook</a> is employed.</p><p><a href="https://github.com/gardener/etcd-druid/tree/55efca1c8f6c852b0a4e97f08488ffec2eed0e68/internal/webhook/etcdcomponents" target="_blank" rel="noreferrer">Etcd Components Webhook</a> is the <em>validating webhook</em> which prevents unintended <em>UPDATE</em> and <em>DELETE</em> operations on all managed resources. Following sections describe what is prohibited and in which specific conditions the changes are permitted.</p><h2 id="configure-etcd-components-webhook" tabindex="-1">Configure Etcd Components Webhook <a class="header-anchor" href="#configure-etcd-components-webhook" aria-label="Permalink to &quot;Configure Etcd Components Webhook&quot;">​</a></h2><p>Prerequisite to enable the validation webhook is to <a href="/docs/other-components/etcd-druid/deployment/configure-etcd-druid/#webhook-server">configure the Webhook Server</a>. Additionally you need to enable the <code>Etcd Components</code> validating webhook and optionally configure other options. You can look at all the options <a href="/docs/other-components/etcd-druid/deployment/configure-etcd-druid/#etcd-components-webhook">here</a>.</p><h2 id="what-is-allowed" tabindex="-1">What is allowed? <a class="header-anchor" href="#what-is-allowed" aria-label="Permalink to &quot;What is allowed?&quot;">​</a></h2><p>Modifications to managed resources under the following circumstances will be allowed:</p><ul><li><code>Create</code> and <code>Connect</code> operations are allowed and no validation is done.</li><li>Changes to a kubernetes resource (e.g. StatefulSet, ConfigMap etc) not managed by etcd-druid are allowed.</li><li>Changes to a resource whose Group-Kind is amongst the resources managed by etcd-druid but does not have a parent <code>Etcd</code> resource are allowed.</li><li>It is possible that an operator wishes to explicitly disable etcd-component protection. This can be done by setting <code>druid.gardener.cloud/disable-etcd-component-protection</code> annotation on an <code>Etcd</code> resource. If this annotation is present then changes to managed components will be allowed.</li><li>If <code>Etcd</code> resource has a deletion timestamp set indicating that it is marked for deletion and is awaiting etcd-druid to delete all managed resources then deletion requests for all managed resources for this etcd cluster will be allowed if: <ul><li>The deletion request has come from a <code>ServiceAccount</code> associated to etcd-druid. If not explicitly specified via <code>--reconciler-service-account</code> then a <a href="https://github.com/gardener/etcd-druid/blob/55efca1c8f6c852b0a4e97f08488ffec2eed0e68/internal/webhook/etcdcomponents/config.go#L23" target="_blank" rel="noreferrer">default-reconciler-service-account</a> will be assumed.</li><li>The deletion request has come from a <code>ServiceAccount</code> configured via <code>--etcd-components-webhook-exempt-service-accounts</code>.</li></ul></li><li><code>Lease</code> objects are periodically updated by each etcd member pod. A single <code>ServiceAccount</code> is created for all members. <code>Update</code> operation on <code>Lease</code> objects from <a href="https://github.com/gardener/etcd-druid/blob/55efca1c8f6c852b0a4e97f08488ffec2eed0e68/api/v1alpha1/helper.go#L28" target="_blank" rel="noreferrer">this ServiceAccount</a> is allowed.</li><li>If an active reconciliation is in-progress then only allow operations that are initiated by etcd-druid.</li><li>If no active reconciliation is currently in-progress, then allow updates to managed resource from <code>ServiceAccounts</code> configured via <code>--etcd-components-webhook-exempt-service-accounts</code>.</li></ul>',8)]))}const m=o(n,[["render",d]]);export{p as __pageData,m as default};

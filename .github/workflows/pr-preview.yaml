name: PR Preview

on:
  pull_request_target:
    types:
      - labeled
      - closed

permissions:
  id-token: write
  pull-requests: write

concurrency: preview-${{ github.ref }}

jobs:
  deploy-preview:
    if: ${{ github.event.action == 'labeled' && github.event.label.name == vars.DEFAULT_LABEL_OK_TO_TEST && vars.DEFAULT_LABEL_OK_TO_TEST != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: gardener/cc-utils/.github/actions/github-auth@master
        id: app-token
        with:
          token-server: ${{ vars.FEDERATED_GITHUB_ACCESS_TOKEN_SERVER }}
          permissions: |
            contents: write

      - name: Checkout
        uses: gardener/cc-utils/.github/actions/trusted-checkout@master

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Docforge
        run: |
          wget https://github.com/gardener/docforge/releases/download/v0.55.0/docforge-linux-amd64
          mv docforge-linux-amd64 docforge
          chmod +x docforge
          DOCFORGE_CONFIG=.docforge/config.yaml GITHUB_OAUTH_TOKEN=${{ steps.app-token.outputs.token }} ./docforge

      - name: Install dependencies
        run: npm ci

      - name: Postprocessing Content
        run: make post-process

      - name: Build with VitePress
        run: make build

      - name: Deploy to Netlify
        id: deploy
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          DEPLOY_OUTPUT=$(npx netlify-cli deploy \
            --dir=.vitepress/dist \
            --alias=pr-${{ github.event.pull_request.number }} \
            --json)
          echo "deploy_url=$(echo "$DEPLOY_OUTPUT" | jq -r '.deploy_url')" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `${{ steps.deploy.outputs.deploy_url }}`;
            const commentBody = `## ðŸš€ Preview Deployed\n\nYour preview is available at:\n${previewUrl}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Deployed')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

  cleanup-preview:
    if: ${{ github.event.action == 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - name: Delete Netlify preview deploys
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          DEPLOYS=$(curl -s \
            -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" \
            "https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID}/deploys?branch=pr-${PR_NUMBER}&per_page=100")

          echo "$DEPLOYS" | jq -r '.[].id' | while read DEPLOY_ID; do
            echo "Deleting deploy: $DEPLOY_ID"
            curl -s -X DELETE \
              -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" \
              "https://api.netlify.com/api/v1/deploys/${DEPLOY_ID}"
          done

      - name: Update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const commentBody = `## ðŸ§¹ Preview Removed\n\nThe preview for this PR is no longer available since the PR has been closed.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Deployed')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            }

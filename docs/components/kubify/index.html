
	<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <meta name="description" content="Documentation for Gardener">
<meta name="author" content="Andreas Herz">


<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700|Material+Icons" rel="stylesheet">

    <link rel="icon" type="image/x-icon"  href="images/favicon.ico">
<link rel="icon" type="image/png"     href="images/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png"     href="images/favicon-16x16.png" sizes="16x16" />

    <title>kubify :: Gardener Documentation</title>

    <link rel="icon" type="image/x-icon" href='https://gardener.github.io/website/images/favicon.ico'>
    <link rel="icon" type="image/png"    href='https://gardener.github.io/website/images/favicon-32x32.png' sizes="32x32">
    <link rel="icon" type="image/png"    href='https://gardener.github.io/website/images/favicon-16x16.png' sizes="16x16">

    
    <link href="/website/css/nucleus.css?1533730314" rel="stylesheet">
    <link href="/website/css/font-awesome.min.css?1533730314" rel="stylesheet">
    <link href="/website/css/hybrid.css?1533730314" rel="stylesheet">
    <link href="/website/css/featherlight.min.css?1533730314" rel="stylesheet">
    <link href="/website/css/perfect-scrollbar.min.css?1533730314" rel="stylesheet">
    <link href="/website/css/auto-complete.css?1533730314" rel="stylesheet">
    <link href="/website/css/skeleton.css?1533730314" rel="stylesheet">

    <script src="/website/js/moment.js?1533730314"></script>
    <script src="/website/js/vivus.js?1533730314"></script>
    <script src="/website/js/scrollreveal.js?1533730314"></script>
    <script src="/website/js/inlineSVG.js?1533730314"></script>
    <link href="/website/css/theme.css?1533730314" rel="stylesheet">
    <link href="/website/css/hugo-theme.css?1533730314" rel="stylesheet">


    
      <link href="/website/css/theme-gardener.css?1533730314" rel="stylesheet">
    

    <script src="/website/js/jquery-2.x.min.js?1533730314"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }

    </style>

    

  </head>


  <body class="" data-url="/website/components/kubify/">
    <nav id="sidebar" class="">

  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://gardener.github.io/website">

	<svg width="90px" height="90px" viewBox="0 0 90 90" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
		
		<title>logo</title>
		<defs>
			<path d="M41.8864954,0.994901575 C42.8830405,0.514990742 44.5028956,0.516982644 45.4953045,0.994901575 L76.8159138,16.0781121 C77.8124589,16.5580229 78.8208647,17.8257185 79.0659694,18.8995926 L86.8015211,52.7912589 C87.0476474,53.8696088 86.6852538,55.4484075 85.9984855,56.3095876 L64.3239514,83.4885938 C63.6343208,84.3533632 62.1740175,85.0543973 61.0725268,85.0543973 L26.3092731,85.0543973 C25.2031915,85.0543973 23.7446167,84.3497739 23.0578485,83.4885938 L1.38331434,56.3095876 C0.693683723,55.4448182 0.335174016,53.865133 0.580278769,52.7912589 L8.31583044,18.8995926 C8.56195675,17.8212428 9.57347722,16.556031 10.5658861,16.0781121 L41.8864954,0.994901575 Z" id="path-1"></path>
			<linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3">
				<stop stop-color="#FFFFFF" offset="0%"></stop>
				<stop stop-color="#439246" offset="100%"></stop>
			</linearGradient>
			<linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4">
				<stop stop-color="#FFFFFF" offset="0%"></stop>
				<stop stop-color="#439246" offset="100%"></stop>
			</linearGradient>
			<linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5">
				<stop stop-color="#FFFFFF" offset="0%"></stop>
				<stop stop-color="#439246" offset="100%"></stop>
			</linearGradient>
			<linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6">
				<stop stop-color="#FFFFFF" offset="0%"></stop>
				<stop stop-color="#439246" offset="100%"></stop>
			</linearGradient>
		</defs>
		<g id="logo" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
			<g id="Rectangle-2" transform="translate(1.000000, 0.000000)">
				<mask id="mask-2" fill="white">
					<use xlink:href="#path-1"></use>
				</mask>
				<use id="Mask" fill="#009F76" xlink:href="#path-1"></use>
				<polygon fill="#000000" opacity="0.289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"></polygon>
			</g>
			<path d="M56.8508631,39.260019 C56.4193519,40.443987 55.6088085,41.581593 54.6736295,42.1938694 L46.5997298,47.4799783 C45.2142627,48.3870654 42.9749783,48.3916494 41.5825097,47.4799783 L33.50861,42.1938694 C32.123143,41.2867823 31,39.206345 31,37.545932 L31,26.4150304 C31,25.6897174 31.2131118,24.884885 31.5692681,24.1324532 L56.8508631,39.260019 Z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233) "></path>
			<path d="M56.0774672,25.1412464 C56.4306829,25.8903325 56.6425556,26.6907345 56.6425556,27.4119019 L56.6425556,38.5428034 C56.6425556,40.2027013 55.5264141,42.2790698 54.1339456,43.1907408 L46.0600459,48.4768498 C44.6745788,49.3839368 42.4352943,49.3885208 41.0428258,48.4768498 L32.9689261,43.1907408 C32.2918101,42.7474223 31.6773514,42.0238435 31.2260376,41.206007 L56.0774672,25.1412464 Z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598) "></path>
			<path d="M65.0702134,57.1846889 C64.5985426,58.2007851 63.8367404,59.1236871 62.9788591,59.6189851 L47.37497,68.6278947 C45.9443535,69.4538615 43.6226022,69.4525546 42.1942494,68.6278947 L26.5903603,59.6189851 C25.1597438,58.7930183 24,56.7816693 24,55.1323495 L24,37.1145303 C24,36.3487436 24.249712,35.5060005 24.6599102,34.7400631 L65.0702134,57.1846889 Z" id="Combined-Shape" fill="url(#linearGradient-5)"></path>
			<path d="M65.0189476,34.954538 C65.3636909,35.6617313 65.5692194,36.42021 65.5692194,37.1145303 L65.5692194,55.1323495 C65.5692194,56.7842831 64.4072119,58.7943252 62.9788591,59.6189851 L47.37497,68.6278947 C45.9443535,69.4538615 43.6226022,69.4525546 42.1942494,68.6278947 L26.5903603,59.6189851 C25.9237304,59.2341061 25.3159155,58.5918431 24.8568495,57.8487596 L65.0189476,34.954538 Z" id="Combined-Shape" fill="url(#linearGradient-6)"></path>
		</g>
	</svg>
	<h1>Gardener</h1>
	<h2>The Kubernetes Botanist</h2>
</a>

    </div>
    <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/website/js/lunr.min.js?1533730314"></script>
<script type="text/javascript" src="/website/js/auto-complete.js?1533730314"></script>
<script type="text/javascript">
    
        var baseurl = '\/website';
    
</script>
<script type="text/javascript" src="/website/js/search.js?1533730314"></script>

  </div>


  <div class="highlightable">
      <ul class="topics">
            
                 
                 




  
    
    <li data-nav-id="/website/blog/" title="Whats New" class="dd-item
        
        
        
        ">
        
          <a href="/website/blog/">
              <i class="fa fa-rss "></i>
              Whats New
          </a>
          
          
      
    </li>
  


            
                 
                 




  
    
    <li data-nav-id="/website/about/" title="Getting Started" class="dd-item
        
        
        
        ">
        
          <a href="/website/about/">
              <i class="fa fa-circle-thin "></i>
              Getting Started
          </a>
          
          
      
    </li>
  


            
                 
                 




  
    
    <li data-nav-id="/website/030-architecture/" title="Architecture" class="dd-item
        parent
        
        
        ">
        
          <a href="/website/030-architecture/">
              <i class="fa fa-square-o "></i>
              Architecture
          </a>
          
          
            <ul>
              
              
                
              
              


              
                
                    




  
    
    <li data-nav-id="/website/components/gardner/" title="Gardener" class="dd-item
        
        
        
        ">
        
          <a href="/website/components/gardner/">
              <i class=" "></i>
              Gardener
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/components/gardenctl/" title="gardenctl" class="dd-item
        
        
        
        ">
        
          <a href="/website/components/gardenctl/">
              <i class=" "></i>
              gardenctl
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/components/mcm/" title="Machine Controller Manager" class="dd-item
        
        
        
        ">
        
          <a href="/website/components/mcm/">
              <i class=" "></i>
              Machine Controller Manager
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/components/dns-cm/" title="DNS Controller Manager" class="dd-item
        
        
        
        ">
        
          <a href="/website/components/dns-cm/">
              <i class=" "></i>
              DNS Controller Manager
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/components/dashboard/" title="Dashboard" class="dd-item
        
        
        
        ">
        
          <a href="/website/components/dashboard/">
              <i class=" "></i>
              Dashboard
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/components/kubify/" title="kubify" class="dd-item
        parent
        active
        
        ">
        
          <a href="/website/components/kubify/">
              <i class=" "></i>
              kubify
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/components/bouquet/" title="Bouquet" class="dd-item
        
        
        
        ">
        
          <a href="/website/components/bouquet/">
              <i class=" "></i>
              Bouquet
          </a>
          
          
      
    </li>
  


                
              

            </ul>
        
      
    </li>
  


            
                 
                 




  
    
    <li data-nav-id="/website/contribute/" title="Contribute" class="dd-item
        
        
        
        ">
        
          <a href="/website/contribute/">
              <i class="fa fa-plus-square-o "></i>
              Contribute
          </a>
          
          
            <ul>
              
              
                
              
              


              
                
                    




  
    
    <li data-nav-id="/website/contribute/code/" title="Code" class="dd-item
        
        
        
        ">
        
          <a href="/website/contribute/code/">
              <i class=" "></i>
              Code
          </a>
          
          
            <ul>
              
              
                
              
              


              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/10_code/10-contribution_guide/" title="Contribution Guide" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/10_code/10-contribution_guide/">
              <i class=" "></i>
              Contribution Guide
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/10_code/10_env/" title="Enviroment" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/10_code/10_env/">
              <i class=" "></i>
              Enviroment
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/10_code/15_conf_secrets/" title="Configuration and Secrets" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/10_code/15_conf_secrets/">
              <i class=" "></i>
              Configuration and Secrets
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/10_code/20_dependencies/" title="Dependencies" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/10_code/20_dependencies/">
              <i class=" "></i>
              Dependencies
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/development/usage/" title="Creating Shoots" class="dd-item
        
        
        
        ">
        
          <a href="/website/development/usage/">
              <i class=" "></i>
              Creating Shoots
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/10_code/27_deploy_into_cluster/" title="Deploy into a Cluster" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/10_code/27_deploy_into_cluster/">
              <i class=" "></i>
              Deploy into a Cluster
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/10_code/30_deploy_into_minikube/" title="Deploy into Minikube" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/10_code/30_deploy_into_minikube/">
              <i class=" "></i>
              Deploy into Minikube
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/10_code/30_deploy_seed_into_aks/" title="Deploy into AKS" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/10_code/30_deploy_seed_into_aks/">
              <i class=" "></i>
              Deploy into AKS
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/10_code/37_process/" title="Process" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/10_code/37_process/">
              <i class=" "></i>
              Process
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/10_code/40_repositories/" title="Repositories" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/10_code/40_repositories/">
              <i class=" "></i>
              Repositories
          </a>
          
          
      
    </li>
  


                
              

            </ul>
        
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/contribute/docs/" title="Documentation" class="dd-item
        
        
        
        ">
        
          <a href="/website/contribute/docs/">
              <i class=" "></i>
              Documentation
          </a>
          
          
            <ul>
              
              
                
              
              


              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/20_documentation/10_organisation/" title="Organisation" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/20_documentation/10_organisation/">
              <i class=" "></i>
              Organisation
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/20_documentation/20_style/" title="Style Guide" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/20_documentation/20_style/">
              <i class=" "></i>
              Style Guide
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/045_contribute/20_documentation/25_markup/" title="Markdown" class="dd-item
        
        
        
        ">
        
          <a href="/website/045_contribute/20_documentation/25_markup/">
              <i class=" "></i>
              Markdown
          </a>
          
          
            <ul>
              
              
              


              
                
                    




  
      <li data-nav-id="/website/045_contribute/20_documentation/25_markup/attachments/" title="Attachments" class="dd-item ">
        <a href="/website/045_contribute/20_documentation/25_markup/attachments/">
            Attachments
        </a>
    </li>
  


                
              
                
                    




  
      <li data-nav-id="/website/045_contribute/20_documentation/25_markup/button/" title="Button" class="dd-item ">
        <a href="/website/045_contribute/20_documentation/25_markup/button/">
            Button
        </a>
    </li>
  


                
              
                
                    




  
      <li data-nav-id="/website/045_contribute/20_documentation/25_markup/expand/" title="Expand" class="dd-item ">
        <a href="/website/045_contribute/20_documentation/25_markup/expand/">
            Expand
        </a>
    </li>
  


                
              
                
                    




  
      <li data-nav-id="/website/045_contribute/20_documentation/25_markup/mermaid/" title="Mermaid" class="dd-item ">
        <a href="/website/045_contribute/20_documentation/25_markup/mermaid/">
            Mermaid
        </a>
    </li>
  


                
              
                
                    




  
      <li data-nav-id="/website/045_contribute/20_documentation/25_markup/notice/" title="Notice" class="dd-item ">
        <a href="/website/045_contribute/20_documentation/25_markup/notice/">
            Notice
        </a>
    </li>
  


                
              

            </ul>
        
      
    </li>
  


                
              

            </ul>
        
      
    </li>
  


                
              

            </ul>
        
      
    </li>
  


            
                 
                 




  
    
    <li data-nav-id="/website/tutorials/" title="Tutorials" class="dd-item
        
        
        
        ">
        
          <a href="/website/tutorials/">
              <i class="fa fa-terminal "></i>
              Tutorials
          </a>
          
          
            <ul>
              
              
                
              
              


              
                
                    




  
    
    <li data-nav-id="/website/using-gardener/administrator/" title="Administrator" class="dd-item
        
        
        
        ">
        
          <a href="/website/using-gardener/administrator/">
              <i class=" "></i>
              Administrator
          </a>
          
          
      
    </li>
  


                
              
                
                    




  
    
    <li data-nav-id="/website/using-gardener/developer/topic/" title="App Developer" class="dd-item
        
        
        
        ">
        
          <a href="/website/using-gardener/developer/topic/">
              <i class=" "></i>
              App Developer
          </a>
          
          
      
    </li>
  


                
              
                
                
              

            </ul>
        
      
    </li>
  


            
                 
                 




  
    
    <li data-nav-id="/website/curated-links/" title="Curated Links" class="dd-item
        
        
        
        ">
        
          <a href="/website/curated-links/">
              <i class="fa fa-bookmark-o "></i>
              Curated Links
          </a>
          
          
      
    </li>
  


            
      </ul>
      <section id="footer">
        
<script async defer src="https://buttons.github.io/buttons.js"></script>

      </section>

  </div>
</nav>











        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable  body-inner-wrapper">

          <div>
              <div id="top-bar">
                
                    <div id="top-github-link">
                        <a class="github-link" title='Edit this page'
                        
                          href='https://github.com/gardener/kubify/edit/master/README.md'
                        
                         target="blank">
                        <i class="fa fa-code-fork"></i>
                          <span id="top-github-link-text">Edit this page</span>
                        </a>
                    </div>
                

                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                    <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                    <i class="fa fa-bars"></i>
                    </a>
                    </span>
                    
                    <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                    
                    <span class="links">
                        
            
            
              
              
            
            
              
              
            
            
              <a href='/website/'>Gardener</a> > <a href='/website/030-architecture/'>Architecture</a> > kubify
            
          
            
          
            
          
                    </span>
                </div>

                
                <div class="progress">
    <div class="wrapper">
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#terraform-template-to-setup-a-kubernetes-cluster-on-openstack-aws-azure">Terraform Template to Setup a Kubernetes Cluster on OpenStack/AWS/Azure</a>
<ul>
<li><a href="#cluster-environment">Cluster Environment</a>
<ul>
<li><a href="#bastion-and-node-access">Bastion and Node Access</a></li>
<li><a href="#bootstrapping">Bootstrapping</a></li>
<li><a href="#recovery">Recovery</a></li>
<li><a href="#etcd">ETCD</a></li>
<li><a href="#api-server">API Server</a></li>
<li><a href="#ingress">Ingress</a></li>
</ul></li>
<li><a href="#rolling-updates-of-nodes">Rolling updates of nodes.</a></li>
<li><a href="#setup-a-new-cluster">Setup a new cluster</a></li>
<li><a href="#helper-commands">Helper commands</a></li>
<li><a href="#quick-setup">Quick Setup</a></li>
<li><a href="#configuration-settings">Configuration Settings</a>
<ul>
<li><a href="#addons">Addons</a></li>
<li><a href="#general-settings">General settings</a></li>
<li><a href="#node-settings">Node settings</a></li>
<li><a href="#kubernetes-configuration">Kubernetes Configuration</a></li>
<li><a href="#vm-update">VM update</a></li>
<li><a href="#recovery-1">Recovery</a></li>
<li><a href="#component-versions">Component versions</a></li>
</ul></li>
<li><a href="#cluster-recovery">Cluster Recovery</a></li>
<li><a href="#migrating-to-new-versions-of-the-kubify-project">Migrating to new Versions of the Kubify Project</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
          </div>

          
              
              
              
              
              
              
              
              <div id="githubFactsheet">
                <span id="githubLink"><i class="fa fa-github"></i><a target="_blank" href="https://github.com/gardener/kubify/">https://github.com/gardener/kubify/</a></span>
                <a class="github-button" href="https://github.com/gardener" aria-label="Follow @gardener on GitHub">Follow @kubify/</a>
                <a class="github-button" href="https://github.com/gardener/kubify/" data-show-count="true" aria-label="Star gardener/gardener on GitHub">Star</a>
                <div class="tutorial-last-update">Updated <span>


   <span id="47acb12e3b72037b9dbf2ccf269124cc"></span>
   <script>$("#47acb12e3b72037b9dbf2ccf269124cc").html(moment("2018-05-23T20:21:54Z").fromNow())</script>


</span> by 


   

   

   

   

   

   

   

   

   

   

<a href='mailto:onur@yalazi.org'>Onur YALAZI</a>, <a href='mailto:uwe.krueger@sap.com'>Uwe Krueger</a>, <a href='mailto:vedran.lerenc@sap.com'>Vedran Lerenc</a>, <a href='mailto:andreas.fritzler@sap.com'>Andreas Fritzler</a>, <a href='mailto:gardener.opensource@sap.com'>Gardener Development Community</a>

</div>
              </div>
          

          <div id="body-inner">

          



<br>
<br>




<p><img align=right src="doc/kubify@2x.png" height="200"></p>

<h3 id="terraform-template-to-setup-a-kubernetes-cluster-on-openstack-aws-azure">Terraform Template to Setup a Kubernetes Cluster on OpenStack/AWS/Azure</h3>

<p>This project contains a <a href="https://raw.githubusercontent.com/gardener/kubify/master/doc/files.md">terraform environment</a> to setup a kubernetes
cluster in various IaaS environments. The following IaaS layers are supported yet:</p>

<ul>
<li>Openstack</li>
<li>AWS</li>
<li>Azure</li>
</ul>

<p>Kubify supports cluster setup, recovery from an etcd backup file and
rolling of cluster nodes. A cluster update is possible as long as the contained
components can just be redeployed and the update is done by a rolling update by the
kubernetes controllers. The update of the kubelets is supported without rolling the
nodes.</p>

<p>The target cluster can be enriched by a set of predefinied <a href="https://raw.githubusercontent.com/gardener/kubify/master/doc/addons.md">addons</a> that comes out of the box
with this template project.</p>

<p>For the technical launch of a cluster <a href="https://github.com/kubernetes-incubator/bootkube/blob/master/README.md">bootkube</a> is used on CoreOS VMs.</p>

<p>The setup is completely handled by a single terraform project, which uses specific terraform modules
handling IaaS related tasks. Recovery is handled by a specific bootstrap etcd deployment
together with the regular bootkube mechanism.</p>

<p>Kubify is designed to be used as a git submodule for a cluster specific project that hosts a
specific cluster&rsquo;s configuration and the selection of a cluster variant (openstack/aws/azure).
Here also the terraform state is stored which enables performing cluster modifications later based
on the same terraform project.</p>

<h4 id="cluster-environment">Cluster Environment</h4>

<h5 id="bastion-and-node-access">Bastion and Node Access</h5>

<p>Remote access to cluster nodes can be restricted by a bastion VM. Using a bastion allows omitting
public access to every cluster node. Node access will automatically use the bastion host.
It is also possible to assign public IP addresses to every node, in this case no bastion host is required.</p>

<h5 id="bootstrapping">Bootstrapping</h5>

<p>All nodes are fully configured by a cloud-init file. Active parts are handled by systemd services.
The kubelet is run by using the kubelet wrapper mechanism provided by CoreOS. Therefore always CoreOS images
are used for the cluster nodes. The kubelet version is controlled by a dedicated file. In case this is
changed the kubelet service is automatically restarted. This can be used to implement version upgrades of
kubelets without requiring reinstallation of nodes.</p>

<p>The cluster is bootstrapped using <a href="https://github.com/kubernetes-incubator/bootkube/blob/master/README.md">bootkube</a>.
Bootstrapping is always done by the first (index 0) master node. Therefore a bootkube service
is configured on master nodes. It automatically starts when an appropriate configuration file is present.
The bootkube configuration is prepared by terraform and propagated to the first master node by a remote
provisioner. This is done exactly once. On subsequent calls to terraform an appropriate <code>auto</code> terraform
configuration file is generated which disables the bootstrap resource in order to avoid repeated
bootstrapping.</p>

<h5 id="recovery">Recovery</h5>

<p>Kubify supports cluster recovery from an etcd backup file. Recovery uses the terraform project
used to setup the cluster by enabling the recovery mode and executing <code>terraform apply</code>, again.
In recovery mode the master nodes and volumes are recreated and the cluster bootstrap is reinitiated
using the etcd backup in order to initialize the bootstrap etcd cluster. This is the only difference
compared to an initial cluster setup.</p>

<h5 id="etcd">ETCD</h5>

<p>The current setup uses a self hosted etcd approach supported by bootkube and the etcd operator.
The etcd is scaled with the master nodes and uses a persistent volume for their persistence.
For bootrapped clusters the etcd operator does not support kubernetes volumes, therefore a
VM volume for master nodes is created and used to back the host path used by the etcd cluster</p>

<h5 id="api-server">API Server</h5>

<p>The API Server can only run on master nodes. It uses the node port 443. This is used to create a load balancer
for this port and the set of master nodes.</p>

<h5 id="ingress">Ingress</h5>

<p>The same mechanism is used to statically provide a load balancer for the nginx ingress controller
for http(s) access. The nginx pods are running on the worker nodes, only.
Here the ports 80 and 443 are used as node ports on the worker nodes.</p>

<p>Basically nginx could also use a load balancer created by a service object, but then it would not be possible to
generate the DNS and load balancer environment in advance using terraform. This could be changed if either the
public IP assigned to the load balancer could be configured by the service object or if there would be a DNS
controller in Kubernetes.  But then the constraint for the IaaS layer is to offer (???) load balancers with dedicated
public IPs. This is, for example, not the case for AWS (???). Always using statically provided load balancers for
the ingress should works for all environments.</p>

<h4 id="rolling-updates-of-nodes">Rolling updates of nodes.</h4>

<p>If the configuration of master or worker nodes require a recreation of VMs, this is done by upating
each node with a separate call to <code>terraform apply</code> one by one. With every successfull execution the update
of the next master/worker node is triggered. This is completely implemented by the terraform configuration files
and by keeping the actual state in a separate json file which can later again be read as a terraform variable file
(auto file). Configuration variables allow to configure the behaviour of node rolling.</p>

<h4 id="setup-a-new-cluster">Setup a new cluster</h4>

<ul>
<li>Create a new git repository representing the desired new cluster
This repository is used to keep track of the used terraform template version, the terraform configuration
and state of the cluster.</li>
</ul>

<pre><code>  mkdir &lt;cluster-name&gt;
  cd &lt;cluster-name&gt;
  git init
  git remote add origin &lt;git repository url&gt;
</code></pre>

<ul>
<li>Prepare the cluster project content</li>
</ul>

<p>Add a <code>.gitignore</code> file</p>

<pre><code>  .terraform/
  terraform/
  gen/
  tmp/
  .sw[opq]
</code></pre>

<ul>
<li>Add the kubify repository as a git submodule with the name <code>k8s</code>.</li>
</ul>

<pre><code>  git submodule add /website/030-architecture/30_kubify/ k8s
  git submodule init
</code></pre>

<ul>
<li>Select the cluster IaaS variant to be used
Create a symbolic link <code>variant</code> pointing to the variant to use. Variants are
stored in folder <code>variants</code> inside the submodule residing in folder <code>k8s</code>.</li>
</ul>

<p>Currently three variants are supported
     - openstack
     - aws
     - azure</p>

<p>For example:</p>

<pre><code>  ln -s k8s/variants/openstack variant
</code></pre>

<p>Starting from terraform 0.10.6 symbolic link handling does not work correctly anymore.
  Here you cannot use the direct variant link anymore. Instead run</p>

<pre><code>  k8s/bin/prepare &lt;variant name&gt;
</code></pre>

<p>to select the variant for your cluster project. If the variant has already been configured earlier, the
  argument can be omitted.
  This script generates a copy of the k8s module and replaces the indirect link <code>variants/current</code>
  by a direct link to the desired variant, instead of using the <code>variant</code> link in the
  cluster project. Whenever a new version of Kubify (this project) is used for the cluster project,
  this copy must be updated by calling <code>prepare</code> again.</p>

<ul>
<li>Add the configuration values for your cluster (<code>terraform.tfvars</code>)</li>
</ul>

<p>For openstack this could look like this:</p>

<pre><code>  os_user_name=&quot;&lt;your user&gt;&quot;
  os_password=&quot;&lt;your password&gt;&quot;
  os_auth_url=&quot;&lt;your keystone auth url&gt;&quot;
  os_tenant_name=&quot;&lt;your tenant name&gt;&quot;
  os_domain_name=&quot;&lt;your openstack domain name&gt;&quot;
  os_region=&quot;&lt;your region&gt;&quot;
  os_fip_pool_name=&quot;&lt;your fip pool name&gt;&quot;

  cluster_name=&quot;&lt;your cluster name&gt;&quot;
  cluster_type=&quot;&lt;your cluster type&gt;&quot;

  # DNS
  dns = {
    dns_type = &quot;route53&quot;
    access_key=&quot;&lt;route53 access key&gt;&quot;
    secret_key=&quot;&lt;route53 secret key&gt;&quot;
    hosted_zone_id=&quot;&lt;route53 hosted zone id&gt;&quot;
    hosted_zone_domain=&quot;&lt;domain&gt;&quot;
  }

  # cluster size
  master = {
    count=3
    flavor_name=&quot;medium_4_8&quot;
  }

  worker = {
    count=3
    flavor_name=&quot;medium_2_4&quot;
  }
</code></pre>

<ul>
<li>Setup the cluster
Now you can call regular terraform commands for the project <code>variant</code></li>
</ul>

<pre><code>  terraform init variant
  terraform plan variant
  terraform apply variant
</code></pre>

<h4 id="helper-commands">Helper commands</h4>

<ul>
<li>Terraform commands
There are shortcuts available including the <code>get</code> step during development:</li>
</ul>

<pre><code>  k8s/bin/plan
  k8s/bin/apply
  k8s/bin/tf &lt;terraform command&gt;
</code></pre>

<p>This command sequence automatically runs the prepare step and the terraform get step, if required.</p>

<ul>
<li>Access to master, worker and bastion nodes</li>
</ul>

<pre><code>  k8s/bin/master [&lt;n&gt; [&lt;shell command to execute on master&gt;]]
  k8s/bin/worker [&lt;n&gt; [&lt;shell command to execute on worker&gt;]]

  k8s/bin/master list   # list all IPs of VMs intended for master nodes
  k8s/bin/worker list   # list all IPs of VMs intended for worker nodes

  k8s/bin/bastion
</code></pre>

<ul>
<li>Access to the api server
The config file for <code>kubectl</code> can be found in <code>gen/assets/auth/kubeconfig</code>.
Or just call

<ul>
<li><code>k8s/bin/k &lt;options&gt;</code>                    # for kubectl</li>
<li><code>k8s/bin/ks &lt;options&gt;</code>                   # for kubectl -n kube-system</li>
<li>`k8s/bin/kurl <url path for rest call>   # for curl <api url>/<restcall></li>
</ul></li>
</ul>

<h4 id="quick-setup">Quick Setup</h4>

<p>Alternatively you can copy the project templates prepared for your IaaS environment of choice:
  - for Openstack: <a href="https://github.com/gardener/kubify-openstack-template.git">https://github.com/gardener/kubify-openstack-template.git</a>
  - for AWS: <a href="https://github.com/gardener/kubify-aws-template.git">https://github.com/gardener/kubify-aws-template.git</a></p>

<p>Afterwards you should set the <code>origin</code> to your upstream git repository.
It is strongly recommended to maintain such a <em>cluster</em> project keeping track
of the actual state of your cluster.</p>

<hr />

<p>Please remember: you should use
a <em>PRIVATE</em> repository, because it contains secrets and access keys
for the cluster AND the selected IaaS environment.</p>

<hr />

<p>Then continue with the configuration steps above.</p>

<p>It uses the same submodule, so don&rsquo;t forget to call</p>

<pre><code>git submodule update --init --recursive
</code></pre>

<h4 id="configuration-settings">Configuration Settings</h4>

<p>First of all there are required settings for every IaaS environment:
  - <a href="https://raw.githubusercontent.com/gardener/kubify/master/doc/openstack.md">Openstack</a>
  - <a href="https://raw.githubusercontent.com/gardener/kubify/master/doc/aws.md">AWS</a>
  - <a href="https://raw.githubusercontent.com/gardener/kubify/master/doc/azure.md">Azure</a></p>

<p>In addition there are various general settings that are independent of the chosen platform variant.
Most of them have defaults that typically don&rsquo;t need to be changed.</p>

<p>The folloing variables are required for every cluster:</p>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|cluster_name|Name of the cluster. Used for DNS entries, the kubernetes cluster and for labelling the IaaS elements|
|cluster_type|Type key of the cluster (for example: <code>seed</code> or <code>infra</code>). It ts used for the DNS entries and labeling the IaaS elements|
|dashboard_creds|The credential file the kubernetes dashboard created by <code>htpasswd</code>. Unfortunately terraform does not support <code>bcrypt</code> up to now|
|master|Settings for master nodes (see below)|
|worker|Settimgs for worker nodes (see below)|
|bastion|Settimgs for bastion VM (see below)|</p>

<p><code>master</code> and <code>worker</code> use the following common structure</p>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|count|Number of nodes (for master this should be an odd number, because it is also used to scale the cluster etcd service|
|flavor_name|Optional: flavor used for the VM|
|image_name|Optional: image used for the VM|
|assign_fips|Optional: Always assign public IP to nodes|
|root_volume_size|Optional: Size in GB of root volume (default: 50)|
|volume_size|Optional: Size in GB of persistent volume for master (default: 20), should not be used for worker|
|update_mode|Optional: Update mode for VMs|
|generation|Optional: explicit node generation count to enforce recreation|</p>

<p>For the <code>bastion</code> settings the following structure is used</p>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|flavor_name|Optional: flavor used for the VM|
|image_name|Optional: image used for the VM|
|user_name|Optional: user name of initial admin user of image|</p>

<p>DNS configuration is done via the input map <code>dns</code>. It contains an entry <code>dns_type</code> to select the desired DNS
provider and additional configuration entries required for that provider.</p>

<p>So far only <code>route53</code> is supported as DNS provider. Therefore dedicated AWS credentials
 with appropriate permissions are required.</p>

<p>Configuration of the <code>route53</code> DNS provider:</p>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|access_key|AWS access key for route53 access|
|secret_key|AWS secret key for route53 access|
|hosted_zone_id|Id of AWS hosted zone to use for the DNS entries|
|hosted_zone_domain|Optional: domain name of hosted zone. Required if no <code>base_domain</code> or <code>domain_name</code> is configured for cluster. It is used to generate a unique domain name for clusters generated with kubify in this domain.|</p>

<p>Etcd can be configured to create backups using the etcd operator. This can also be
configured with the terraform project using the input map variable <code>etcd_backup</code>.
The folowing backup modes are supported:
- <code>s3</code>: AWS S3
- <code>pv</code>: Persistent volume in cluster
The default is <code>pv</code>. An appropriate kubernetes storage class is always created
by the platform specific parts.</p>

<p>The mode is configured with the map entry <code>storage_type</code>. Other entries are used to
configure the selected storage type.</p>

<p>For <code>s3</code> AWS credentials must be configured:</p>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|access_key|AWS access key for S3 access|
|secret_key|AWS secret key for S3 access|</p>

<p>Besides those mandatory settings there are various optional settings.</p>

<h5 id="addons">Addons</h5>

<p>Several <a href="https://raw.githubusercontent.com/gardener/kubify/master/doc/addons.md">addons</a> can be chosen for optional deployment.
For addons <a href="https://github.com/bitnami-labs/helm-crd/blob/master/README.md">helm deployment manifests</a> are supported.
Therefore the standard control plane is extended by the helm controller and tiller deployment.</p>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|addons|map with addon and their configuration settings (see <a href="https://raw.githubusercontent.com/gardener/kubify/master/doc/addons.md">addons</a>)
|deploy_tiller|addons may now use helm manifests. If this is not requited the tiller/helm operator deployment can be disabled. (default: true)|</p>

<h5 id="general-settings">General settings</h5>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|ca_cert_pem|Root certificate to be used for the cluster. By default generated for the dedicated cluster|
|ca_key_pem|Key for the root certificate. Must always be configured together with <code>ca_cert_pem</code>|
|base_domain|Base domain used for the cluster instead of generating it. The cluster name is still prepended|
|domain_name|Domain name of the cluster. Sub domains are created for api, ingress,&hellip;.|
|additional_domains|List of additional domain names used for certificate generation|</p>

<h5 id="node-settings">Node settings</h5>

<p>These are otional settings for all kinds of nodes</p>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|root_certs_file|File containing additional root certificates to be installed on the nodes|
|dns_nameservers|List of DNS servers to configure for the subnets and/or VMs|
|flavor_name|Default flavor for all kinds of VMs|
|subnet_cidr|IP range for node subnet (defaulted by IaaS modules)|</p>

<p>It is possible to specify IaaS specific names (or search pattern for AWS). Additionally
some mappings for preconfigured names come out of the box with this project:</p>

<ul>
<li>ubuntu-16.04</li>
<li>coreos-1520.6.0 (not on Azure)</li>
<li>coreos-1548.3.0 (Azure)</li>
</ul>

<p>Actual settings can be found <a href="https://raw.githubusercontent.com/gardener/kubify/master/modules/vms/versions.tf">here</a>.
With every new release more preconfigured settings are delivered with Kubify.</p>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|use_bastion|Use bastion host to avoid public node IPs if possible (depends on IAAS environment)|
|use_lbaas|For testing purposes switch off load balancers|
|configure_additional_dns|Create DNS entries for <code>additional_domains</code>|</p>

<h5 id="kubernetes-configuration">Kubernetes Configuration</h5>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|oidc_issuer_domain|OIDC configuration for API server|
|oidc_issuer_subdomain|OIDC configuration for API server|
|oidc_client_id|OIDC configuration for API server, default: <code>kube-kubectl</code>|
|oidc_username_claim|OIDC configuration for API server, default: <code>email</code>|
|oidc_groups_claim|OIDC configuration for API server, default: <code>groups</code>|
|service_cidr|Kubenetes cluster ip range (services) (default: 10.241.0.0/17)|
|pod_cidr|Kubenetes pod ip range (default: 10.241.128.0/17)|
|event_ttl|Time to live for events (default: 48h0m0s)|</p>

<h5 id="vm-update">VM update</h5>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|node_update_mode|Standard node update mode (<code>Roll</code>, <code>All</code> or <code>None</code>)|
|update_kubelet|handle kubelet update (default: false)|</p>

<p>Additional node kind specific settings can be set using the <code>master</code> and  <code>worker</code> configuration
variables.</p>

<h5 id="recovery-1">Recovery</h5>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|recover_cluster|Enable cluster <a href="#cluster-recovery">recovery mode</a> if set to `true|
|etcd_backup_file|Local path to the etcd backup file|</p>

<h5 id="component-versions">Component versions</h5>

<p>Versions are coming with the releases of this project. It is possible to override various versions, but
there is no guarantee a selected combination of component versions works flawlessly (and with this terraform script)
Actual versions are defined <a href="https://raw.githubusercontent.com/gardener/kubify/master/modules/versions/defaults.tf">here</a>.</p>

<p>Versions can be configured as member of a map variable <code>versions</code>. The following keys are supported:</p>

<p>|Name|Meaning|
|&ndash;|&ndash;|
|image_name|image used for cluster VMs (master and nodes)|
|bastion_image_name|image used for bastion VMs|
|kubernetes_version|kubernetes version|
|dns_version|DNS version|
|flannel_version|flannel version|
|cni_version|CNI version|
|etcd_version|etcd version|
|etcd_operator_version|etcd operator version|
|bootkube|bootkube image name (default: <code>quay.io/coreos/bootkube</code>)|
|bootkube_version|bootkube version|
|kubernetes_hyperkube|image base name (default: <code>gcr.io/google_containers/hyperkube</code>)|
|kubernetes_hyperkube_patch|image name suffix (default: <code>_coreos.0</code>)|
|nginx_version|nginx version|
|lego_version|lego version|</p>

<h4 id="cluster-recovery">Cluster Recovery</h4>

<p>Store your etcd backup file somewhere in the filesystem and add the following settings to your
<code>terraform.tfvars</code> file.</p>

<pre><code>recover_cluster = &quot;true&quot;
etcd_backup_file= &quot;&lt;your etcd.backup file path&gt;&quot;
</code></pre>

<p>Now just re-run <code>terraform apply variant</code> (or try <code>plan</code> first).</p>

<p>This recreates the master volumes and nodes and then recreates the cluster using the backup as initial
etcd content. All manual changes to your deployment of the standard components will be lost,
because all standard components (not only the control plane) will be updated to the version
configured in the terraform project.</p>

<h4 id="migrating-to-new-versions-of-the-kubify-project">Migrating to new Versions of the Kubify Project</h4>

<p>Every new version of this project comes with a migration script
<a href="https://raw.githubusercontent.com/gardener/kubify/master/migrate.mig"><code>migration.mig</code></a>  that is used by the command
<code>migrate</code>. It is used to adapt terraform state files generated
by former versions of this project before they can be
used with the actual version. With this mechanism it is possible
to change the structure of the terraform project for new
versions without loosing cluster projects based on older
versions. Nevertheless there might still be changes that
cannot be migrated. The migration script then prompts
an information about the latest commit, that can be used
with the actual state version.</p>

<p>For this purpose the state structure used by this project is
versioned (in <code>modules/instance/version.tf</code>). Running the
project generates a file <code>structure_version</code> containing
the actual version. Additionally the version is also
contained in the <code>state.auto.tfvars</code> file.</p>

<p>The migration
of the actual state file to the lastest structure version is done
version by version until the actual version is reached.</p>

<p>The utility command <code>apply</code>, <code>plan</code> and <code>tf</code> implicitly
do the state migration if required. If terraform is called
manually the migration steps have be explicitly done by
using the <code>migrate</code> utility command. It can always be called,
because it checks if an action is required before touching
the state file.</p>

<p>The migration command provides some utility functions
used by the migration script. After defining those functions
it just calls the migration script as regular shell script.
The utility functions are based on the state manipulation
sub commands of the <code>terraform</code> command.</p>






        </div> 
        

      </div>


        
        

        
            
            <div class="howto_tickets">
                <span class="open_github_ticket">
                    <h3 class="open_github_ticket_header"><i class="fa fa-github" aria-hidden="true"></i> Report an issue</h3>
                    See a typo? Have a picture to recommend? Want to edit some words/phrases/sentences?
                    You can simply submit a ticket to request we make the change. If you are github savvy, submit a
                    pull request.
                    
                    
                    
                    <a href="#" onclick="return createIssue('https://github.com/gardener/kubify\//issues/new','https:\/\/github.com\/gardener\/kubify.git','https:\/\/github.com\/gardener\/kubify.git')" target="_blank">Open Github Issue <i class="fa fa-external-link" aria-hidden="true"></i></a>
                    <br>
                </span>
            </div>
        


    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">

      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/website/js/clipboard.min.js?1533730314"></script>
    <script src="/website/js/perfect-scrollbar.min.js?1533730314"></script>
    <script src="/website/js/perfect-scrollbar.jquery.min.js?1533730314"></script>
    <script src="/website/js/jquery.sticky.js?1533730314"></script>
    <script src="/website/js/featherlight.min.js?1533730314"></script>
    <script src="/website/js/html5shiv-printshiv.min.js?1533730314"></script>
    <script src="/website/js/highlight.pack.js?1533730314"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/website/js/modernizr.custom.71422.js?1533730314"></script>
    <script src="/website/js/learn.js?1533730314"></script>
    <script src="/website/js/hugo-learn.js?1533730314"></script>

    <link href="/website/mermaid/mermaid.css?1533730314" type="text/css" rel="stylesheet" />
    <script src="/website/mermaid/mermaid.js?1533730314"></script>
    <script>
        mermaid.initialize({ startOnLoad: true, htmlLables: true });
        function createIssue(issueUrl, page, url) {
            var uri = issueUrl+"?title=Documentation issue on page \""+page+"\"";
            uri = uri+ "&body=\n\n<- DESCRIBE MISSING OR FAULTY DOCUMENTATION HERE->\n\n---\nPage: ["+ page +"]("+
            url+ ")\ndon't remove the link to the page. It's required for the processor"
            var res = encodeURI(uri);
            res +="&labels=area/documentation"
            window.open(res,"issue")
            return false;
        }

        $(document).ready(function() {
            var $window = $(window);
            $window.sr = ScrollReveal({ reset: false});
            $window.sr.reveal('.reveal-fast', { duration: 2000 });
            $window.sr.reveal('.reveal-slow', { duration: 2500 });
            $window.sr.reveal('.reveal-right', { duration: 2000, origin:'right', distance:'300px' });
            $window.sr.reveal('.reveal-left', { duration: 2000, origin:'left', distance:'300px' });

            inlineSVG.init();
        });

    </script>
    
    <script>
    
    
    (function () {
        $("#body-inner a").not(".inline")
            .each(function () {
                if (this.hostname != window.location.hostname && this.href.indexOf("mailto:")===-1) {
                    this.target = '_blank';
                    $(this).addClass("externalLink");
                    if($(this).find("img").length===0) {
                        this.innerHTML += '<i class="fa fa-external-link" aria-hidden="true"></i>';
                    }
                }
            });



    })();

    </script>
  </body>
</html>
